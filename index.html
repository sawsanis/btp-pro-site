<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTP Pro Maroc - Plateforme Professionnelle BTP Marocaine</title>
    
    <!-- CDN Links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #0a5cb8;
            --secondary-color: #ff7710;
            --dark-color: #2d3a4a;
            --light-color: #f8f9fa;
            --text-color: #333333;
            --morocco-red: #c1272d;
            --morocco-green: #006233;
            --morocco-gold: #d4af37;
        }
        
        [data-theme="dark"] {
            --primary-color: #1e88e5;
            --secondary-color: #ff9800;
            --dark-color: #121212;
            --light-color: #1e1e1e;
            --text-color: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            padding-top: 80px;
            transition: all 0.3s ease;
        }
        
        .navbar {
            background-color: var(--light-color) !important;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .nav-link {
            color: var(--text-color) !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-link.active {
            color: var(--primary-color) !important;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .hero-banner {
            background: 
                linear-gradient(135deg, var(--primary-color), var(--secondary-color)),
                url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-blend-mode: overlay;
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
            position: relative;
        }
        
        .section-content {
            display: none;
        }
        
        .section-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .message-alert {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1060;
            display: none;
            min-width: 300px;
        }
        
        .card {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid #dee2e6;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 4rem;
        }
        
        .footer a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        
        .footer a:hover {
            color: white;
        }
        
        [data-theme="dark"] .navbar {
            background-color: var(--dark-color) !important;
            border-bottom: 1px solid #444;
        }
        
        [data-theme="dark"] .card {
            background-color: var(--dark-color);
            border-color: #444;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .global-search-container {
            position: relative;
            width: 700px;
            margin: 0 20px;
        }

        .global-search-container .input-group {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 50px;
            overflow: hidden;
        }

        .global-search-container .form-control {
            border-radius: 50px 0 0 50px;
            padding: 12px 25px;
            border: 2px solid var(--primary-color);
            border-right: none;
            font-size: 1rem;
            width: 100%;
        }

        .global-search-container .btn {
            border-radius: 0 50px 50px 0;
            padding: 12px 30px;
            background: var(--primary-color);
            border: 2px solid var(--primary-color);
            min-width: 120px;
            cursor: pointer;
        }

        .btn {
            cursor: pointer;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .favorite-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: #ff4757;
        }

        /* Messagerie améliorée */
        .messaging-container {
            position: fixed;
            bottom: 80px;
            right: 30px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            border: 1px solid #dee2e6;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message.received {
            background-color: #e9ecef;
            color: var(--text-color);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }

        /* Liste des contacts */
        .contacts-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .contact-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .contact-item:hover {
            background: #f8f9fa;
        }

        .contact-item.active {
            background: var(--primary-color);
            color: white;
        }

        /* Section construction */
        .construction-section {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin: 2rem 0;
        }

        .construction-icon {
            font-size: 4rem;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
        }

        /* Pub Adsense */
        .adsense-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .adsense-placeholder {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Admin */
        .admin-stats-card {
            transition: transform 0.3s ease;
        }

        .admin-stats-card:hover {
            transform: translateY(-5px);
        }

        .admin-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Newsletter */
        .newsletter-template {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .newsletter-template:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .newsletter-template.active {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        /* Forum */
        .forum-category {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .forum-topic {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
            transition: background 0.2s ease;
        }

        .forum-topic:hover {
            background: #f8f9fa;
        }

        .topic-badge {
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .premium-card {
            border: 2px solid var(--primary-color);
            transform: scale(1.05);
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Upload photos */
        .photo-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-container:hover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }

        .photo-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Premium badge */
        .premium-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Section Mon Compte */
        .account-sidebar {
            background: var(--light-color);
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .account-sidebar .nav-link {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            color: var(--text-color);
            border-radius: 0;
        }

        .account-sidebar .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-bottom: 1px solid var(--primary-color);
        }

        .account-sidebar .nav-link:last-child {
            border-bottom: none;
        }

        .account-content {
            background: var(--light-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .announce-status-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d1edff;
            color: #004085;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-paused {
            background: #e2e3e5;
            color: #383d41;
        }

        .account-section {
            display: none;
        }

        .account-section.active {
            display: block;
        }

        /* Logo en construction */
        .construction-logo {
            max-width: 200px;
            margin: 0 auto 2rem;
            display: block;
        }

        /* Optimisation de la barre de recherche */
        .search-container-mobile {
            display: none;
            margin: 10px 0;
        }

        /* Boutons admin */
        .admin-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .card:hover .admin-actions {
            display: block;
        }

        .admin-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* Classes utilitaires Maroc */
        .text-morocco-red { color: var(--morocco-red); }
        .text-morocco-green { color: var(--morocco-green); }
        .bg-morocco-green { background-color: var(--morocco-green); }
        .border-morocco-gold { border-color: var(--morocco-gold); }

        /* Backup styles */
        .backup-history-item {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .backup-stats {
            font-size: 0.9rem;
            color: #6c757d;
        }

        @media (max-width: 1200px) {
            .global-search-container {
                width: 500px;
            }
        }

        @media (max-width: 992px) {
            .global-search-container {
                width: 400px;
                margin: 10px 0;
            }
        }

        @media (max-width: 768px) {
            .hero-banner {
                padding: 60px 0;
            }
            
            .hero-banner h1 {
                font-size: 2rem;
            }
            
            .global-search-container {
                display: none;
            }

            .search-container-mobile {
                display: block;
            }

            .messaging-container {
                width: 95vw;
                height: 70vh;
                bottom: 20px;
                right: 2.5vw;
            }

            .premium-card {
                transform: none;
                margin-bottom: 1rem;
            }

            .navbar-nav {
                text-align: center;
            }

            .nav-link {
                padding: 10px 0;
            }

            .account-sidebar {
                margin-bottom: 2rem;
            }

            .admin-actions {
                position: static;
                display: block;
                margin-top: 10px;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Overlay de chargement -->
    <div class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Chargement...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" onclick="goToSection('home')">
                <i class="fas fa-hard-hat me-2"></i>BTP Pro <span>🇲🇦</span>
            </a>
            
            <!-- Barre de recherche mobile -->
            <div class="search-container-mobile d-lg-none">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="🔍 Rechercher..." id="globalSearchMobile">
                    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Barre de recherche desktop -->
            <div class="global-search-container d-none d-lg-block">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="🔍 Rechercher des matériaux, emplois, professionnels..." id="globalSearch">
                    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
                        <i class="fas fa-search me-2"></i>Rechercher
                    </button>
                </div>
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="goToSection('home')">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('marketplace')">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('realestate')">Immobilier</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('jobs')">Emploi</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('freelancers')">Freelancers</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('professionals')">Professionnels</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('forum')">Forum</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('ai')">Assistant IA</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('premium')">Premium</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('favorites')">Favoris</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToPublish()"><i class="fas fa-plus-circle me-1"></i>Publier</a></li>
                    <li class="nav-item d-none" id="admin-nav-item"><a class="nav-link" href="#" onclick="goToSection('admin')">Admin</a></li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <!-- Bouton Messagerie -->
                    <button class="btn btn-outline-primary me-2 position-relative" type="button" onclick="toggleMessaging()" id="messagingBtn">
                        <i class="fas fa-comments"></i>
                    </button>

                    <div class="dropdown me-3">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-palette"></i> Thème
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeTheme('light')">Clair</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeTheme('dark')">Sombre</a></li>
                        </ul>
                    </div>
                    
                    <div class="d-flex" id="auth-buttons">
                        <button class="btn btn-outline-primary me-2" type="button" onclick="showLoginModal()">Connexion</button>
                        <button class="btn btn-primary" type="button" onclick="showRegisterModal()">Inscription</button>
                    </div>

                    <div class="d-flex align-items-center d-none" id="user-menu">
                        <div class="user-avatar me-2 position-relative">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                <span id="user-initials">MA</span>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="user-name">Utilisateur</span>
                                <span id="admin-badge" class="admin-badge d-none">ADMIN</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="goToSection('my_account')"><i class="fas fa-user me-2"></i>Mon Compte</a></li>
                                <li><a class="dropdown-item" href="#" onclick="goToSection('favorites')"><i class="fas fa-heart me-2"></i>Mes favoris</a></li>
                                <li id="admin-menu-item" class="d-none"><a class="dropdown-item" href="#" onclick="goToSection('admin')"><i class="fas fa-cog me-2"></i>Administration</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Déconnexion</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Message Alert -->
    <div class="alert alert-success message-alert">
        <i class="fas fa-check-circle me-2"></i> <span class="alert-message">Opération réussie!</span>
    </div>

    <!-- Messagerie améliorée -->
    <div class="messaging-container" id="messagingContainer">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-comments me-2"></i>Messagerie
            </h6>
            <button class="btn btn-sm btn-light" type="button" onclick="toggleMessaging()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Liste des contacts -->
        <div class="p-3 border-bottom">
            <h6 class="mb-2">Contacts</h6>
            <div class="contacts-list" id="contactsList">
                <!-- Contacts chargés dynamiquement -->
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                Sélectionnez un contact pour commencer à discuter
            </div>
        </div>
        <div class="chat-input">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Tapez votre message..." id="messageInput" disabled>
                <button class="btn btn-primary" type="button" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Connexion -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Connexion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required placeholder="votre@email.com">
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="loginPassword" required placeholder="Votre mot de passe">
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="handleLogin()">
                            <i class="fas fa-sign-in-alt me-2"></i>Se connecter
                        </button>
                    </form>
                    <hr>
                    <div class="text-center">
                        <p class="mb-2">Vous n'avez pas de compte ?</p>
                        <button type="button" class="btn btn-outline-primary" onclick="switchToRegister()">
                            Créer un compte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'Inscription -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Inscription
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registerPrenom" class="form-label">Prénom</label>
                                <input type="text" class="form-control" id="registerPrenom" required placeholder="Votre prénom">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registerNom" class="form-label">Nom</label>
                                <input type="text" class="form-control" id="registerNom" required placeholder="Votre nom">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required 
                                   placeholder="votre@email.com" onblur="validateEmailField(this)">
                            <div class="invalid-feedback" id="emailError">
                                Format d'email invalide
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPhone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="registerPhone" placeholder="+212 XX XX XX XX">
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="registerPassword" required placeholder="Minimum 6 caractères">
                        </div>
                        <div class="mb-3">
                            <label for="registerConfirmPassword" class="form-label">Confirmer le mot de passe</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" required placeholder="Confirmez votre mot de passe">
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="handleRegister()">
                            <i class="fas fa-user-plus me-2"></i>Créer mon compte
                        </button>
                    </form>
                    <hr>
                    <div class="text-center">
                        <p class="mb-2">Vous avez déjà un compte ?</p>
                        <button type="button" class="btn btn-outline-primary" onclick="switchToLogin()">
                            Se connecter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Paramètres Sauvegarde -->
    <div class="modal fade" id="backupSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2"></i>Paramètres de Sauvegarde Automatique
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="backupSettingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Activer la sauvegarde automatique</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled">
                                        <label class="form-check-label" for="backupEnabled">Sauvegarde automatique activée</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Fréquence d'envoi</label>
                                    <select class="form-select" id="backupFrequency">
                                        <option value="weekly">Hebdomadaire (chaque lundi)</option>
                                        <option value="monthly">Mensuelle (1er du mois)</option>
                                        <option value="daily">Quotidienne</option>
                                        <option value="manual">Manuelle uniquement</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="backupEmail" class="form-label">Email de réception</label>
                                    <input type="email" class="form-control" id="backupEmail" 
                                           placeholder="admin@btp.ma" required>
                                    <div class="form-text">L'adresse email où seront envoyées les sauvegardes</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeCoordinates" checked>
                                        <label class="form-check-label" for="includeCoordinates">
                                            Inclure les coordonnées complètes
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeVisits" checked>
                                        <label class="form-check-label" for="includeVisits">
                                            Inclure les statistiques de visites
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Prochaine sauvegarde automatique</label>
                            <div class="alert alert-info" id="nextBackupInfo">
                                Calcul en cours...
                            </div>
                        </div>
                        
                        <!-- Historique des sauvegardes -->
                        <div class="mb-3">
                            <label class="form-label">Historique des sauvegardes</label>
                            <div id="backupHistoryList" class="backup-history-container">
                                <!-- Historique chargé dynamiquement -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="saveBackupSettings()">
                        <i class="fas fa-save me-2"></i>Enregistrer les paramètres
                    </button>
                    <button type="button" class="btn btn-success" onclick="createManualBackup()">
                        <i class="fas fa-download me-2"></i>Sauvegarder maintenant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <main class="container main-content">
        
        <!-- SECTION ACCUEIL -->
        <section id="home-section" class="section-content active">
            <div class="hero-banner">
                <div class="container">
                    <h1 class="display-3 fw-bold mb-4">BTP Pro <span>🇲🇦</span></h1>
                    <p class="lead mb-4">La plateforme de référence des professionnels du BTP marocain</p>
                    
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <button class="btn btn-light btn-lg" type="button" onclick="goToSection('marketplace')">
                            <i class="fas fa-shopping-cart me-2"></i>Découvrir la Marketplace
                        </button>
                        <button class="btn btn-outline-light btn-lg" type="button" onclick="goToSection('jobs')">
                            <i class="fas fa-briefcase me-2"></i>Voir les offres d'emploi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Services -->
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Nos Services au Maroc</h2>
                <div class="row g-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('marketplace')">
                            <div class="card-body">
                                <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Marketplace BTP</h5>
                                <p class="text-muted">Matériaux, équipements et fournitures</p>
                                <button class="btn btn-outline-primary btn-sm mt-2" type="button" onclick="goToSection('marketplace')">Accéder</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('realestate')">
                            <div class="card-body">
                                <i class="fas fa-home fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Immobilier</h5>
                                <p class="text-muted">Biens, terrains et projets</p>
                                <button class="btn btn-outline-success btn-sm mt-2" type="button" onclick="goToSection('realestate')">Explorer</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('jobs')">
                            <div class="card-body">
                                <i class="fas fa-briefcase fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Emploi & Carrière</h5>
                                <p class="text-muted">Offres d'emploi et recrutement</p>
                                <button class="btn btn-outline-warning btn-sm mt-2" type="button" onclick="goToSection('jobs')">Voir les offres</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('freelancers')">
                            <div class="card-body">
                                <i class="fas fa-palette fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Freelancers</h5>
                                <p class="text-muted">Talents créatifs et techniques</p>
                                <button class="btn btn-outline-info btn-sm mt-2" type="button" onclick="goToSection('freelancers')">Découvrir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ déplacée ici -->
            <div class="container my-5">
                <h2 class="text-center mb-5">Foire Aux Questions</h2>
                
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                Comment publier une annonce ?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Cliquez sur "Publier" dans le menu, choisissez le type d'annonce et remplissez le formulaire. Vos annonces seront visibles après modération.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                Comment contacter un professionnel ?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Rendez-vous dans la section "Professionnels", trouvez l'artisan qui vous intéresse et cliquez sur "Contacter". Vous pourrez ensuite discuter via notre messagerie sécurisée.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                Comment devenir membre Premium ?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Rendez-vous dans la section "Premium" et choisissez l'abonnement qui vous convient. Les avantages Premium incluent la mise en avant de vos annonces et des statistiques détaillées.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pub Adsense -->
            <div class="adsense-container">
                <div class="adsense-placeholder">
                    <i class="fas fa-ad fa-3x mb-3"></i>
                    <h5>Espace Publicitaire BTP</h5>
                    <p>Votre annonce pour les professionnels du bâtiment</p>
                    <small>Code Adsense à intégrer depuis le panel admin</small>
                </div>
            </div>
        </section>

        <!-- SECTION MARKETPLACE -->
        <section id="marketplace-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Marketplace BTP</h2>
                    <button class="btn btn-primary" type="button" onclick="checkAuthAndGo('publish', 'marketplace')">
                        <i class="fas fa-plus me-2"></i>Publier un produit
                    </button>
                </div>
                
                <!-- Filtres et recherche -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceCategoryFilter" onchange="filterMarketplace()">
                            <option value="">Toutes les catégories</option>
                            <!-- Catégories chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceCityFilter" onchange="filterMarketplace()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceSort" onchange="filterMarketplace()">
                            <option value="newest">Plus récent</option>
                            <option value="price_asc">Prix croissant</option>
                            <option value="price_desc">Prix décroissant</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="marketplace-container">
                    <!-- Produits chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="marketplace-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION IMMOBILIER -->
        <section id="realestate-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Immobilier au Maroc</h2>
                    <button class="btn btn-success" type="button" onclick="checkAuthAndGo('publish', 'immobilier')">
                        <i class="fas fa-plus me-2"></i>Publier une annonce
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="realestateTypeFilter" onchange="filterRealEstate()">
                            <option value="">Tous les types</option>
                            <option value="villa">Villa</option>
                            <option value="appartement">Appartement</option>
                            <option value="terrain">Terrain</option>
                            <option value="local">Local commercial</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestateCityFilter" onchange="filterRealEstate()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestatePriceFilter" onchange="filterRealEstate()">
                            <option value="">Tous les prix</option>
                            <option value="0-500000">Moins de 500K MAD</option>
                            <option value="500000-1000000">500K - 1M MAD</option>
                            <option value="1000000-2000000">1M - 2M MAD</option>
                            <option value="2000000+">Plus de 2M MAD</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestateSort" onchange="filterRealEstate()">
                            <option value="newest">Plus récent</option>
                            <option value="price_asc">Prix croissant</option>
                            <option value="price_desc">Prix décroissant</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="realestate-container">
                    <!-- Biens chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="realestate-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION EMPLOI -->
        <section id="jobs-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Emploi BTP</h2>
                    <button class="btn btn-warning" type="button" onclick="checkAuthAndGo('publish', 'emploi')">
                        <i class="fas fa-plus me-2"></i>Publier une offre
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="jobTypeFilter" onchange="filterJobs()">
                            <option value="">Tous les contrats</option>
                            <option value="cdi">CDI</option>
                            <option value="cdd">CDD</option>
                            <option value="freelance">Freelance</option>
                            <option value="stage">Stage</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobCityFilter" onchange="filterJobs()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobExperienceFilter" onchange="filterJobs()">
                            <option value="">Toutes expériences</option>
                            <option value="0-2">0-2 ans</option>
                            <option value="2-5">2-5 ans</option>
                            <option value="5-10">5-10 ans</option>
                            <option value="10+">10+ ans</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobSort" onchange="filterJobs()">
                            <option value="newest">Plus récent</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="jobs-container">
                    <!-- Offres chargées dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="jobs-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION FREELANCERS -->
        <section id="freelancers-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Freelancers BTP</h2>
                    <button class="btn btn-info" type="button" onclick="checkAuthAndGo('publish', 'freelance')">
                        <i class="fas fa-plus me-2"></i>Proposer mes services
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerSpecialtyFilter" onchange="filterFreelancers()">
                            <option value="">Toutes les spécialités</option>
                            <option value="infographie">Infographie 3D</option>
                            <option value="photographie">Photographie</option>
                            <option value="dessin">Dessin technique</option>
                            <option value="conception">Conception</option>
                            <option value="architecture">Architecture</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerCityFilter" onchange="filterFreelancers()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerSort" onchange="filterFreelancers()">
                            <option value="newest">Plus récent</option>
                            <option value="rating">Meilleures notes</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="freelancers-container">
                    <!-- Freelancers chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="freelancers-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION PROFESSIONNELS -->
        <section id="professionals-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <h2 class="mb-0">Annuaire des Professionnels BTP</h2>
                    <button class="btn btn-primary" type="button" onclick="showProfessionalModal()">
                        <i class="fas fa-user-plus me-2"></i>Devenir Professionnel
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="filterSpecialty" onchange="filterProfessionals()">
                            <option value="">Toutes les spécialités</option>
                            <option value="maçonnerie">Maçonnerie</option>
                            <option value="electricite">Électricité</option>
                            <option value="plomberie">Plomberie</option>
                            <option value="charpente">Charpente</option>
                            <option value="revetement">Revêtement</option>
                            <option value="peinture">Peinture</option>
                            <option value="etancheite">Étanchéité</option>
                            <option value="menuiserie">Menuiserie</option>
                            <option value="lustrerie">Lustrerie</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterCity" onchange="filterProfessionals()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterExperience" onchange="filterProfessionals()">
                            <option value="">Toutes expériences</option>
                            <option value="5">5+ ans</option>
                            <option value="10">10+ ans</option>
                            <option value="15">15+ ans</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="professionals-container">
                    <!-- Professionnels chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="professionals-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION FORUM -->
        <section id="forum-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Forum BTP</h2>
                    <button class="btn btn-primary" onclick="showForumCreate()">
                        <i class="fas fa-plus me-2"></i>Nouveau sujet
                    </button>
                </div>

                <!-- Catégories du forum -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Catégories</h6>
                            </div>
                            <div class="list-group list-group-flush">
                                <a class="list-group-item list-group-item-action active" onclick="filterForum('all')">
                                    Tous les sujets
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('technique')">
                                    Questions techniques
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('materiaux')">
                                    Matériaux & Fournitures
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('reglementation')">
                                    Réglementation & Normes
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('chantier')">
                                    Gestion de chantier
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <div class="card">
                            <div class="card-header">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Rechercher dans le forum..." id="forumSearch">
                                    <button class="btn btn-primary" onclick="searchForum()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="forum-topics-container">
                                    <!-- Sujets chargés dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION CRÉATION DE SUJET FORUM -->
        <section id="forum-create-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Créer un nouveau sujet</h2>
                    <button class="btn btn-outline-primary" onclick="goToSection('forum')">
                        <i class="fas fa-arrow-left me-2"></i>Retour au forum
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form id="forumTopicForm" onsubmit="createForumTopic(event)">
                            <div class="mb-3">
                                <label class="form-label">Titre du sujet *</label>
                                <input type="text" class="form-control" id="forumTopicTitle" required placeholder="Donnez un titre clair à votre sujet">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Catégorie *</label>
                                <select class="form-select" id="forumTopicCategory" required>
                                    <option value="">Choisir une catégorie</option>
                                    <option value="technique">Questions techniques</option>
                                    <option value="materiaux">Matériaux & Fournitures</option>
                                    <option value="reglementation">Réglementation & Normes</option>
                                    <option value="chantier">Gestion de chantier</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Contenu du message *</label>
                                <textarea class="form-control" id="forumTopicContent" rows="8" required placeholder="Décrivez votre question ou sujet de discussion en détail..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>Publier le sujet
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="goToSection('forum')">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION ASSISTANT IA -->
        <section id="ai-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="construction-section">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iMjAiIGZpbGw9IiNGOUY5RjkiLz4KPHBhdGggZD0iTTEwMCA1MEM5My4zNzIgNTAgODcuNDg0OSA1Mi44NDA3IDgzLjQzMTQgNTcuNDMxNEM3OS4zNzc5IDYyLjAyMjEgNzcuNSA2Ny45OTI5IDc3LjUgNzQuMzc1Qzc3LjUgODAuNzU3MSA3OS4zNzc5IDg2LjcyNzkgODMuNDMxNCA5MS4zMTg2Qzg3LjQ4NDkgOTUuOTA5MyA5My4zNzIgOTguNzUgMTAwIDk4Ljc1QzEwNi42MjggOTguNzUgMTEyLjUxNSA5NS45MDkzIDExNi41NjkgOTEuMzE4NkMxMjAuNjIyIDg2LjcyNzkgMTIyLjUgODAuNzU3MSAxMjIuNSA3NC4zNzVDMTIyLjUgNjcuOTkyOSAxMjAuNjIyIDYyLjAyMjEgMTE2LjU2OSA1Ny40MzE0QzExMi41MTUgNTIuODQwNyAxMDYuNjI4IDUwIDEwMCA1MFoiIGZpbGw9IiNGRjc3MTAiLz4KPHBhdGggZD0iTTEwMCA1MEM5My4zNzIgNTAgODcuNDg0OSA1Mi44NDA3IDgzLjQzMTQgNTcuNDMxNEM3OS4zNzc5IDYyLjAyMjEgNzcuNSA2Ny45OTI5IDc3LjUgNzQuMzc1Qzc3LjUgODAuNzU3MSA3OS4zNzc5IDg2LjcyNzkgODMuNDMxNCA5MS4zMTg2Qzg3LjQ4NDkgOTUuOTA5MyA5My4zNzIgOTguNzUgMTAwIDk4Ljc1QzEwNi42MjggOTguNzUgMTEyLjUxNSA5NS45MDkzIDExNi41NjkgOTEuMzE4NkMxMjAuNjIyIDg2LjcyNzkgMTIyLjUgODAuNzU3MSAxMjIuNSA3NC4zNzVDMTIyLjUgNjcuOTkyOSAxMjAuNjIyIDYyLjAyMjEgMTE2LjU2OSA1Ny40MzE0QzExMi41MTUgNTIuODQwNyAxMDYuNjI4IDUwIDEwMCA1MFoiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Ik03Ny41IDc0LjM3NUgxMjIuNSIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEwMCA1MFYyNSIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEwMCA5OC43NVYxMjUiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Ik03Ny41IDc0LjM3NUg1MCIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEyMi41IDc0LjM3NUgxNTAiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTY1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMkQ0QTRBIj5FTiBDT05TVFJVQ1RJT048L3RleHQ+Cjwvc3ZnPgo=" alt="En construction" class="construction-logo">
                    <h3>Assistant IA en construction</h3>
                    <p class="lead mb-4">Notre assistant IA spécialisé BTP arrive prochainement !</p>
                    <p class="text-muted mb-4">Nous développons une intelligence artificielle capable de vous conseiller sur vos projets de construction, calculs de matériaux, et estimations de coûts.</p>
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-calculator fa-2x text-primary mb-3"></i>
                                    <h5>Calculs techniques</h5>
                                    <p class="text-muted">Estimation des matériaux et coûts</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-lightbulb fa-2x text-warning mb-3"></i>
                                    <h5>Conseils experts</h5>
                                    <p class="text-muted">Recommandations personnalisées</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION PREMIUM -->
        <section id="premium-section" class="section-content">
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Avantages Premium</h2>
                
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Basique</h5>
                                <p class="card-text display-6 fw-bold text-primary">Gratuit</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ 3 annonces actives</li>
                                    <li>✅ 5 photos par annonce</li>
                                    <li>✅ Support standard</li>
                                    <li>❌ Statistiques basiques</li>
                                    <li>❌ Mise en avant</li>
                                    <li>❌ Messagerie avancée</li>
                                </ul>
                                <button class="btn btn-outline-primary" type="button" onclick="selectSubscription('Basique')">Choisir</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-primary premium-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Pro</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text display-6 fw-bold text-primary">49 MAD/mois</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ Annonces illimitées</li>
                                    <li>✅ 20 photos HD par annonce</li>
                                    <li>✅ Support prioritaire</li>
                                    <li>✅ Statistiques détaillées</li>
                                    <li>✅ Mise en avant 1 annonce</li>
                                    <li>✅ Messagerie illimitée</li>
                                </ul>
                                <button class="btn btn-primary" type="button" onclick="selectSubscription('Pro')">Choisir</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Entreprise</h5>
                                <p class="card-text display-6 fw-bold text-primary">149 MAD/mois</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ Tous les avantages Pro</li>
                                    <li>✅ Multi-utilisateurs</li>
                                    <li>✅ API d'intégration</li>
                                    <li>✅ Formation incluse</li>
                                    <li>✅ Mise en avant illimitée</li>
                                    <li>✅ Certificat vérifié</li>
                                </ul>
                                <button class="btn btn-outline-primary" type="button" onclick="selectSubscription('Entreprise')">Choisir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avantages Premium détaillés -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Pourquoi passer Premium ?</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-chart-line text-primary me-2"></i>Statistiques avancées</h6>
                                        <p class="text-muted">Suivez les performances de vos annonces avec des données détaillées.</p>
                                        
                                        <h6><i class="fas fa-star text-warning me-2"></i>Mise en avant</h6>
                                        <p class="text-muted">Vos annonces apparaissent en tête des résultats de recherche.</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-bolt text-success me-2"></i>Support prioritaire</h6>
                                        <p class="text-muted">Réponses rapides et assistance dédiée pour vos questions.</p>
                                        
                                        <h6><i class="fas fa-shield-alt text-danger me-2"></i>Certification</h6>
                                        <p class="text-muted">Badge vérifié qui renforce la confiance de vos clients.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION FAVORIS -->
        <section id="favorites-section" class="section-content">
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Mes Favoris</h2>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                <h4>Vos favoris apparaîtront ici</h4>
                                <p class="text-muted">Ajoutez des éléments en cliquant sur le cœur</p>
                                <button class="btn btn-primary mt-3" onclick="goToSection('marketplace')">
                                    <i class="fas fa-shopping-cart me-2"></i>Parcourir la Marketplace
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION PUBLICATION -->
        <section id="publish-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0" id="publish-title">Publier une annonce</h2>
                    <button class="btn btn-outline-success" type="button" onclick="showNewAnnounceForm()" id="new-announce-btn" style="display: none;">
                        <i class="fas fa-plus me-2"></i>Nouvelle annonce
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="list-group">
                            <a class="list-group-item list-group-item-action active" onclick="showPublishForm('marketplace')">
                                <i class="fas fa-shopping-cart me-2"></i>Marketplace
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('immobilier')">
                                <i class="fas fa-home me-2"></i>Immobilier
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('emploi')">
                                <i class="fas fa-briefcase me-2"></i>Offre d'emploi
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('freelance')">
                                <i class="fas fa-palette me-2"></i>Service Freelance
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <!-- Formulaire Marketplace -->
                        <div id="marketplace-form" class="publish-form">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Nouveau produit Marketplace</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishMarketplace(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre du produit *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Ciment CPJ45 50kg">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Catégorie *</label>
                                                <select class="form-select" name="category" required id="marketplaceCategorySelect">
                                                    <!-- Catégories chargées dynamiquement -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Prix (MAD) *</label>
                                                <input type="number" class="form-control" name="price" required placeholder="Ex: 85">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Unité</label>
                                                <select class="form-select" name="unit">
                                                    <option value="sac">Sac</option>
                                                    <option value="m2">m²</option>
                                                    <option value="m3">m³</option>
                                                    <option value="unite">Unité</option>
                                                    <option value="lot">Lot</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <select class="form-select" name="city" required>
                                                    <option value="">Choisir une ville</option>
                                                    <option value="casablanca">Casablanca</option>
                                                    <option value="rabat">Rabat</option>
                                                    <option value="marrakech">Marrakech</option>
                                                    <option value="fes">Fès</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description détaillée *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez votre produit..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Photos (max 5)</label>
                                            <div class="photo-upload-container" onclick="document.getElementById('marketplacePhotos').click()">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                                <h5>Cliquez pour ajouter des photos</h5>
                                                <p class="text-muted">Glissez-déposez ou cliquez pour sélectionner</p>
                                                <small class="text-muted">Maximum 5 photos, 2MB par photo</small>
                                            </div>
                                            <input type="file" id="marketplacePhotos" multiple accept="image/*" style="display: none" onchange="handlePhotoUpload(this, 'marketplace')">
                                            <div class="photo-preview" id="marketplacePhotoPreview"></div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'annonce
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Immobilier -->
                        <div id="immobilier-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-home me-2"></i>Nouvelle annonce Immobilier</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishRealEstate(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre de l'annonce *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Villa Moderne 220m² - Marrakech">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Type de bien *</label>
                                                <select class="form-select" name="type" required>
                                                    <option value="">Choisir un type</option>
                                                    <option value="villa">Villa</option>
                                                    <option value="appartement">Appartement</option>
                                                    <option value="terrain">Terrain</option>
                                                    <option value="local">Local commercial</option>
                                                    <option value="bureau">Bureau</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Prix (MAD) *</label>
                                                <input type="number" class="form-control" name="price" required placeholder="Ex: 2800000">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Surface (m²)</label>
                                                <input type="number" class="form-control" name="surface" placeholder="Ex: 220">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Nombre de pièces</label>
                                                <input type="number" class="form-control" name="rooms" placeholder="Ex: 4">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Adresse *</label>
                                            <input type="text" class="form-control" name="address" required placeholder="Ex: Gueliz, Marrakech">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description détaillée *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez votre bien..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Photos (max 5)</label>
                                            <div class="photo-upload-container" onclick="document.getElementById('realestatePhotos').click()">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                                <h5>Cliquez pour ajouter des photos</h5>
                                                <p class="text-muted">Glissez-déposez ou cliquez pour sélectionner</p>
                                                <small class="text-muted">Maximum 5 photos, 2MB par photo</small>
                                            </div>
                                            <input type="file" id="realestatePhotos" multiple accept="image/*" style="display: none" onchange="handlePhotoUpload(this, 'realestate')">
                                            <div class="photo-preview" id="realestatePhotoPreview"></div>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'annonce
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Emploi -->
                        <div id="emploi-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Nouvelle offre d'emploi</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishJob(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Poste *</label>
                                                <input type="text" class="form-control" name="poste" required placeholder="Ex: Chef de Chantier BTP">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Type de contrat *</label>
                                                <select class="form-select" name="contrat" required>
                                                    <option value="">Choisir un contrat</option>
                                                    <option value="cdi">CDI</option>
                                                    <option value="cdd">CDD</option>
                                                    <option value="freelance">Freelance</option>
                                                    <option value="stage">Stage</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Salaire *</label>
                                                <input type="text" class="form-control" name="salaire" required placeholder="Ex: 15 000 - 18 000 MAD/mois">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <input type="text" class="form-control" name="ville" required placeholder="Ex: Casablanca">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Expérience requise</label>
                                                <input type="text" class="form-control" name="experience" placeholder="Ex: 5+ ans">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description du poste *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez le poste et les missions..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'offre
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Freelance -->
                        <div id="freelance-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Nouveau service Freelance</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishFreelance(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre du service *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Infographiste 3D BTP">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Spécialité *</label>
                                                <select class="form-select" name="specialty" required>
                                                    <option value="">Choisir une spécialité</option>
                                                    <option value="infographie">Infographie 3D</option>
                                                    <option value="photographie">Photographie</option>
                                                    <option value="dessin">Dessin technique</option>
                                                    <option value="conception">Conception</option>
                                                    <option value="architecture">Architecture</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Tarif (MAD)</label>
                                                <input type="text" class="form-control" name="tarif" placeholder="Ex: 500-1000 MAD/jour">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <input type="text" class="form-control" name="ville" required placeholder="Ex: Casablanca">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Expérience</label>
                                                <input type="text" class="form-control" name="experience" placeholder="Ex: 3+ ans">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description du service *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez vos compétences et services..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Portfolio/Lien</label>
                                            <input type="url" class="form-control" name="portfolio" placeholder="Ex: https://votre-portfolio.com">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <button type="submit" class="btn btn-info">
                                            <i class="fas fa-paper-plane me-2"></i>Publier le service
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION ADMINISTRATION -->
        <section id="admin-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Administration BTP Pro
                            </h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" type="button" onclick="goToSection('home')">
                                    <i class="fas fa-arrow-left me-2"></i>Retour
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                <h3 id="stats-users">0</h3>
                                <p class="text-muted mb-0">Utilisateurs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-shopping-cart fa-2x text-success mb-2"></i>
                                <h3 id="stats-marketplace">0</h3>
                                <p class="text-muted mb-0">Produits</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-home fa-2x text-warning mb-2"></i>
                                <h3 id="stats-realestate">0</h3>
                                <p class="text-muted mb-0">Biens immo</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-briefcase fa-2x text-info mb-2"></i>
                                <h3 id="stats-jobs">0</h3>
                                <p class="text-muted mb-0">Offres emploi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gestion des Utilisateurs et Sauvegarde -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            Gestion des Utilisateurs et Sauvegarde
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="downloadUsersBackup()">
                                <i class="fas fa-download me-1"></i>Télécharger Backup
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showBackupSettings()">
                                <i class="fas fa-cog me-1"></i>Paramètres
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Statistiques utilisateurs -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-primary" id="stats-total-users">0</h4>
                                        <p class="text-muted mb-0">Total Utilisateurs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-success" id="stats-active-users">0</h4>
                                        <p class="text-muted mb-0">Utilisateurs Actifs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning" id="stats-premium-users">0</h4>
                                        <p class="text-muted mb-0">Abonnés Premium</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info" id="stats-total-visits">0</h4>
                                        <p class="text-muted mb-0">Visites Total</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tableau des utilisateurs avec statistiques de visites -->
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Utilisateur</th>
                                        <th>Coordonnées</th>
                                        <th>Statut</th>
                                        <th>Inscription</th>
                                        <th>Dernière visite</th>
                                        <th>Nombre de visites</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Utilisateurs chargés dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gestion des annonces anciennes -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Gestion des Annonces Anciennes (+1 mois)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Auteur</th>
                                        <th>Date de création</th>
                                        <th>Âge</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="old-announces-table-body">
                                    <!-- Annonces anciennes chargées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gestion Adsense -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-ad me-2"></i>
                            Gestion des Publicités Adsense
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="adsense-slots-container">
                            <!-- Emplacements Adsense chargés dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Gestion Newsletter -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-newspaper me-2"></i>
                            Newsletter Automatisée
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Sélectionnez un modèle</label>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('maintenance')">
                                <h6>Maintenance du site</h6>
                                <p class="small text-muted mb-0">Informe les utilisateurs d'une maintenance planifiée</p>
                            </div>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('nouveautes')">
                                <h6>Nouvelles fonctionnalités</h6>
                                <p class="small text-muted mb-0">Présente les nouvelles fonctionnalités du site</p>
                            </div>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('promotions')">
                                <h6>Promotions spéciales</h6>
                                <p class="small text-muted mb-0">Annonce les promotions et offres spéciales</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contenu du message</label>
                            <textarea class="form-control" rows="4" id="newsletterContent" placeholder="Contenu de votre newsletter..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" onclick="sendNewsletter()">
                                    <i class="fas fa-paper-plane me-2"></i>Envoyer maintenant
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100" onclick="scheduleNewsletter()">
                                    <i class="fas fa-clock me-2"></i>Programmer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modération des annonces -->
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks me-2"></i>
                            Modération des Annonces
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Auteur</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="moderation-table-body">
                                    <!-- Annonces à modérer chargées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION MON COMPTE (NOUVELLE SECTION) -->
        <section id="my_account-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="row">
                    <div class="col-md-3">
                        <!-- Sidebar Navigation -->
                        <div class="account-sidebar">
                            <nav class="nav flex-column">
                                <a class="nav-link active" href="#" onclick="showAccountSection('profile')">
                                    <i class="fas fa-user me-2"></i>Mon Profil
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('announces')">
                                    <i class="fas fa-bullhorn me-2"></i>Mes Annonces
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('favorites')">
                                    <i class="fas fa-heart me-2"></i>Mes Favoris
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('settings')">
                                    <i class="fas fa-cog me-2"></i>Paramètres
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('premium')">
                                    <i class="fas fa-crown me-2"></i>Abonnement Premium
                                </a>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <!-- Contenu du compte -->
                        <div class="account-content">
                            
                            <!-- Section Profil -->
                            <div id="account-profile" class="account-section active">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">
                                        <i class="fas fa-user me-2"></i>Mon Profil
                                    </h3>
                                    <button class="btn btn-outline-primary" onclick="toggleEditProfile()">
                                        <i class="fas fa-edit me-2"></i>Modifier
                                    </button>
                                </div>
                                
                                <div id="profile-view">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Nom complet</label>
                                                <p class="h5" id="profile-fullname">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Email</label>
                                                <p class="h6" id="profile-email">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Téléphone</label>
                                                <p class="h6" id="profile-phone">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Date d'inscription</label>
                                                <p class="h6" id="profile-created">-</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="user-avatar-large mb-3">
                                                <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 2rem; margin: 0 auto;">
                                                    <span id="profile-initials">MA</span>
                                                </div>
                                            </div>
                                            <div id="premium-status-badge" class="d-none">
                                                <span class="premium-badge">⭐ ABONNÉ PREMIUM</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="profile-edit" style="display: none;">
                                    <form id="profile-form" onsubmit="updateProfile(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Prénom *</label>
                                                <input type="text" class="form-control" id="edit-prenom" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Nom *</label>
                                                <input type="text" class="form-control" id="edit-nom" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="edit-email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Téléphone</label>
                                            <input type="tel" class="form-control" id="edit-phone" placeholder="+212 XX XX XX XX">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Enregistrer
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEditProfile()">
                                                Annuler
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Section Mes Annonces -->
                            <div id="account-announces" class="account-section">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">
                                        <i class="fas fa-bullhorn me-2"></i>Mes Annonces
                                    </h3>
                                    <button class="btn btn-primary" onclick="goToPublish()">
                                        <i class="fas fa-plus me-2"></i>Nouvelle Annonce
                                    </button>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-primary" id="stats-total-announces">0</h4>
                                                    <p class="text-muted mb-0">Total</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-success" id="stats-active-announces">0</h4>
                                                    <p class="text-muted mb-0">Actives</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-warning" id="stats-pending-announces">0</h4>
                                                    <p class="text-muted mb-0">En attente</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-danger" id="stats-rejected-announces">0</h4>
                                                    <p class="text-muted mb-0">Rejetées</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="user-announces-list">
                                    <!-- Annonces chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <!-- Autres sections du compte -->
                            <div id="account-favorites" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-heart me-2"></i>Mes Favoris
                                </h3>
                                <div class="text-center py-5">
                                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                    <h4>Vos favoris apparaîtront ici</h4>
                                    <p class="text-muted">Ajoutez des éléments en cliquant sur le cœur</p>
                                    <button class="btn btn-primary mt-3" onclick="goToSection('marketplace')">
                                        <i class="fas fa-shopping-cart me-2"></i>Parcourir la Marketplace
                                    </button>
                                </div>
                            </div>
                            
                            <div id="account-settings" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-cog me-2"></i>Paramètres du Compte
                                </h3>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Changer le mot de passe</h5>
                                        <form onsubmit="changePassword(event)">
                                            <div class="mb-3">
                                                <label class="form-label">Mot de passe actuel</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Nouveau mot de passe</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Confirmer le nouveau mot de passe</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-key me-2"></i>Changer le mot de passe
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="account-premium" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-crown me-2"></i>Abonnement Premium
                                </h3>
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-crown fa-3x text-warning mb-3"></i>
                                        <h4>Passez à la version Premium</h4>
                                        <p class="text-muted mb-4">Profitez d'avantages exclusifs pour booster votre activité</p>
                                        <button class="btn btn-warning btn-lg" onclick="goToSection('premium')">
                                            <i class="fas fa-star me-2"></i>Découvrir Premium
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h5>BTP Pro <span>🇲🇦</span></h5>
                    <p>La plateforme de référence des professionnels du BTP marocain</p>
                </div>
                <div class="col-md-2 mb-4">
                    <h5>Services</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" onclick="goToSection('marketplace')">Marketplace</a></li>
                        <li class="mb-2"><a href="#" onclick="goToSection('realestate')">Immobilier</a></li>
                        <li class="mb-2"><a href="#" onclick="goToSection('jobs')">Emploi</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2024 BTP Pro Maroc. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ========== CONFIGURATION ==========
        const ANNOUNCE_STATUS = {
            PENDING: 'en_attente',
            APPROVED: 'approuve',
            REJECTED: 'rejete',
            REPORTED: 'signale',
            PAUSED: 'en_pause'
        };

        const ITEMS_PER_PAGE = 8;

        // ========== BASE DE DONNÉES ==========
        class BTPDatabase {
            constructor() {
                this.localStorageKey = 'btp_pro_local_db';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.localStorageKey)) {
                    this.initializeLocalData();
                }
            }

            initializeLocalData() {
                const initialData = {
                    users: [
                        {
                            id: 1,
                            prenom: "Admin",
                            nom: "BTP",
                            email: "admin@btp.ma",
                            password: this.hashPassword("admin123"), // MOT DE PASSE HACHÉ
                            phone: "+212 6 00 00 00 00",
                            role: "admin",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 15,
                            lastVisit: new Date().toISOString(),
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            prenom: "Abderrahmane",
                            nom: "Lyaakobi",
                            email: "lyaakobi@hotmail.com",
                            password: this.hashPassword("@nisawsan1"), // MOT DE PASSE HACHÉ
                            phone: "+212 6 63 06 62 25",
                            role: "user",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 8,
                            lastVisit: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 3,
                            prenom: "Younes",
                            nom: "Hachimi",
                            email: "y.hachimi.yh@gmail.com",
                            password: this.hashPassword("@younes1"), // MOT DE PASSE HACHÉ
                            role: "user",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 12,
                            lastVisit: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                            createdAt: new Date().toISOString()
                        }
                    ],
                    marketplace_posts: [
                        {
                            id: 1,
                            title: "Ciment CPJ45 Lafarge",
                            description: "Sac de 50kg - Qualité Premium",
                            price: 85,
                            unit: "sac",
                            category: "ciment",
                            city: "casablanca",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: false,
                            photos: [],
                            createdAt: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000).toISOString() // 35 jours
                        },
                        {
                            id: 2,
                            title: "Carreaux Céramique 30x30",
                            description: "Marque Céragrès - Lot de 10m²",
                            price: 120,
                            unit: "m2",
                            category: "revetement",
                            city: "rabat",
                            phone: "+212 6 87 65 43 21",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 1,
                            userName: "Admin BTP",
                            isPremium: false,
                            photos: [],
                            createdAt: new Date().toISOString()
                        }
                    ],
                    realestate_posts: [
                        {
                            id: 1,
                            title: "Villa Moderne 220m² - Marrakech",
                            description: "Villa moderne avec 4 chambres, 3 salles de bain, garage",
                            price: 2800000,
                            type: "villa",
                            transaction: "vente",
                            surface: 220,
                            rooms: 4,
                            address: "Gueliz, Marrakech",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: true,
                            photos: [],
                            createdAt: new Date(Date.now() - 40 * 24 * 60 * 60 * 1000).toISOString() // 40 jours
                        }
                    ],
                    job_posts: [
                        {
                            id: 1,
                            poste: "Chef de Chantier BTP",
                            description: "Management d'équipe, suivi de chantier, respect des délais",
                            salaire: "15 000 - 18 000 MAD/mois",
                            contrat: "cdi",
                            ville: "casablanca",
                            experience: "5+ ans",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: true,
                            createdAt: new Date().toISOString()
                        }
                    ],
                    freelancers: [
                        {
                            id: 1,
                            title: "Infographiste 3D BTP - Freelance",
                            description: "Création de rendus 3D photoréalistes pour projets BTP, visualisations architecturales et conception de plans techniques",
                            specialty: "infographie",
                            tarif: "500-1000 MAD/jour",
                            ville: "casablanca",
                            experience: "5+ ans",
                            portfolio: "https://portfolio-lyaakobi.com",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            rating: 4.8,
                            reviewCount: 12,
                            isPremium: true,
                            createdAt: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString() // 45 jours
                        }
                    ],
                    professionals: [
                        {
                            id: 1,
                            company: "Maçonnerie Lyaakobi",
                            specialty: "maçonnerie",
                            experience: 15,
                            city: "casablanca",
                            description: "Spécialiste en gros œuvre et fondations",
                            phone: "+212 6 63 06 62 25",
                            rating: 4.8,
                            reviewCount: 124,
                            userId: 2
                        },
                        {
                            id: 2,
                            company: "Électricité BTP Pro",
                            specialty: "electricite",
                            experience: 8,
                            city: "rabat",
                            description: "Installation électrique complète, mise aux normes",
                            phone: "+212 6 87 65 43 21",
                            rating: 4.9,
                            reviewCount: 89,
                            userId: 3
                        }
                    ],
                    messages: [],
                    user_announces: [],
                    favorites: [],
                    adsense_slots: [
                        {
                            id: 'header_ad',
                            name: 'Bannière en-tête',
                            code: '',
                            position: 'header'
                        },
                        {
                            id: 'sidebar_ad',
                            name: 'Panneau latéral',
                            code: '',
                            position: 'sidebar'
                        },
                        {
                            id: 'footer_ad',
                            name: 'Pied de page',
                            code: '',
                            position: 'footer'
                        }
                    ],
                    newsletter_templates: {
                        maintenance: "Cher adhérent,\n\nNous vous informons que le site BTP Pro Maroc sera momentanément en maintenance le [date] de [heure] à [heure].\n\nNous nous excusons pour la gêne occasionnée.\n\nL'équipe BTP Pro",
                        nouveautes: "Cher adhérent,\n\nDécouvrez les nouvelles fonctionnalités de BTP Pro !\n\n- [Nouvelle fonctionnalité 1]\n- [Nouvelle fonctionnalité 2]\n- [Nouvelle fonctionnalité 3]\n\nL'équipe BTP Pro",
                        promotions: "Cher adhérent,\n\nProfitez de nos promotions exceptionnelles ce mois-ci !\n\n- [Promotion 1]\n- [Promotion 2]\n- [Promotion 3]\n\nL'équipe BTP Pro"
                    },
                    forum_categories: [
                        {
                            id: 1,
                            name: 'Questions techniques',
                            description: 'Discussions techniques sur les méthodes de construction',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 2,
                            name: 'Matériaux & Fournitures',
                            description: 'Échanges sur les matériaux de construction',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 3,
                            name: 'Réglementation & Normes',
                            description: 'Informations sur la réglementation BTP au Maroc',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 4,
                            name: 'Gestion de chantier',
                            description: 'Conseils et retours d\'expérience sur la gestion de chantier',
                            topicCount: 0,
                            lastActivity: null
                        }
                    ],
                    forum_topics: [],
                    premium_features: [
                        {
                            id: 'stats_advanced',
                            name: 'Statistiques avancées',
                            description: 'Accès aux données détaillées de performance'
                        },
                        {
                            id: 'priority_support',
                            name: 'Support prioritaire',
                            description: 'Réponses rapides de notre équipe'
                        },
                        {
                            id: 'unlimited_announces',
                            name: 'Annonces illimitées',
                            description: 'Publiez autant d\'annonces que vous voulez'
                        }
                    ],
                    backupSettings: {
                        enabled: false,
                        frequency: 'weekly',
                        email: 'admin@btp.ma',
                        lastBackup: null,
                        includeCoordinates: true,
                        includeVisits: true
                    },
                    backupHistory: []
                };
                
                this.saveLocalData(initialData);
            }

            // Hash simple pour les mots de passe (en production, utiliser bcrypt)
            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }

            async get(collection) {
                const localData = this.getLocalData();
                return localData[collection] || [];
            }

            async post(collection, data) {
                const item = {
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    ...data
                };

                const localData = this.getLocalData();
                if (!localData[collection]) localData[collection] = [];
                localData[collection].push(item);
                this.saveLocalData(localData);

                return item;
            }

            async put(collection, id, data) {
                const localData = this.getLocalData();
                const index = localData[collection].findIndex(item => item.id === id);
                
                if (index !== -1) {
                    localData[collection][index] = { ...localData[collection][index], ...data };
                    this.saveLocalData(localData);
                    return localData[collection][index];
                }
                
                return null;
            }

            getLocalData() {
                return JSON.parse(localStorage.getItem(this.localStorageKey)) || {};
            }

            saveLocalData(data) {
                localStorage.setItem(this.localStorageKey, JSON.stringify(data));
            }

            async authenticateUser(email, password) {
                const users = await this.get('users');
                const hashedPassword = this.hashPassword(password);
                const user = users.find(u => u.email === email && u.password === hashedPassword);
                return user || null;
            }

            async registerUser(userData) {
                const users = await this.get('users');
                
                // Vérification email unique
                if (users.find(u => u.email === userData.email)) {
                    throw new Error('Cet email est déjà utilisé');
                }

                const newUser = {
                    id: Date.now(),
                    ...userData,
                    password: this.hashPassword(userData.password),
                    role: 'user',
                    isVerified: false,
                    isBlocked: false,
                    hasPremium: false,
                    visitCount: 0,
                    lastVisit: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };

                const localData = this.getLocalData();
                localData.users.push(newUser);
                this.saveLocalData(localData);

                return newUser;
            }

            async getAdsenseSlots() {
                const localData = this.getLocalData();
                return localData.adsense_slots || [];
            }

            async saveAdsenseSlot(slotId, code) {
                const localData = this.getLocalData();
                const slotIndex = localData.adsense_slots.findIndex(slot => slot.id === slotId);
                
                if (slotIndex !== -1) {
                    localData.adsense_slots[slotIndex].code = code;
                    this.saveLocalData(localData);
                    return localData.adsense_slots[slotIndex];
                }
                
                return null;
            }

            async getNewsletterTemplate(name) {
                const localData = this.getLocalData();
                return localData.newsletter_templates?.[name] || "";
            }

            async getUserAnnounces(userId) {
                const collections = ['marketplace_posts', 'realestate_posts', 'job_posts', 'freelancers'];
                let userAnnounces = [];
                
                for (const collection of collections) {
                    const items = await this.get(collection);
                    const userItems = items.filter(item => item.userId === userId);
                    userAnnounces = userAnnounces.concat(userItems.map(item => ({
                        ...item,
                        type: collection.replace('_posts', '')
                    })));
                }
                
                return userAnnounces;
            }

            async getOldAnnounces() {
                const collections = ['marketplace_posts', 'realestate_posts', 'job_posts', 'freelancers'];
                let allAnnounces = [];
                const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                
                for (const collection of collections) {
                    const items = await this.get(collection);
                    const oldItems = items.filter(item => 
                        new Date(item.createdAt) < oneMonthAgo && 
                        item.status === ANNOUNCE_STATUS.APPROVED
                    );
                    allAnnounces = allAnnounces.concat(oldItems.map(item => ({
                        ...item,
                        type: collection.replace('_posts', '')
                    })));
                }
                
                return allAnnounces;
            }

            async toggleFavorite(userId, itemId, itemType) {
                const favorites = await this.get('favorites');
                const existingIndex = favorites.findIndex(fav => 
                    fav.userId === userId && fav.itemId === itemId && fav.itemType === itemType
                );

                if (existingIndex !== -1) {
                    // Retirer des favoris
                    favorites.splice(existingIndex, 1);
                } else {
                    // Ajouter aux favoris
                    favorites.push({
                        id: Date.now(),
                        userId,
                        itemId,
                        itemType,
                        createdAt: new Date().toISOString()
                    });
                }

                const localData = this.getLocalData();
                localData.favorites = favorites;
                this.saveLocalData(localData);

                return existingIndex === -1; // Retourne true si ajouté, false si retiré
            }

            async getUserFavorites(userId) {
                const favorites = await this.get('favorites');
                return favorites.filter(fav => fav.userId === userId);
            }

            async isItemFavorited(userId, itemId, itemType) {
                const favorites = await this.get('favorites');
                return favorites.some(fav => 
                    fav.userId === userId && fav.itemId === itemId && fav.itemType === itemType
                );
            }

            // NOUVELLES FONCTIONS POUR LA SAUVEGARDE
            async getUserVisits(userId) {
                const users = await this.get('users');
                const user = users.find(u => u.id === userId);
                return user?.visitCount || 0;
            }

            async incrementUserVisit(userId) {
                const users = await this.get('users');
                const userIndex = users.findIndex(u => u.id === userId);
                
                if (userIndex !== -1) {
                    const currentVisits = users[userIndex].visitCount || 0;
                    users[userIndex].visitCount = currentVisits + 1;
                    users[userIndex].lastVisit = new Date().toISOString();
                    
                    const localData = this.getLocalData();
                    localData.users = users;
                    this.saveLocalData(localData);
                    
                    return users[userIndex].visitCount;
                }
                return 0;
            }

            async getAllUsersWithDetails() {
                const users = await this.get('users');
                return users.map(user => ({
                    id: user.id,
                    prenom: user.prenom,
                    nom: user.nom,
                    email: user.email,
                    phone: user.phone || 'Non renseigné',
                    role: user.role,
                    isVerified: user.isVerified,
                    hasPremium: user.hasPremium || false,
                    visitCount: user.visitCount || 0,
                    lastVisit: user.lastVisit,
                    createdAt: user.createdAt,
                    isBlocked: user.isBlocked || false
                }));
            }

            async saveBackupSettings(settings) {
                const localData = this.getLocalData();
                localData.backupSettings = {
                    ...localData.backupSettings,
                    ...settings,
                    lastBackup: new Date().toISOString()
                };
                this.saveLocalData(localData);
                return localData.backupSettings;
            }

            async getBackupSettings() {
                const localData = this.getLocalData();
                return localData.backupSettings || {
                    enabled: false,
                    frequency: 'weekly',
                    email: '',
                    lastBackup: null,
                    includeCoordinates: true,
                    includeVisits: true
                };
            }

            async createBackup() {
                const users = await this.getAllUsersWithDetails();
                const settings = await this.getBackupSettings();
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    totalUsers: users.length,
                    activeUsers: users.filter(u => !u.isBlocked).length,
                    premiumUsers: users.filter(u => u.hasPremium).length,
                    totalVisits: users.reduce((sum, user) => sum + (user.visitCount || 0), 0),
                    users: users
                };
                
                // Sauvegarder l'historique des backups
                const localData = this.getLocalData();
                if (!localData.backupHistory) {
                    localData.backupHistory = [];
                }
                
                localData.backupHistory.unshift({
                    id: Date.now(),
                    ...backupData,
                    downloaded: false
                });
                
                // Garder seulement les 10 derniers backups
                if (localData.backupHistory.length > 10) {
                    localData.backupHistory = localData.backupHistory.slice(0, 10);
                }
                
                this.saveLocalData(localData);
                
                return backupData;
            }

            async getBackupHistory() {
                const localData = this.getLocalData();
                return localData.backupHistory || [];
            }
        }

        // ========== INITIALISATION ==========
        const btpDB = new BTPDatabase();
        let loginModal, registerModal, backupSettingsModal;
        let currentChat = null;

        const appState = {
            currentUser: null,
            currentSection: 'home',
            currentAccountSection: 'profile',
            isAdmin: false,
            theme: 'light',
            currentPage: {
                marketplace: 1,
                realestate: 1,
                jobs: 1,
                freelancers: 1,
                professionals: 1
            }
        };

        // ========== FONCTIONS DE VALIDATION EMAIL ==========
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateEmailField(input) {
            const email = input.value.trim();
            const errorDiv = document.getElementById('emailError');
            
            if (!email) {
                input.classList.remove('is-invalid');
                return true;
            }
            
            if (!validateEmail(email)) {
                input.classList.add('is-invalid');
                errorDiv.textContent = 'Format d\'email invalide';
                return false;
            } else {
                input.classList.remove('is-invalid');
                return true;
            }
        }

        // ========== FONCTIONS UTILITAIRES AMÉLIORÉES ==========
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function safeDBOperation(operation, errorMessage) {
            try {
                return await operation();
            } catch (error) {
                console.error(`${errorMessage}:`, error);
                showAlert(`❌ ${errorMessage}`, 'error');
                return null;
            }
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function safeInnerHTML(element, content) {
            element.textContent = content;
        }

        // ========== FONCTIONS PRINCIPALES ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            trackUserVisit(); // Ajoutez cette ligne pour suivre les visites
        });

        function initializeApp() {
            initializeModals();
            loadMarketplaceCategories();
            loadApprovedAnnounces();
            loadProfessionals();
            loadFreelancers();
            loadAdminStats();
            loadForumTopics();
            
            // Initialiser la recherche avec debounce
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(performGlobalSearch, 300));
            }
            
            // Gestionnaire d'erreurs global
            window.addEventListener('error', (event) => {
                console.error('Erreur globale:', event.error);
                showAlert('Une erreur technique est survenue', 'error');
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Promesse rejetée:', event.reason);
                showAlert('Une erreur est survenue', 'error');
            });
            
            console.log('✅ Application initialisée !');
        }

        function initializeModals() {
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            backupSettingsModal = new bootstrap.Modal(document.getElementById('backupSettingsModal'));
        }

        // ========== FONCTIONS DE NAVIGATION ==========
        function goToSection(section) {
            // Vérifier l'accès aux sections privées
            if ((section === 'my_account' || section === 'favorites') && !appState.currentUser) {
                showAlert('🔐 Connectez-vous pour accéder à cette section', 'warning');
                showLoginModal();
                return;
            }

            document.querySelectorAll('.section-content').forEach(s => {
                s.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
            });
            
            const targetSection = document.getElementById(section + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                appState.currentSection = section;
                
                // Mettre à jour la navigation active
                const activeLinks = document.querySelectorAll(`[onclick="goToSection('${section}')"]`);
                if (activeLinks.length > 0) {
                    activeLinks[0].classList.add('active');
                }

                // Charger les données si section mon compte
                if (section === 'my_account') {
                    loadUserProfile();
                    loadUserAnnounces();
                }

                // Charger les données spécifiques à chaque section
                switch(section) {
                    case 'marketplace':
                        btpDB.get('marketplace_posts').then(posts => displayMarketplaceAnnounces(posts, 1));
                        break;
                    case 'realestate':
                        btpDB.get('realestate_posts').then(posts => displayRealestateAnnounces(posts, 1));
                        break;
                    case 'jobs':
                        btpDB.get('job_posts').then(posts => displayJobsAnnounces(posts, 1));
                        break;
                    case 'freelancers':
                        btpDB.get('freelancers').then(freelancers => displayFreelancers(freelancers, 1));
                        break;
                    case 'professionals':
                        btpDB.get('professionals').then(professionals => displayProfessionals(professionals, 1));
                        break;
                    case 'admin':
                        if (appState.isAdmin) loadAdminStats();
                        break;
                    case 'favorites':
                        if (appState.currentUser) loadUserFavorites();
                        break;
                }
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToPublish() {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour publier du contenu sur BTP Pro', 'warning');
                showLoginModal();
                return;
            }
            goToSection('publish');
        }

        function checkAuthAndGo(section, context) {
            if (!appState.currentUser) {
                const messages = {
                    'marketplace': '🛒 Connectez-vous pour publier vos produits',
                    'immobilier': '🏠 Connectez-vous pour publier vos annonces immobilières', 
                    'emploi': '💼 Connectez-vous pour publier vos offres d\'emploi',
                    'forum': '💬 Connectez-vous pour participer au forum',
                    'freelance': '🎨 Connectez-vous pour proposer vos services'
                };
                showAlert(messages[context] || '🔐 Connectez-vous pour continuer', 'warning');
                showLoginModal();
                return;
            }
            goToSection(section);
        }

        // ========== GESTION DU COMPTE UTILISATEUR ==========
        function showAccountSection(section) {
            appState.currentAccountSection = section;
            
            // Mettre à jour la navigation sidebar
            document.querySelectorAll('.account-sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Afficher la section correspondante
            document.querySelectorAll('.account-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('account-' + section).classList.add('active');
            
            // Charger les données si nécessaire
            if (section === 'announces') {
                loadUserAnnounces();
            } else if (section === 'favorites') {
                loadUserFavorites();
            }
        }

        async function loadUserProfile() {
            if (!appState.currentUser) return;

            const user = appState.currentUser;
            
            // Mettre à jour l'affichage du profil
            document.getElementById('profile-fullname').textContent = `${user.prenom} ${user.nom}`;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-phone').textContent = user.phone || 'Non renseigné';
            document.getElementById('profile-created').textContent = new Date(user.createdAt).toLocaleDateString('fr-FR');
            document.getElementById('profile-initials').textContent = user.prenom.charAt(0) + user.nom.charAt(0);
            
            // Mettre à jour le formulaire d'édition
            document.getElementById('edit-prenom').value = user.prenom;
            document.getElementById('edit-nom').value = user.nom;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-phone').value = user.phone || '';
            
            // Badge Premium
            const premiumBadge = document.getElementById('premium-status-badge');
            if (user.hasPremium) {
                premiumBadge.classList.remove('d-none');
            } else {
                premiumBadge.classList.add('d-none');
            }
        }

        function toggleEditProfile() {
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            
            if (profileEdit.style.display === 'none') {
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
            } else {
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
            }
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            if (!appState.currentUser) return;

            const updatedData = {
                prenom: document.getElementById('edit-prenom').value,
                nom: document.getElementById('edit-nom').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value
            };

            try {
                await btpDB.put('users', appState.currentUser.id, updatedData);
                
                // Mettre à jour l'utilisateur courant
                appState.currentUser = { ...appState.currentUser, ...updatedData };
                updateUserUI();
                
                showAlert('✅ Profil mis à jour avec succès !', 'success');
                toggleEditProfile();
                loadUserProfile();
                
            } catch (error) {
                showAlert('❌ Erreur lors de la mise à jour du profil', 'error');
            }
        }

        async function loadUserAnnounces() {
            if (!appState.currentUser) return;

            try {
                const userAnnounces = await btpDB.getUserAnnounces(appState.currentUser.id);
                displayUserAnnounces(userAnnounces);
                updateAnnouncesStats(userAnnounces);
                
            } catch (error) {
                console.error('Erreur chargement annonces utilisateur:', error);
            }
        }

        function displayUserAnnounces(announces) {
            const container = document.getElementById('user-announces-list');
            if (!container) return;

            let html = '';
            
            if (announces.length === 0) {
                html = `
                    <div class="text-center py-5">
                        <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                        <h4>Vous n'avez pas encore publié d'annonces</h4>
                        <p class="text-muted">Commencez par publier votre première annonce</p>
                        <button class="btn btn-primary mt-3" onclick="goToPublish()">
                            <i class="fas fa-plus me-2"></i>Publier une annonce
                        </button>
                    </div>
                `;
            } else {
                announces.forEach(announce => {
                    const statusBadge = getAnnounceStatusBadge(announce.status);
                    const typeLabel = getAnnounceTypeLabel(announce.type);
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">${announce.title || announce.poste}</h5>
                                        <p class="text-muted mb-2">${announce.description}</p>
                                        <div class="d-flex flex-wrap gap-2 mb-2 align-items-center">
                                            <span class="badge bg-secondary">${typeLabel}</span>
                                            <span class="announce-status-badge ${statusBadge.class}">
                                                ${statusBadge.text}
                                            </span>
                                            ${announce.isPremium ? '<span class="premium-badge">PREMIUM</span>' : ''}
                                            <small class="text-muted ms-2">
                                                <i class="fas fa-calendar me-1"></i>
                                                ${new Date(announce.createdAt).toLocaleDateString('fr-FR')}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="btn-group ms-3">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="editAnnounce(${announce.id}, '${announce.type}')"
                                                title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteAnnounce(${announce.id}, '${announce.type}')"
                                                title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function updateAnnouncesStats(announces) {
            const total = announces.length;
            const active = announces.filter(a => a.status === ANNOUNCE_STATUS.APPROVED).length;
            const pending = announces.filter(a => a.status === ANNOUNCE_STATUS.PENDING).length;
            const rejected = announces.filter(a => a.status === ANNOUNCE_STATUS.REJECTED).length;

            document.getElementById('stats-total-announces').textContent = total;
            document.getElementById('stats-active-announces').textContent = active;
            document.getElementById('stats-pending-announces').textContent = pending;
            document.getElementById('stats-rejected-announces').textContent = rejected;
        }

        function getAnnounceStatusBadge(status) {
            switch(status) {
                case ANNOUNCE_STATUS.APPROVED:
                    return { class: 'status-approved', text: '✅ Approuvée' };
                case ANNOUNCE_STATUS.PENDING:
                    return { class: 'status-pending', text: '⏳ En attente' };
                case ANNOUNCE_STATUS.REJECTED:
                    return { class: 'status-rejected', text: '❌ Rejetée' };
                case ANNOUNCE_STATUS.PAUSED:
                    return { class: 'status-paused', text: '⏸️ En pause' };
                default:
                    return { class: 'status-pending', text: '⏳ En attente' };
            }
        }

        function getAnnounceTypeLabel(type) {
            switch(type) {
                case 'marketplace': return 'Marketplace';
                case 'realestate': return 'Immobilier';
                case 'job': return 'Emploi';
                case 'freelancers': return 'Freelance';
                default: return type;
            }
        }

        // ========== GESTION DES FAVORIS ==========
        async function toggleFavorite(itemId, itemType = 'marketplace') {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour ajouter aux favoris', 'warning');
                showLoginModal();
                return;
            }

            const wasAdded = await btpDB.toggleFavorite(
                appState.currentUser.id, 
                itemId, 
                itemType
            );

            // Mettre à jour l'icône du bouton
            const favoriteBtn = event.target.closest('.favorite-btn');
            if (favoriteBtn) {
                const icon = favoriteBtn.querySelector('i');
                if (wasAdded) {
                    icon.className = 'fas fa-heart';
                    favoriteBtn.classList.add('active');
                    showAlert('❤️ Ajouté aux favoris', 'success');
                } else {
                    icon.className = 'far fa-heart';
                    favoriteBtn.classList.remove('active');
                    showAlert('💔 Retiré des favoris', 'info');
                }
            }

            // Recharger la section favoris si active
            if (appState.currentSection === 'favorites') {
                loadUserFavorites();
            }
        }

        async function loadUserFavorites() {
            if (!appState.currentUser) return;

            try {
                const favorites = await btpDB.getUserFavorites(appState.currentUser.id);
                displayUserFavorites(favorites);
            } catch (error) {
                console.error('Erreur chargement favoris:', error);
            }
        }

        async function displayUserFavorites(favorites) {
            const container = document.getElementById('favorites-section');
            if (!container) return;

            let html = '';
            
            if (favorites.length === 0) {
                html = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                    <h4>Vous n'avez pas encore de favoris</h4>
                                    <p class="text-muted">Ajoutez des éléments en cliquant sur le cœur</p>
                                    <button class="btn btn-primary mt-3" onclick="goToSection('marketplace')">
                                        <i class="fas fa-shopping-cart me-2"></i>Parcourir la Marketplace
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html = '<div class="row g-4">';
                
                for (const favorite of favorites) {
                    let item;
                    
                    // Récupérer l'élément selon son type
                    switch(favorite.itemType) {
                        case 'marketplace':
                            const marketplaceItems = await btpDB.get('marketplace_posts');
                            item = marketplaceItems.find(i => i.id === favorite.itemId);
                            break;
                        case 'realestate':
                            const realestateItems = await btpDB.get('realestate_posts');
                            item = realestateItems.find(i => i.id === favorite.itemId);
                            break;
                        case 'job':
                            const jobItems = await btpDB.get('job_posts');
                            item = jobItems.find(i => i.id === favorite.itemId);
                            break;
                        case 'freelancers':
                            const freelancerItems = await btpDB.get('freelancers');
                            item = freelancerItems.find(i => i.id === favorite.itemId);
                            break;
                    }
                    
                    if (item) {
                        html += `
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 position-relative">
                                    <button class="favorite-btn active" onclick="toggleFavorite(${item.id}, '${favorite.itemType}')">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <div class="card-body">
                                        <h5 class="card-title">${item.title || item.poste}</h5>
                                        <p class="text-muted">${item.description.substring(0, 100)}...</p>
                                        ${item.price ? `<p class="text-success fw-bold h5">${item.price} MAD${item.unit ? '/' + item.unit : ''}</p>` : ''}
                                        ${item.salaire ? `<p class="text-success fw-bold h5">${item.salaire}</p>` : ''}
                                        <div class="d-flex gap-2 mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="showContactInfo('${item.phone}', '${item.userName}')">
                                                <i class="fas fa-phone me-1"></i>Contacter
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="startChat(${item.userId}, '${item.userName}')">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            }

            const favoritesContainer = container.querySelector('.container .row');
            if (favoritesContainer) {
                favoritesContainer.innerHTML = html;
            }
        }

        // ========== GESTION DES ANNONCES ==========
        async function editAnnounce(announceId, type) {
            try {
                const collection = getCollectionByType(type);
                const items = await btpDB.get(collection);
                const announce = items.find(item => item.id === announceId);
                
                if (!announce) {
                    showAlert('Annonce non trouvée', 'error');
                    return;
                }
                
                // Vérifier que l'utilisateur est bien le propriétaire
                if (announce.userId !== appState.currentUser.id && !appState.isAdmin) {
                    showAlert('Vous n\'êtes pas autorisé à modifier cette annonce', 'error');
                    return;
                }
                
                // Rediriger vers le formulaire de publication pré-rempli
                goToSection('publish');
                
                // Afficher le bon formulaire et pré-remplir les champs
                setTimeout(() => {
                    showPublishForm(type);
                    fillEditForm(announce, type);
                }, 500);
                
            } catch (error) {
                console.error('Erreur édition annonce:', error);
                showAlert('Erreur lors du chargement de l\'annonce', 'error');
            }
        }

        function getCollectionByType(type) {
            switch(type) {
                case 'marketplace': return 'marketplace_posts';
                case 'realestate': return 'realestate_posts';
                case 'job': return 'job_posts';
                case 'freelancers': return 'freelancers';
                default: return type + '_posts';
            }
        }

        function fillEditForm(announce, type) {
            // Stocker l'ID de l'annonce en cours d'édition
            window.editingAnnounceId = announce.id;
            window.editingAnnounceType = type;
            
            // Afficher le bouton "Nouvelle annonce"
            document.getElementById('new-announce-btn').style.display = 'block';
            
            // Ajouter un indicateur d'édition
            const formTitle = document.querySelector(`#${type}-form .card-header h5`);
            if (formTitle) {
                formTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Modifier l'annonce`;
            }
            
            // Pré-remplir selon le type d'annonce
            switch(type) {
                case 'marketplace':
                    document.querySelector('#marketplace-form input[name="title"]').value = announce.title || '';
                    document.querySelector('#marketplace-form input[name="price"]').value = announce.price || '';
                    document.querySelector('#marketplace-form select[name="unit"]').value = announce.unit || 'sac';
                    document.querySelector('#marketplace-form select[name="category"]').value = announce.category || '';
                    document.querySelector('#marketplace-form select[name="city"]').value = announce.city || '';
                    document.querySelector('#marketplace-form textarea[name="description"]').value = announce.description || '';
                    document.querySelector('#marketplace-form input[name="phone"]').value = announce.phone || '';
                    break;
                    
                case 'realestate':
                    document.querySelector('#immobilier-form input[name="title"]').value = announce.title || '';
                    document.querySelector('#immobilier-form input[name="price"]').value = announce.price || '';
                    document.querySelector('#immobilier-form select[name="type"]').value = announce.type || '';
                    document.querySelector('#immobilier-form input[name="surface"]').value = announce.surface || '';
                    document.querySelector('#immobilier-form input[name="rooms"]').value = announce.rooms || '';
                    document.querySelector('#immobilier-form input[name="address"]').value = announce.address || '';
                    document.querySelector('#immobilier-form textarea[name="description"]').value = announce.description || '';
                    document.querySelector('#immobilier-form input[name="phone"]').value = announce.phone || '';
                    break;
                    
                case 'job':
                    document.querySelector('#emploi-form input[name="poste"]').value = announce.poste || '';
                    document.querySelector('#emploi-form input[name="salaire"]').value = announce.salaire || '';
                    document.querySelector('#emploi-form select[name="contrat"]').value = announce.contrat || '';
                    document.querySelector('#emploi-form input[name="ville"]').value = announce.ville || '';
                    document.querySelector('#emploi-form input[name="experience"]').value = announce.experience || '';
                    document.querySelector('#emploi-form textarea[name="description"]').value = announce.description || '';
                    document.querySelector('#emploi-form input[name="phone"]').value = announce.phone || '';
                    break;
                    
                case 'freelancers':
                    document.querySelector('#freelance-form input[name="title"]').value = announce.title || '';
                    document.querySelector('#freelance-form select[name="specialty"]').value = announce.specialty || '';
                    document.querySelector('#freelance-form input[name="tarif"]').value = announce.tarif || '';
                    document.querySelector('#freelance-form input[name="ville"]').value = announce.ville || '';
                    document.querySelector('#freelance-form input[name="experience"]').value = announce.experience || '';
                    document.querySelector('#freelance-form textarea[name="description"]').value = announce.description || '';
                    document.querySelector('#freelance-form input[name="portfolio"]').value = announce.portfolio || '';
                    document.querySelector('#freelance-form input[name="phone"]').value = announce.phone || '';
                    break;
            }
        }

        async function deleteAnnounce(announceId, type) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette annonce ? Cette action est irréversible.')) {
                return;
            }

            try {
                const collection = getCollectionByType(type);
                const items = await btpDB.get(collection);
                const updatedItems = items.filter(item => item.id !== announceId);
                
                // Sauvegarder les modifications
                const localData = btpDB.getLocalData();
                localData[collection] = updatedItems;
                btpDB.saveLocalData(localData);
                
                showAlert('✅ Annonce supprimée avec succès !', 'success');
                
                // Recharger les annonces utilisateur
                loadUserAnnounces();
                
            } catch (error) {
                console.error('Erreur suppression annonce:', error);
                showAlert('❌ Erreur lors de la suppression', 'error');
            }
        }

        function showNewAnnounceForm() {
            resetEditMode();
            showPublishForm('marketplace'); // Par défaut, montrer marketplace
            
            // Réinitialiser tous les formulaires
            document.querySelectorAll('.publish-form form').forEach(form => {
                form.reset();
            });
            
            document.querySelectorAll('.photo-preview').forEach(preview => {
                preview.innerHTML = '';
            });
        }

        function resetEditMode() {
            window.editingAnnounceId = null;
            window.editingAnnounceType = null;
            
            // Cacher le bouton "Nouvelle annonce"
            document.getElementById('new-announce-btn').style.display = 'none';
            
            // Réinitialiser les titres des formulaires
            document.querySelectorAll('.publish-form .card-header h5').forEach(title => {
                const type = title.closest('.publish-form').id.replace('-form', '');
                const icons = {
                    'marketplace': 'fa-shopping-cart',
                    'immobilier': 'fa-home', 
                    'emploi': 'fa-briefcase',
                    'freelance': 'fa-palette'
                };
                title.innerHTML = `<i class="fas ${icons[type]} me-2"></i>Nouvelle annonce`;
            });
        }

        // ========== FONCTIONS D'AUTHENTIFICATION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('❌ Veuillez remplir tous les champs', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showAlert('❌ Format d\'email invalide', 'error');
                return;
            }

            showLoading(true);

            try {
                const user = await btpDB.authenticateUser(email, password);
                console.log('🔐 Tentative de connexion:', { email, user });

                if (user) {
                    if (user.isBlocked) {
                        showAlert('❌ Votre compte a été bloqué. Contactez l\'administrateur.', 'error');
                        return;
                    }

                    appState.currentUser = user;
                    appState.isAdmin = user.role === 'admin';
                    updateUserUI();
                    
                    loginModal.hide();
                    showAlert(`✅ Connexion réussie ! Bienvenue ${user.prenom}`, 'success');
                    
                    // Recharger les données si admin
                    if (appState.isAdmin) {
                        loadAdminStats();
                    }
                } else {
                    showAlert('❌ Email ou mot de passe incorrect', 'error');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showAlert('❌ Erreur de connexion', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const prenom = document.getElementById('registerPrenom').value.trim();
            const nom = document.getElementById('registerNom').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Vérification des champs obligatoires
            if (!prenom || !nom || !email || !password || !confirmPassword) {
                showAlert('❌ Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            // Validation email
            if (!validateEmail(email)) {
                showAlert('❌ Format d\'email invalide', 'error');
                return;
            }

            // Vérification correspondance mots de passe
            if (password !== confirmPassword) {
                showAlert('❌ Les mots de passe ne correspondent pas', 'error');
                return;
            }

            // Vérification longueur mot de passe
            if (password.length < 6) {
                showAlert('❌ Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            showLoading(true);

            try {
                const newUser = await btpDB.registerUser({
                    prenom,
                    nom,
                    email,
                    password,
                    phone: document.getElementById('registerPhone').value
                });

                appState.currentUser = newUser;
                appState.isAdmin = false;
                updateUserUI();
                
                registerModal.hide();
                showAlert('✅ Inscription réussie ! Bienvenue sur BTP Pro', 'success');
                
            } catch (error) {
                showAlert('❌ ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateUserUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            const adminBadge = document.getElementById('admin-badge');
            const adminMenuItem = document.getElementById('admin-menu-item');
            const adminNavItem = document.getElementById('admin-nav-item');
            
            if (appState.currentUser) {
                authButtons.classList.add('d-none');
                userMenu.classList.remove('d-none');
                document.getElementById('user-name').textContent = appState.currentUser.prenom;
                document.getElementById('user-initials').textContent = 
                    appState.currentUser.prenom.charAt(0) + appState.currentUser.nom.charAt(0);
                
                if (appState.isAdmin) {
                    adminBadge.classList.remove('d-none');
                    adminMenuItem.classList.remove('d-none');
                    adminNavItem.classList.remove('d-none');
                } else {
                    adminBadge.classList.add('d-none');
                    adminMenuItem.classList.add('d-none');
                    adminNavItem.classList.add('d-none');
                }
            } else {
                authButtons.classList.remove('d-none');
                userMenu.classList.add('d-none');
                adminNavItem.classList.add('d-none');
            }
        }

        function logout() {
            // 1. Fermer la messagerie IMMÉDIATEMENT
            const messagingContainer = document.getElementById('messagingContainer');
            if (messagingContainer) {
                messagingContainer.style.display = 'none';
            }
            
            // 2. Réinitialiser la conversation en cours
            currentChat = null;
            
            // 3. Vider et désactiver le champ de message
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.chat-input button');
            if (messageInput) {
                messageInput.value = '';
                messageInput.disabled = true;
                messageInput.placeholder = 'Tapez votre message...';
            }
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // 4. Vider les messages affichés
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = '<div class="alert alert-info text-center">' +
                    '<i class="fas fa-info-circle me-2"></i>' +
                    'Sélectionnez un contact pour commencer à discuter' +
                    '</div>';
            }
            
            // 5. Réinitialiser l'état de l'application
            appState.currentUser = null;
            appState.isAdmin = false;
            
            // 6. Mettre à jour l'interface utilisateur
            updateUserUI();
            
            // 7. Notifier et rediriger
            showAlert('✅ Déconnexion réussie', 'info');
            goToSection('home');
        }

        // ========== CATÉGORIES MARKETPLACE ==========
        const marketplaceCategories = [
            "Agrégats & Sables",
            "Béton Prêt à l'Emploi", 
            "Ciments & Mortiers",
            "Charpente Métallique",
            "Charpente Bois",
            "Clôtures & Grilles",
            "Échafaudages & Équipements",
            "Électricité",
            "Étanchéité",
            "Isolation",
            "Lustrerie",
            "Menuiserie",
            "Mobilier de Jardin",
            "Outillage & Machines",
            "Parpaings & Agglomérés",
            "Peinture & Revêtements",
            "Plantes & Végétation",
            "Plomberie & Sanitaires",
            "Signalétique",
            "Équipements de Sécurité"
        ].sort();

        function loadMarketplaceCategories() {
            const select = document.getElementById('marketplaceCategorySelect');
            const filter = document.getElementById('marketplaceCategoryFilter');
            
            let html = '<option value="">Choisir une catégorie</option>';
            marketplaceCategories.forEach(category => {
                const value = category.toLowerCase().replace(/ & /g, '_').replace(/ /g, '_');
                html += `<option value="${value}">${category}</option>`;
            });
            
            if (select) select.innerHTML = html;
            if (filter) filter.innerHTML = html;
        }

        // ========== FONCTIONS DES SECTIONS AVEC PAGINATION ==========
        async function loadApprovedAnnounces() {
            try {
                const [marketplace, realestate, jobs, freelancers] = await Promise.all([
                    btpDB.get('marketplace_posts'),
                    btpDB.get('realestate_posts'),
                    btpDB.get('job_posts'),
                    btpDB.get('freelancers')
                ]);

                displayMarketplaceAnnounces(marketplace);
                displayRealestateAnnounces(realestate);
                displayJobsAnnounces(jobs);
                displayFreelancers(freelancers);
                
            } catch (error) {
                console.error('Erreur chargement annonces:', error);
            }
        }

        async function displayMarketplaceAnnounces(posts, page = 1) {
            const container = document.getElementById('marketplace-container');
            const pagination = document.getElementById('marketplace-pagination');
            if (!container) return;

            // Filtrer et trier
            let filteredPosts = posts.filter(post => post.status === ANNOUNCE_STATUS.APPROVED);
            
            // Appliquer les filtres
            const categoryFilter = document.getElementById('marketplaceCategoryFilter')?.value;
            const cityFilter = document.getElementById('marketplaceCityFilter')?.value;
            const sort = document.getElementById('marketplaceSort')?.value;

            if (categoryFilter) {
                filteredPosts = filteredPosts.filter(post => post.category === categoryFilter);
            }
            if (cityFilter) {
                filteredPosts = filteredPosts.filter(post => post.city === cityFilter);
            }

            // Trier
            if (sort === 'price_asc') {
                filteredPosts.sort((a, b) => a.price - b.price);
            } else if (sort === 'price_desc') {
                filteredPosts.sort((a, b) => b.price - a.price);
            } else if (sort === 'premium') {
                filteredPosts.sort((a, b) => (b.isPremium ? 1 : 0) - (a.isPremium ? 1 : 0));
            } else {
                filteredPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            // Pagination
            const totalPages = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const paginatedPosts = filteredPosts.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            let html = '';
            if (paginatedPosts.length === 0) {
                html = '<div class="col-12 text-center"><p class="text-muted">Aucun produit disponible pour le moment.</p></div>';
            } else {
                for (const post of paginatedPosts) {
                    const isOld = isAnnounceOld(post.createdAt);
                    const isFavorited = appState.currentUser ? 
                        await btpDB.isItemFavorited(appState.currentUser.id, post.id, 'marketplace') : false;
                    
                    html += `
                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 position-relative">
                                ${post.isPremium ? '<span class="premium-badge">⭐ PREMIUM</span>' : ''}
                                ${isOld && appState.isAdmin ? `
                                    <div class="admin-actions">
                                        <button class="btn btn-warning btn-sm admin-btn" onclick="pauseAnnounce(${post.id}, 'marketplace')" title="Mettre en pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm admin-btn" onclick="deleteAnnounceAdmin(${post.id}, 'marketplace')" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${post.id}, 'marketplace')">
                                    <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <div class="card-body">
                                    <h5 class="card-title">${post.title}</h5>
                                    <p class="text-muted">${post.description}</p>
                                    <p class="text-success fw-bold h5">${post.price} MAD/${post.unit}</p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="showContactInfo('${post.phone}', '${post.userName}')">
                                            <i class="fas fa-phone me-2"></i>Contacter
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="startChat(${post.userId}, '${post.userName}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            generatePagination(pagination, page, totalPages, 'marketplace');
        }

        async function displayRealestateAnnounces(posts, page = 1) {
            const container = document.getElementById('realestate-container');
            const pagination = document.getElementById('realestate-pagination');
            if (!container) return;

            let filteredPosts = posts.filter(post => post.status === ANNOUNCE_STATUS.APPROVED);
            
            // Appliquer les filtres
            const typeFilter = document.getElementById('realestateTypeFilter')?.value;
            const cityFilter = document.getElementById('realestateCityFilter')?.value;
            const priceFilter = document.getElementById('realestatePriceFilter')?.value;
            const sort = document.getElementById('realestateSort')?.value;

            if (typeFilter) {
                filteredPosts = filteredPosts.filter(post => post.type === typeFilter);
            }
            if (cityFilter) {
                filteredPosts = filteredPosts.filter(post => post.city === cityFilter);
            }
            if (priceFilter) {
                const [min, max] = priceFilter.split('-').map(p => p === '+' ? Infinity : parseInt(p));
                filteredPosts = filteredPosts.filter(post => {
                    if (max === Infinity) return post.price >= min;
                    return post.price >= min && post.price <= max;
                });
            }

            // Trier
            if (sort === 'price_asc') {
                filteredPosts.sort((a, b) => a.price - b.price);
            } else if (sort === 'price_desc') {
                filteredPosts.sort((a, b) => b.price - a.price);
            } else if (sort === 'premium') {
                filteredPosts.sort((a, b) => (b.isPremium ? 1 : 0) - (a.isPremium ? 1 : 0));
            } else {
                filteredPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            // Pagination
            const totalPages = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const paginatedPosts = filteredPosts.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            let html = '';
            if (paginatedPosts.length === 0) {
                html = '<div class="col-12 text-center"><p class="text-muted">Aucun bien immobilier disponible pour le moment.</p></div>';
            } else {
                for (const post of paginatedPosts) {
                    const isOld = isAnnounceOld(post.createdAt);
                    const isFavorited = appState.currentUser ? 
                        await btpDB.isItemFavorited(appState.currentUser.id, post.id, 'realestate') : false;
                    
                    html += `
                        <div class="col-md-6">
                            <div class="card h-100 position-relative">
                                ${post.isPremium ? '<span class="premium-badge">⭐ PREMIUM</span>' : ''}
                                ${isOld && appState.isAdmin ? `
                                    <div class="admin-actions">
                                        <button class="btn btn-warning btn-sm admin-btn" onclick="pauseAnnounce(${post.id}, 'realestate')" title="Mettre en pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm admin-btn" onclick="deleteAnnounceAdmin(${post.id}, 'realestate')" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${post.id}, 'realestate')">
                                    <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <div class="card-body">
                                    <h5 class="card-title">${post.title}</h5>
                                    <p class="text-muted">${post.description}</p>
                                    <p class="text-success fw-bold h4">${post.price.toLocaleString()} MAD</p>
                                    <p class="text-muted">${post.address}</p>
                                    ${post.photos && post.photos.length > 0 ? 
                                        `<div class="mb-2"><small class="text-muted"><i class="fas fa-camera me-1"></i>${post.photos.length} photo(s)</small></div>` : ''}
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="showContactInfo('${post.phone}', '${post.userName}')">
                                            <i class="fas fa-phone me-2"></i>Contacter
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="startChat(${post.userId}, '${post.userName}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            generatePagination(pagination, page, totalPages, 'realestate');
        }

        async function displayJobsAnnounces(posts, page = 1) {
            const container = document.getElementById('jobs-container');
            const pagination = document.getElementById('jobs-pagination');
            if (!container) return;

            let filteredPosts = posts.filter(post => post.status === ANNOUNCE_STATUS.APPROVED);
            
            // Appliquer les filtres
            const typeFilter = document.getElementById('jobTypeFilter')?.value;
            const cityFilter = document.getElementById('jobCityFilter')?.value;
            const experienceFilter = document.getElementById('jobExperienceFilter')?.value;
            const sort = document.getElementById('jobSort')?.value;

            if (typeFilter) {
                filteredPosts = filteredPosts.filter(post => post.contrat === typeFilter);
            }
            if (cityFilter) {
                filteredPosts = filteredPosts.filter(post => post.ville === cityFilter);
            }
            if (experienceFilter) {
                // Filtre simplifié pour l'expérience
                filteredPosts = filteredPosts.filter(post => {
                    const exp = parseInt(post.experience) || 0;
                    const [min, max] = experienceFilter.split('-').map(e => e === '+' ? Infinity : parseInt(e));
                    if (max === Infinity) return exp >= min;
                    return exp >= min && exp <= max;
                });
            }

            // Trier
            if (sort === 'premium') {
                filteredPosts.sort((a, b) => (b.isPremium ? 1 : 0) - (a.isPremium ? 1 : 0));
            } else {
                filteredPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            // Pagination
            const totalPages = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const paginatedPosts = filteredPosts.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            let html = '';
            if (paginatedPosts.length === 0) {
                html = '<div class="col-12 text-center"><p class="text-muted">Aucune offre d\'emploi disponible pour le moment.</p></div>';
            } else {
                for (const post of paginatedPosts) {
                    const isOld = isAnnounceOld(post.createdAt);
                    const isFavorited = appState.currentUser ? 
                        await btpDB.isItemFavorited(appState.currentUser.id, post.id, 'job') : false;
                    
                    html += `
                        <div class="col-md-6">
                            <div class="card h-100 position-relative">
                                ${post.isPremium ? '<span class="premium-badge">⭐ PREMIUM</span>' : ''}
                                ${isOld && appState.isAdmin ? `
                                    <div class="admin-actions">
                                        <button class="btn btn-warning btn-sm admin-btn" onclick="pauseAnnounce(${post.id}, 'job')" title="Mettre en pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm admin-btn" onclick="deleteAnnounceAdmin(${post.id}, 'job')" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${post.id}, 'job')">
                                    <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <div class="card-body">
                                    <h5 class="card-title">${post.poste}</h5>
                                    <p class="text-muted">${post.description}</p>
                                    <p class="text-success fw-bold h5">${post.salaire}</p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="showContactInfo('${post.phone}', '${post.userName}')">
                                            <i class="fas fa-phone me-2"></i>Contacter
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="startChat(${post.userId}, '${post.userName}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            generatePagination(pagination, page, totalPages, 'jobs');
        }

        async function loadFreelancers() {
            try {
                const freelancers = await btpDB.get('freelancers');
                displayFreelancers(freelancers);
            } catch (error) {
                console.error('Erreur chargement freelancers:', error);
            }
        }

        async function displayFreelancers(freelancers, page = 1) {
            const container = document.getElementById('freelancers-container');
            const pagination = document.getElementById('freelancers-pagination');
            if (!container) return;

            let filteredFreelancers = freelancers.filter(f => f.status === ANNOUNCE_STATUS.APPROVED);
            
            // Appliquer les filtres
            const specialtyFilter = document.getElementById('freelancerSpecialtyFilter')?.value;
            const cityFilter = document.getElementById('freelancerCityFilter')?.value;
            const sort = document.getElementById('freelancerSort')?.value;

            if (specialtyFilter) {
                filteredFreelancers = filteredFreelancers.filter(f => f.specialty === specialtyFilter);
            }
            if (cityFilter) {
                filteredFreelancers = filteredFreelancers.filter(f => f.ville === cityFilter);
            }

            // Trier
            if (sort === 'rating') {
                filteredFreelancers.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (sort === 'premium') {
                filteredFreelancers.sort((a, b) => (b.isPremium ? 1 : 0) - (a.isPremium ? 1 : 0));
            } else {
                filteredFreelancers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            // Pagination
            const totalPages = Math.ceil(filteredFreelancers.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const paginatedFreelancers = filteredFreelancers.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            let html = '';
            if (paginatedFreelancers.length === 0) {
                html = '<div class="col-12 text-center"><p class="text-muted">Aucun freelance disponible pour le moment.</p></div>';
            } else {
                for (const freelancer of paginatedFreelancers) {
                    const isOld = isAnnounceOld(freelancer.createdAt);
                    const isFavorited = appState.currentUser ? 
                        await btpDB.isItemFavorited(appState.currentUser.id, freelancer.id, 'freelancers') : false;
                    
                    html += `
                        <div class="col-md-6">
                            <div class="card h-100 position-relative">
                                ${freelancer.isPremium ? '<span class="premium-badge">⭐ PREMIUM</span>' : ''}
                                ${isOld && appState.isAdmin ? `
                                    <div class="admin-actions">
                                        <button class="btn btn-warning btn-sm admin-btn" onclick="pauseAnnounce(${freelancer.id}, 'freelancers')" title="Mettre en pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm admin-btn" onclick="deleteAnnounceAdmin(${freelancer.id}, 'freelancers')" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${freelancer.id}, 'freelancers')">
                                    <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <div class="card-body">
                                    <h5 class="card-title">${freelancer.title}</h5>
                                    <p class="text-muted">${freelancer.description}</p>
                                    <p class="text-success fw-bold h5">${freelancer.tarif}</p>
                                    <div class="mb-2">
                                        <small class="text-muted">📍 ${freelancer.ville} • ${freelancer.experience}</small>
                                    </div>
                                    ${freelancer.rating ? `
                                        <div class="mb-2">
                                            <small class="text-warning">
                                                <i class="fas fa-star"></i> ${freelancer.rating}/5 (${freelancer.reviewCount} avis)
                                            </small>
                                        </div>
                                    ` : ''}
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="showContactInfo('${freelancer.phone}', '${freelancer.userName}')">
                                            <i class="fas fa-phone me-2"></i>Contacter
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="startChat(${freelancer.userId}, '${freelancer.userName}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            generatePagination(pagination, page, totalPages, 'freelancers');
        }

        async function loadProfessionals() {
            try {
                const professionals = await btpDB.get('professionals');
                displayProfessionals(professionals);
            } catch (error) {
                console.error('Erreur chargement professionnels:', error);
            }
        }

        function displayProfessionals(professionals, page = 1) {
            const container = document.getElementById('professionals-container');
            const pagination = document.getElementById('professionals-pagination');
            if (!container) return;

            let filteredProfessionals = [...professionals];
            
            // Appliquer les filtres
            const specialtyFilter = document.getElementById('filterSpecialty')?.value;
            const cityFilter = document.getElementById('filterCity')?.value;
            const experienceFilter = document.getElementById('filterExperience')?.value;

            if (specialtyFilter) {
                filteredProfessionals = filteredProfessionals.filter(prof => prof.specialty === specialtyFilter);
            }
            if (cityFilter) {
                filteredProfessionals = filteredProfessionals.filter(prof => prof.city === cityFilter);
            }
            if (experienceFilter) {
                filteredProfessionals = filteredProfessionals.filter(prof => prof.experience >= parseInt(experienceFilter));
            }

            // Pagination
            const totalPages = Math.ceil(filteredProfessionals.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const paginatedProfessionals = filteredProfessionals.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            let html = '';
            if (paginatedProfessionals.length === 0) {
                html = '<div class="col-12 text-center"><p class="text-muted">Aucun professionnel disponible pour le moment.</p></div>';
            } else {
                paginatedProfessionals.forEach(professional => {
                    html += `
                        <div class="col-md-6">
                            <div class="card professional-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title mb-0">${professional.company}</h5>
                                        <span class="badge bg-success">Certifié</span>
                                    </div>
                                    <p class="text-muted">📍 ${professional.city} • 🏆 ${professional.experience} ans d'expérience</p>
                                    <p class="card-text">${professional.description}</p>
                                    <div class="mb-3">
                                        <small class="text-muted">📞 ${professional.phone}</small><br>
                                        <small class="text-muted">⭐ ${professional.rating}/5 (${professional.reviewCount} avis)</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary flex-fill" onclick="showContactInfo('${professional.phone}', '${professional.company}')">
                                            <i class="fas fa-phone me-2"></i>Appeler
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="startChat(${professional.userId}, '${professional.company}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
            generatePagination(pagination, page, totalPages, 'professionals');
        }

        // ========== FONCTIONS ADMIN POUR ANNONCES ANCIENNES ==========
        function isAnnounceOld(createdAt) {
            const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return new Date(createdAt) < oneMonthAgo;
        }

        async function pauseAnnounce(announceId, type) {
            if (!appState.isAdmin) return;

            if (!confirm('Voulez-vous mettre cette annonce en pause ? Elle ne sera plus visible publiquement.')) {
                return;
            }

            try {
                const collection = getCollectionByType(type);
                await btpDB.put(collection, announceId, { status: ANNOUNCE_STATUS.PAUSED });
                showAlert('✅ Annonce mise en pause avec succès', 'success');
                
                // Recharger les annonces
                switch(type) {
                    case 'marketplace':
                        btpDB.get('marketplace_posts').then(posts => displayMarketplaceAnnounces(posts, 1));
                        break;
                    case 'realestate':
                        btpDB.get('realestate_posts').then(posts => displayRealestateAnnounces(posts, 1));
                        break;
                    case 'job':
                        btpDB.get('job_posts').then(posts => displayJobsAnnounces(posts, 1));
                        break;
                    case 'freelancers':
                        btpDB.get('freelancers').then(freelancers => displayFreelancers(freelancers, 1));
                        break;
                }

                // Recharger les stats admin
                loadAdminStats();
                
            } catch (error) {
                console.error('Erreur mise en pause annonce:', error);
                showAlert('❌ Erreur lors de la mise en pause', 'error');
            }
        }

        async function deleteAnnounceAdmin(announceId, type) {
            if (!appState.isAdmin) return;

            if (!confirm('Êtes-vous sûr de vouloir supprimer cette annonce ? Cette action est irréversible.')) {
                return;
            }

            try {
                const collection = getCollectionByType(type);
                const items = await btpDB.get(collection);
                const updatedItems = items.filter(item => item.id !== announceId);
                
                // Sauvegarder les modifications
                const localData = btpDB.getLocalData();
                localData[collection] = updatedItems;
                btpDB.saveLocalData(localData);
                
                showAlert('✅ Annonce supprimée avec succès !', 'success');
                
                // Recharger les annonces
                switch(type) {
                    case 'marketplace':
                        btpDB.get('marketplace_posts').then(posts => displayMarketplaceAnnounces(posts, 1));
                        break;
                    case 'realestate':
                        btpDB.get('realestate_posts').then(posts => displayRealestateAnnounces(posts, 1));
                        break;
                    case 'job':
                        btpDB.get('job_posts').then(posts => displayJobsAnnounces(posts, 1));
                        break;
                    case 'freelancers':
                        btpDB.get('freelancers').then(freelancers => displayFreelancers(freelancers, 1));
                        break;
                }

                // Recharger les stats admin
                loadAdminStats();
                
            } catch (error) {
                console.error('Erreur suppression annonce admin:', error);
                showAlert('❌ Erreur lors de la suppression', 'error');
            }
        }

        // ========== PAGINATION ==========
        function generatePagination(container, currentPage, totalPages, section) {
            if (!container || totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <nav aria-label="Pagination">
                    <ul class="pagination">
            `;

            // Bouton précédent
            if (currentPage > 1) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage('${section}', ${currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                `;
            }

            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage('${section}', ${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Bouton suivant
            if (currentPage < totalPages) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage('${section}', ${currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;
            }

            html += `
                    </ul>
                </nav>
            `;

            container.innerHTML = html;
        }

        function changePage(section, page) {
            appState.currentPage[section] = page;
            
            switch(section) {
                case 'marketplace':
                    btpDB.get('marketplace_posts').then(posts => displayMarketplaceAnnounces(posts, page));
                    break;
                case 'realestate':
                    btpDB.get('realestate_posts').then(posts => displayRealestateAnnounces(posts, page));
                    break;
                case 'jobs':
                    btpDB.get('job_posts').then(posts => displayJobsAnnounces(posts, page));
                    break;
                case 'freelancers':
                    btpDB.get('freelancers').then(freelancers => displayFreelancers(freelancers, page));
                    break;
                case 'professionals':
                    btpDB.get('professionals').then(professionals => displayProfessionals(professionals, page));
                    break;
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== FILTRES ==========
        function filterMarketplace() {
            btpDB.get('marketplace_posts').then(posts => {
                displayMarketplaceAnnounces(posts, 1);
            });
        }

        function filterRealEstate() {
            btpDB.get('realestate_posts').then(posts => {
                displayRealestateAnnounces(posts, 1);
            });
        }

        function filterJobs() {
            btpDB.get('job_posts').then(posts => {
                displayJobsAnnounces(posts, 1);
            });
        }

        function filterFreelancers() {
            btpDB.get('freelancers').then(freelancers => {
                displayFreelancers(freelancers, 1);
            });
        }

        function filterProfessionals() {
            btpDB.get('professionals').then(professionals => {
                displayProfessionals(professionals, 1);
            });
        }

        // ========== FORUM ==========
        async function loadForumTopics() {
            try {
                const topics = await btpDB.get('forum_topics');
                displayForumTopics(topics);
            } catch (error) {
                console.error('Erreur chargement forum:', error);
            }
        }

        function displayForumTopics(topics) {
            const container = document.getElementById('forum-topics-container');
            if (!container) return;

            let html = '';
            if (topics.length === 0) {
                html = `
                    <div class="text-center p-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h4>Aucun sujet de discussion</h4>
                        <p class="text-muted">Soyez le premier à lancer une discussion !</p>
                        <button class="btn btn-primary mt-3" onclick="showForumCreate()">
                            <i class="fas fa-plus me-2"></i>Créer un sujet
                        </button>
                    </div>
                `;
            } else {
                topics.forEach(topic => {
                    html += `
                        <div class="forum-topic p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">
                                        <a href="#" onclick="viewForumTopic(${topic.id})" class="text-decoration-none">${topic.title}</a>
                                        <span class="badge bg-secondary topic-badge">${topic.category}</span>
                                    </h5>
                                    <p class="text-muted mb-2">${topic.content.substring(0, 150)}...</p>
                                    <div class="d-flex text-muted small">
                                        <span class="me-3"><i class="fas fa-user me-1"></i>${topic.authorName}</span>
                                        <span class="me-3"><i class="fas fa-clock me-1"></i>${new Date(topic.createdAt).toLocaleDateString()}</span>
                                        <span><i class="fas fa-comment me-1"></i>${topic.replyCount || 0} réponses</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">${topic.viewCount || 0} vues</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function filterForum(category) {
            // Mettre à jour les boutons actifs
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filtrer les sujets (implémentation simplifiée)
            showAlert(`Filtrage des sujets par catégorie: ${category}`, 'info');
        }

        function searchForum() {
            const searchTerm = document.getElementById('forumSearch').value;
            if (searchTerm) {
                showAlert(`Recherche dans le forum: "${searchTerm}"`, 'info');
            }
        }

        function viewForumTopic(topicId) {
            showAlert(`Ouverture du sujet #${topicId} - Fonctionnalité à venir!`, 'info');
        }

        function showForumCreate() {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour créer un sujet de discussion', 'warning');
                showLoginModal();
                return;
            }
            goToSection('forum-create');
        }

        async function createForumTopic(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Veuillez vous connecter', 'error');
                return;
            }

            const title = document.getElementById('forumTopicTitle').value;
            const category = document.getElementById('forumTopicCategory').value;
            const content = document.getElementById('forumTopicContent').value;

            if (!title || !category || !content) {
                showAlert('Veuillez remplir tous les champs', 'error');
                return;
            }

            showLoading(true);

            try {
                const topicData = {
                    title: title,
                    category: category,
                    content: content,
                    authorId: appState.currentUser.id,
                    authorName: appState.currentUser.prenom + ' ' + appState.currentUser.nom,
                    replyCount: 0,
                    viewCount: 0,
                    status: ANNOUNCE_STATUS.APPROVED,
                    createdAt: new Date().toISOString()
                };

                await btpDB.post('forum_topics', topicData);
                
                showAlert('✅ Votre sujet a été créé avec succès !', 'success');
                
                document.getElementById('forumTopicForm').reset();
                goToSection('forum');
                loadForumTopics();
                
            } catch (error) {
                showAlert('Erreur lors de la création du sujet', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== UPLOAD PHOTOS ==========
        function handlePhotoUpload(input, type) {
            const files = Array.from(input.files);
            const previewId = type + 'PhotoPreview';
            const preview = document.getElementById(previewId);
            
            // Limiter à 5 photos
            if (files.length > 5) {
                showAlert('Maximum 5 photos autorisées', 'error');
                files.splice(5);
            }
            
            // Vérifier la taille des fichiers
            const oversized = files.filter(file => file.size > 2 * 1024 * 1024);
            if (oversized.length > 0) {
                showAlert('Certains fichiers dépassent 2MB', 'error');
                return;
            }
            
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'photo-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="photo-remove" onclick="removePhoto(this, '${type}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
            
            // Réinitialiser l'input pour permettre la sélection des mêmes fichiers
            input.value = '';
        }

        function removePhoto(button, type) {
            const previewItem = button.parentElement;
            previewItem.remove();
        }

        // ========== MESSAGERIE ==========
        function toggleMessaging() {
            // VÉRIFIER si l'utilisateur est connecté
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour accéder à la messagerie', 'warning');
                showLoginModal();
                return;
            }
            
            const container = document.getElementById('messagingContainer');
            if (container.style.display === 'flex') {
                container.style.display = 'none';
            } else {
                container.style.display = 'flex';
                loadContactsList();
            }
        }

        async function loadContactsList() {
            const contactsList = document.getElementById('contactsList');
            const users = await btpDB.get('users');
            
            let html = '';
            users.forEach(user => {
                if (user.id !== appState.currentUser?.id) {
                    html += `
                        <div class="contact-item" onclick="startChat(${user.id}, '${user.prenom} ${user.nom}')">
                            <div class="d-flex align-items-center">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px;">
                                    ${user.prenom.charAt(0)}${user.nom.charAt(0)}
                                </div>
                                <div>
                                    <strong>${user.prenom} ${user.nom}</strong>
                                    <div class="small text-muted">${user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            contactsList.innerHTML = html || '<div class="text-center p-3 text-muted">Aucun contact disponible</div>';
        }

        function startChat(userId, userName) {
            // VÉRIFICATION DE SÉCURITÉ
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour envoyer un message', 'warning');
                showLoginModal();
                return;
            }

            currentChat = { userId, userName };
            const container = document.getElementById('messagingContainer');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.chat-input button');

            // Activer la messagerie si fermée
            if (container && container.style.display !== 'flex') {
                container.style.display = 'flex';
            }

            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = `Message à ${userName}...`;
            }
            
            if (sendButton) {
                sendButton.disabled = false;
            }

            loadChatMessages(userId);
            
            // Mettre en surbrillance le contact sélectionné
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Trouver et activer le contact cliqué
            const contactItems = document.querySelectorAll('.contact-item');
            contactItems.forEach(item => {
                if (item.textContent.includes(userName)) {
                    item.classList.add('active');
                }
            });
        }

        async function loadChatMessages(userId) {
            const messagesContainer = document.getElementById('chatMessages');
            const messages = await btpDB.get('messages');
            
            const chatMessages = messages.filter(msg => 
                (msg.senderId === appState.currentUser.id && msg.receiverId === userId) ||
                (msg.senderId === userId && msg.receiverId === appState.currentUser.id)
            );

            let html = '';
            if (chatMessages.length === 0) {
                html = '<div class="text-center text-muted py-4">Aucun message échangé</div>';
            } else {
                chatMessages.forEach(msg => {
                    const isSent = msg.senderId === appState.currentUser.id;
                    html += `
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            <div>${msg.content}</div>
                            <div class="message-time">${new Date(msg.createdAt).toLocaleTimeString()}</div>
                        </div>
                    `;
                });
            }

            messagesContainer.innerHTML = html;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            if (!currentChat || !appState.currentUser) return;

            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) return;

            await btpDB.post('messages', {
                senderId: appState.currentUser.id,
                senderName: appState.currentUser.prenom,
                receiverId: currentChat.userId,
                receiverName: currentChat.userName,
                content: content
            });

            messageInput.value = '';
            loadChatMessages(currentChat.userId);
        }

        // ========== FONCTIONS DE CONTACT ==========
        function showContactInfo(phone, name) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour voir les coordonnées', 'warning');
                showLoginModal();
                return;
            }
            
            showAlert(`📞 Contact: ${name}<br> Téléphone: ${phone}`, 'info');
        }

        // ========== PUBLICATION ==========
        function showPublishForm(type) {
            document.querySelectorAll('.publish-form').forEach(form => {
                form.style.display = 'none';
            });
            
            const targetForm = document.getElementById(type + '-form');
            if (targetForm) {
                targetForm.style.display = 'block';
            }
            
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function handlePublishMarketplace(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Veuillez vous connecter', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const announceData = {
                title: formData.get('title'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                unit: formData.get('unit'),
                category: formData.get('category'),
                city: formData.get('city'),
                phone: formData.get('phone'),
                userId: appState.currentUser.id,
                userName: appState.currentUser.prenom + ' ' + appState.currentUser.nom,
                status: appState.isAdmin ? ANNOUNCE_STATUS.APPROVED : ANNOUNCE_STATUS.PENDING,
                isPremium: appState.currentUser.hasPremium || false,
                photos: [] // Les photos seraient uploadées vers un serveur en production
            };

            showLoading(true);

            try {
                // Vérifier si on est en mode édition
                if (window.editingAnnounceId) {
                    // Mettre à jour l'annonce existante
                    await btpDB.put('marketplace_posts', window.editingAnnounceId, announceData);
                    showAlert('✅ Annonce modifiée avec succès !', 'success');
                } else {
                    // Créer une nouvelle annonce
                    await btpDB.post('marketplace_posts', announceData);
                    showAlert(appState.isAdmin ? 
                        '✅ Annonce publiée avec succès !' : 
                        '✅ Votre annonce a été soumise ! Elle sera publiée après modération.', 
                        'success'
                    );
                }
                
                // Réinitialiser le formulaire
                event.target.reset();
                document.getElementById('marketplacePhotoPreview').innerHTML = '';
                
                // Réinitialiser le mode édition
                resetEditMode();
                
                // Rediriger vers le compte
                goToSection('my_account');

            } catch (error) {
                showAlert('Erreur lors de la publication', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handlePublishRealEstate(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Veuillez vous connecter', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const announceData = {
                title: formData.get('title'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                type: formData.get('type'),
                surface: formData.get('surface') ? parseInt(formData.get('surface')) : null,
                rooms: formData.get('rooms') ? parseInt(formData.get('rooms')) : null,
                address: formData.get('address'),
                phone: formData.get('phone'),
                userId: appState.currentUser.id,
                userName: appState.currentUser.prenom + ' ' + appState.currentUser.nom,
                status: appState.isAdmin ? ANNOUNCE_STATUS.APPROVED : ANNOUNCE_STATUS.PENDING,
                isPremium: appState.currentUser.hasPremium || false,
                photos: [] // Les photos seraient uploadées vers un serveur en production
            };

            showLoading(true);

            try {
                // Vérifier si on est en mode édition
                if (window.editingAnnounceId) {
                    // Mettre à jour l'annonce existante
                    await btpDB.put('realestate_posts', window.editingAnnounceId, announceData);
                    showAlert('✅ Annonce immobilière modifiée avec succès !', 'success');
                } else {
                    // Créer une nouvelle annonce
                    await btpDB.post('realestate_posts', announceData);
                    showAlert(appState.isAdmin ? 
                        '✅ Annonce immobilière publiée avec succès !' : 
                        '✅ Votre annonce immobilière a été soumise ! Elle sera publiée après modération.', 
                        'success'
                    );
                }
                
                // Réinitialiser le formulaire
                event.target.reset();
                document.getElementById('realestatePhotoPreview').innerHTML = '';
                
                // Réinitialiser le mode édition
                resetEditMode();
                
                // Rediriger vers le compte
                goToSection('my_account');

            } catch (error) {
                showAlert('Erreur lors de la publication', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handlePublishJob(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Veuillez vous connecter', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const announceData = {
                poste: formData.get('poste'),
                description: formData.get('description'),
                salaire: formData.get('salaire'),
                contrat: formData.get('contrat'),
                ville: formData.get('ville'),
                experience: formData.get('experience'),
                phone: formData.get('phone'),
                userId: appState.currentUser.id,
                userName: appState.currentUser.prenom + ' ' + appState.currentUser.nom,
                status: appState.isAdmin ? ANNOUNCE_STATUS.APPROVED : ANNOUNCE_STATUS.PENDING,
                isPremium: appState.currentUser.hasPremium || false
            };

            showLoading(true);

            try {
                // Vérifier si on est en mode édition
                if (window.editingAnnounceId) {
                    // Mettre à jour l'annonce existante
                    await btpDB.put('job_posts', window.editingAnnounceId, announceData);
                    showAlert('✅ Offre d\'emploi modifiée avec succès !', 'success');
                } else {
                    // Créer une nouvelle annonce
                    await btpDB.post('job_posts', announceData);
                    showAlert(appState.isAdmin ? 
                        '✅ Offre d\'emploi publiée avec succès !' : 
                        '✅ Votre offre d\'emploi a été soumise ! Elle sera publiée après modération.', 
                        'success'
                    );
                }
                
                // Réinitialiser le formulaire
                event.target.reset();
                
                // Réinitialiser le mode édition
                resetEditMode();
                
                // Rediriger vers le compte
                goToSection('my_account');

            } catch (error) {
                showAlert('Erreur lors de la publication', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handlePublishFreelance(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Veuillez vous connecter', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const announceData = {
                title: formData.get('title'),
                description: formData.get('description'),
                specialty: formData.get('specialty'),
                tarif: formData.get('tarif'),
                ville: formData.get('ville'),
                experience: formData.get('experience'),
                portfolio: formData.get('portfolio'),
                phone: formData.get('phone'),
                userId: appState.currentUser.id,
                userName: appState.currentUser.prenom + ' ' + appState.currentUser.nom,
                status: appState.isAdmin ? ANNOUNCE_STATUS.APPROVED : ANNOUNCE_STATUS.PENDING,
                isPremium: appState.currentUser.hasPremium || false,
                rating: 0,
                reviewCount: 0
            };

            showLoading(true);

            try {
                // Vérifier si on est en mode édition
                if (window.editingAnnounceId) {
                    // Mettre à jour l'annonce existante
                    await btpDB.put('freelancers', window.editingAnnounceId, announceData);
                    showAlert('✅ Service freelance modifié avec succès !', 'success');
                } else {
                    // Créer une nouvelle annonce
                    await btpDB.post('freelancers', announceData);
                    showAlert(appState.isAdmin ? 
                        '✅ Service freelance publié avec succès !' : 
                        '✅ Votre service freelance a été soumis ! Il sera publié après modération.', 
                        'success'
                    );
                }
                
                // Réinitialiser le formulaire
                event.target.reset();
                
                // Réinitialiser le mode édition
                resetEditMode();
                
                // Rediriger vers le compte
                goToSection('my_account');

            } catch (error) {
                showAlert('Erreur lors de la publication', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== ADMIN ==========
        async function loadAdminStats() {
            if (!appState.isAdmin) return;

            const [users, marketplace, realestate, jobs, freelancers, oldAnnounces] = await Promise.all([
                btpDB.get('users'),
                btpDB.get('marketplace_posts'),
                btpDB.get('realestate_posts'),
                btpDB.get('job_posts'),
                btpDB.get('freelancers'),
                btpDB.getOldAnnounces()
            ]);

            document.getElementById('stats-users').textContent = users.length;
            document.getElementById('stats-marketplace').textContent = marketplace.length;
            document.getElementById('stats-realestate').textContent = realestate.length;
            document.getElementById('stats-jobs').textContent = jobs.length;

            // Charger les statistiques utilisateurs détaillées
            await loadUsersStats(users);

            // Charger les emplacements Adsense
            loadAdsenseSlots();

            // Charger les utilisateurs
            loadUsersTable(users);
            
            // Charger les annonces anciennes
            loadOldAnnouncesTable(oldAnnounces);
            
            // Charger les annonces à modérer
            loadModerationTable([...marketplace, ...realestate, ...jobs, ...freelancers]);
        }

        async function loadUsersStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(u => !u.isBlocked).length;
            const premiumUsers = users.filter(u => u.hasPremium).length;
            const totalVisits = users.reduce((sum, user) => sum + (user.visitCount || 0), 0);

            document.getElementById('stats-total-users').textContent = totalUsers;
            document.getElementById('stats-active-users').textContent = activeUsers;
            document.getElementById('stats-premium-users').textContent = premiumUsers;
            document.getElementById('stats-total-visits').textContent = totalVisits;
        }

        async function loadAdsenseSlots() {
            const slots = await btpDB.getAdsenseSlots();
            const container = document.getElementById('adsense-slots-container');
            
            let html = '';
            slots.forEach(slot => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">${slot.name}</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Code Adsense</label>
                                <textarea class="form-control adsense-slot" data-slot-id="${slot.id}" rows="4" placeholder="Collez votre code Adsense ici...">${slot.code || ''}</textarea>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="saveAdsenseSlot('${slot.id}')">
                                <i class="fas fa-save me-1"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function saveAdsenseSlot(slotId) {
            const code = document.querySelector(`[data-slot-id="${slotId}"]`).value;
            await btpDB.saveAdsenseSlot(slotId, code);
            showAlert('Emplacement Adsense mis à jour', 'success');
        }

        function loadUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            let html = '';
            
            users.forEach(user => {
                const lastVisit = user.lastVisit ? new Date(user.lastVisit).toLocaleDateString('fr-FR') : 'Jamais';
                const visitCount = user.visitCount || 0;
                
                html += `
                    <tr>
                        <td>
                            <strong>${user.prenom} ${user.nom}</strong>
                            <br><small class="text-muted">${user.email}</small>
                        </td>
                        <td>
                            <small>📞 ${user.phone || 'Non renseigné'}</small>
                        </td>
                        <td>
                            <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-success'}">
                                ${user.role === 'admin' ? 'Admin' : 'Utilisateur'}
                            </span>
                            ${user.isBlocked ? '<span class="badge bg-warning ms-1">Bloqué</span>' : ''}
                            ${user.hasPremium ? '<span class="badge bg-info ms-1">Premium</span>' : ''}
                        </td>
                        <td>${new Date(user.createdAt).toLocaleDateString('fr-FR')}</td>
                        <td>${lastVisit}</td>
                        <td>
                            <span class="badge bg-primary">${visitCount} visites</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser(${user.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn ${user.isBlocked ? 'btn-success' : 'btn-warning'}" 
                                        onclick="toggleUserBlock(${user.id}, ${!user.isBlocked})">
                                    <i class="fas ${user.isBlocked ? 'fa-unlock' : 'fa-lock'}"></i>
                                </button>
                                <button class="btn ${user.hasPremium ? 'btn-secondary' : 'btn-info'}" 
                                        onclick="toggleUserPremium(${user.id}, ${!user.hasPremium})">
                                    <i class="fas ${user.hasPremium ? 'fa-crown' : 'fa-star'}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function loadOldAnnouncesTable(oldAnnounces) {
            const tbody = document.getElementById('old-announces-table-body');
            let html = '';
            
            if (oldAnnounces.length === 0) {
                html = '<tr><td colspan="6" class="text-center">Aucune annonce ancienne à gérer</td></tr>';
            } else {
                oldAnnounces.forEach(announce => {
                    const ageInDays = Math.floor((new Date() - new Date(announce.createdAt)) / (1000 * 60 * 60 * 24));
                    html += `
                        <tr>
                            <td>
                                <strong>${announce.title || announce.poste}</strong>
                                <br><small class="text-muted">${announce.description?.substring(0, 50)}...</small>
                            </td>
                            <td>
                                <span class="badge ${getAnnounceTypeBadge(announce)}">
                                    ${getAnnounceType(announce)}
                                </span>
                            </td>
                            <td>${announce.userName}</td>
                            <td>${new Date(announce.createdAt).toLocaleDateString()}</td>
                            <td>
                                <span class="badge bg-warning">${ageInDays} jours</span>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm me-1" onclick="pauseAnnounce(${announce.id}, '${announce.type}')">
                                    <i class="fas fa-pause me-1"></i>Pause
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAnnounceAdmin(${announce.id}, '${announce.type}')">
                                    <i class="fas fa-trash me-1"></i>Supprimer
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
        }

        async function toggleUserBlock(userId, block) {
            await btpDB.put('users', userId, { isBlocked: block });
            showAlert(`Utilisateur ${block ? 'bloqué' : 'débloqué'}`, 'success');
            loadAdminStats();
        }

        async function toggleUserPremium(userId, premium) {
            await btpDB.put('users', userId, { hasPremium: premium });
            showAlert(`Accès Premium ${premium ? 'accordé' : 'retiré'}`, 'success');
            loadAdminStats();
        }

        function editUser(userId) {
            showAlert(`Édition de l'utilisateur #${userId} - Fonctionnalité à venir!`, 'info');
        }

        function loadModerationTable(announces) {
            const tbody = document.getElementById('moderation-table-body');
            let html = '';
            
            const pendingAnnounces = announces.filter(announce => 
                announce.status === ANNOUNCE_STATUS.PENDING || 
                announce.status === ANNOUNCE_STATUS.REPORTED
            );
            
            if (pendingAnnounces.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Aucune annonce à modérer</td></tr>';
            } else {
                pendingAnnounces.forEach(announce => {
                    html += `
                        <tr>
                            <td>
                                <strong>${announce.title || announce.poste}</strong>
                                <br><small class="text-muted">${announce.description?.substring(0, 50)}...</small>
                            </td>
                            <td>
                                <span class="badge ${getAnnounceTypeBadge(announce)}">
                                    ${getAnnounceType(announce)}
                                </span>
                            </td>
                            <td>${announce.userName}</td>
                            <td>${new Date(announce.createdAt).toLocaleDateString()}</td>
                            <td>
                                <span class="badge ${getStatusBadge(announce.status)}">
                                    ${getStatusText(announce.status)}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAnnounceDetails(${announce.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success me-1" onclick="moderateAnnounce(${announce.id}, '${ANNOUNCE_STATUS.APPROVED}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="requestAnnounceEdit(${announce.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="moderateAnnounce(${announce.id}, '${ANNOUNCE_STATUS.REJECTED}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
        }

        function getAnnounceType(announce) {
            if (announce.category) return 'Marketplace';
            if (announce.type) return 'Immobilier';
            if (announce.poste) return 'Emploi';
            if (announce.specialty) return 'Freelance';
            return 'Autre';
        }

        function getAnnounceTypeBadge(announce) {
            if (announce.category) return 'bg-primary';
            if (announce.type) return 'bg-success';
            if (announce.poste) return 'bg-warning';
            if (announce.specialty) return 'bg-info';
            return 'bg-secondary';
        }

        function getStatusBadge(status) {
            switch(status) {
                case ANNOUNCE_STATUS.APPROVED: return 'bg-success';
                case ANNOUNCE_STATUS.PENDING: return 'bg-warning';
                case ANNOUNCE_STATUS.REJECTED: return 'bg-danger';
                case ANNOUNCE_STATUS.REPORTED: return 'bg-danger';
                case ANNOUNCE_STATUS.PAUSED: return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case ANNOUNCE_STATUS.APPROVED: return 'Approuvé';
                case ANNOUNCE_STATUS.PENDING: return 'En attente';
                case ANNOUNCE_STATUS.REJECTED: return 'Rejeté';
                case ANNOUNCE_STATUS.REPORTED: return 'Signalé';
                case ANNOUNCE_STATUS.PAUSED: return 'En pause';
                default: return status;
            }
        }

        async function moderateAnnounce(announceId, status) {
            // Chercher dans toutes les collections
            const collections = ['marketplace_posts', 'realestate_posts', 'job_posts', 'freelancers'];
            
            for (const collection of collections) {
                const items = await btpDB.get(collection);
                const item = items.find(i => i.id === announceId);
                
                if (item) {
                    await btpDB.put(collection, announceId, { status });
                    showAlert(`Annonce ${status === ANNOUNCE_STATUS.APPROVED ? 'approuvée' : 'rejetée'}`, 'success');
                    loadAdminStats();
                    return;
                }
            }
        }

        function viewAnnounceDetails(announceId) {
            showAlert(`Détails de l'annonce #${announceId} - Fonctionnalité à venir!`, 'info');
        }

        function requestAnnounceEdit(announceId) {
            showAlert(`Demande de modification pour l'annonce #${announceId} - Fonctionnalité à venir!`, 'info');
        }

        // ========== NEWSLETTER ==========
        function selectNewsletterTemplate(templateName) {
            document.querySelectorAll('.newsletter-template').forEach(tpl => {
                tpl.classList.remove('active');
            });
            event.target.classList.add('active');
            
            btpDB.getNewsletterTemplate(templateName).then(content => {
                document.getElementById('newsletterContent').value = content;
            });
        }

        async function sendNewsletter() {
            if (!appState.isAdmin) return;

            const content = document.getElementById('newsletterContent').value;
            if (!content) {
                showAlert('Veuillez saisir le contenu de la newsletter', 'error');
                return;
            }

            showLoading(true);
            
            // Simuler l'envoi
            setTimeout(() => {
                showLoading(false);
                showAlert('Newsletter envoyée à tous les adhérents !', 'success');
            }, 2000);
        }

        function scheduleNewsletter() {
            if (!appState.isAdmin) return;

            const content = document.getElementById('newsletterContent').value;
            if (!content) {
                showAlert('Veuillez saisir le contenu de la newsletter', 'error');
                return;
            }

            showAlert('Newsletter programmée pour envoi automatique', 'info');
        }

        // ========== FONCTIONS DE SAUVEGARDE DES ADHÉRENTS ==========
        function trackUserVisit() {
            if (appState.currentUser) {
                btpDB.incrementUserVisit(appState.currentUser.id);
            }
        }

        async function showBackupSettings() {
            if (!appState.isAdmin) {
                showAlert('Accès réservé aux administrateurs', 'error');
                return;
            }

            const settings = await btpDB.getBackupSettings();
            const history = await btpDB.getBackupHistory();

            // Remplir le formulaire
            document.getElementById('backupEnabled').checked = settings.enabled;
            document.getElementById('backupFrequency').value = settings.frequency;
            document.getElementById('backupEmail').value = settings.email;
            document.getElementById('includeCoordinates').checked = settings.includeCoordinates;
            document.getElementById('includeVisits').checked = settings.includeVisits;

            // Mettre à jour l'info de prochaine sauvegarde
            updateNextBackupInfo(settings);

            // Charger l'historique
            loadBackupHistory(history);

            backupSettingsModal.show();
        }

        function updateNextBackupInfo(settings) {
            const nextBackupInfo = document.getElementById('nextBackupInfo');
            if (!settings.enabled) {
                nextBackupInfo.innerHTML = '<i class="fas fa-pause me-2"></i>Sauvegarde automatique désactivée';
                nextBackupInfo.className = 'alert alert-warning';
                return;
            }

            let nextDate = new Date();
            switch(settings.frequency) {
                case 'daily':
                    nextDate.setDate(nextDate.getDate() + 1);
                    break;
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + (7 - nextDate.getDay() + 1) % 7 || 7);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    nextDate.setDate(1);
                    break;
            }

            nextBackupInfo.innerHTML = `
                <i class="fas fa-calendar me-2"></i>
                Prochaine sauvegarde: ${nextDate.toLocaleDateString('fr-FR')}
                ${settings.lastBackup ? `<br><small>Dernière sauvegarde: ${new Date(settings.lastBackup).toLocaleDateString('fr-FR')}</small>` : ''}
            `;
            nextBackupInfo.className = 'alert alert-success';
        }

        function loadBackupHistory(history) {
            const container = document.getElementById('backupHistoryList');
            let html = '';

            if (history.length === 0) {
                html = '<div class="text-center text-muted py-3">Aucune sauvegarde effectuée</div>';
            } else {
                history.forEach(backup => {
                    html += `
                        <div class="backup-history-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6>Sauvegarde du ${new Date(backup.timestamp).toLocaleDateString('fr-FR')}</h6>
                                    <div class="backup-stats">
                                        <span class="me-3">👥 ${backup.totalUsers} utilisateurs</span>
                                        <span class="me-3">✅ ${backup.activeUsers} actifs</span>
                                        <span class="me-3">⭐ ${backup.premiumUsers} premium</span>
                                        <span>📊 ${backup.totalVisits} visites totales</span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup(${backup.id})">
                                        <i class="fas fa-download me-1"></i>Télécharger
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        async function saveBackupSettings() {
            if (!appState.isAdmin) return;

            const settings = {
                enabled: document.getElementById('backupEnabled').checked,
                frequency: document.getElementById('backupFrequency').value,
                email: document.getElementById('backupEmail').value,
                includeCoordinates: document.getElementById('includeCoordinates').checked,
                includeVisits: document.getElementById('includeVisits').checked
            };

            await btpDB.saveBackupSettings(settings);
            showAlert('✅ Paramètres de sauvegarde enregistrés !', 'success');
            updateNextBackupInfo(settings);
        }

        async function createManualBackup() {
            if (!appState.isAdmin) return;

            showLoading(true);
            try {
                const backupData = await btpDB.createBackup();
                showAlert('✅ Sauvegarde créée avec succès !', 'success');
                
                // Recharger l'historique
                const history = await btpDB.getBackupHistory();
                loadBackupHistory(history);
                
                // Mettre à jour les paramètres
                const settings = await btpDB.getBackupSettings();
                updateNextBackupInfo(settings);

            } catch (error) {
                showAlert('❌ Erreur lors de la création de la sauvegarde', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function downloadUsersBackup() {
            if (!appState.isAdmin) return;

            showLoading(true);
            try {
                const users = await btpDB.getAllUsersWithDetails();
                const backupData = {
                    timestamp: new Date().toISOString(),
                    totalUsers: users.length,
                    activeUsers: users.filter(u => !u.isBlocked).length,
                    premiumUsers: users.filter(u => u.hasPremium).length,
                    totalVisits: users.reduce((sum, user) => sum + (user.visitCount || 0), 0),
                    users: users
                };

                // Créer un fichier CSV
                const csvContent = convertToCSV(backupData);
                downloadCSV(csvContent, `btp_pro_backup_${new Date().toISOString().split('T')[0]}.csv`);
                
                showAlert('✅ Backup téléchargé avec succès !', 'success');

            } catch (error) {
                showAlert('❌ Erreur lors du téléchargement du backup', 'error');
            } finally {
                showLoading(false);
            }
        }

        function convertToCSV(backupData) {
            const headers = ['ID', 'Prénom', 'Nom', 'Email', 'Téléphone', 'Rôle', 'Statut', 'Premium', 'Visites', 'Dernière visite', 'Date d\'inscription'];
            let csv = headers.join(';') + '\n';

            backupData.users.forEach(user => {
                const row = [
                    user.id,
                    user.prenom,
                    user.nom,
                    user.email,
                    user.phone,
                    user.role,
                    user.isBlocked ? 'Bloqué' : 'Actif',
                    user.hasPremium ? 'Oui' : 'Non',
                    user.visitCount,
                    user.lastVisit ? new Date(user.lastVisit).toLocaleDateString('fr-FR') : 'Jamais',
                    new Date(user.createdAt).toLocaleDateString('fr-FR')
                ];
                csv += row.join(';') + '\n';
            });

            return csv;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadBackup(backupId) {
            const history = await btpDB.getBackupHistory();
            const backup = history.find(b => b.id === backupId);
            
            if (backup) {
                const csvContent = convertToCSV(backup);
                downloadCSV(csvContent, `btp_pro_backup_${backup.timestamp.split('T')[0]}.csv`);
                showAlert('✅ Backup téléchargé avec succès !', 'success');
            }
        }

        // ========== FONCTIONS UTILITAIRES ==========
        function showAlert(message, type = 'success') {
            const alert = document.querySelector('.message-alert');
            const alertMessage = alert.querySelector('.alert-message');
            
            alertMessage.innerHTML = message;
            alert.className = `alert alert-${type === 'error' ? 'danger' : type} message-alert`;
            alert.style.display = 'block';
            
            setTimeout(() => alert.style.display = 'none', 4000);
        }

        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function showLoginModal() {
            loginModal.show();
        }

        function showRegisterModal() {
            registerModal.show();
        }

        function showProfessionalModal() {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour devenir professionnel certifié', 'warning');
                showLoginModal();
                return;
            }
            showAlert('Fonctionnalité "Devenir Professionnel" bientôt disponible!', 'info');
        }

        function switchToRegister() {
            loginModal.hide();
            setTimeout(() => registerModal.show(), 300);
        }

        function switchToLogin() {
            registerModal.hide();
            setTimeout(() => loginModal.show(), 300);
        }

        function changeTheme(theme) {
            appState.theme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            showAlert(`Thème ${theme} appliqué !`, 'info');
        }

        function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value || document.getElementById('globalSearchMobile').value;
            if (searchTerm) {
                showAlert(`Recherche pour: "${searchTerm}" - Fonctionnalité avancée à venir!`, 'info');
            }
        }

        function selectSubscription(plan) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour souscrire à un abonnement Premium', 'warning');
                showLoginModal();
                return;
            }
            showAlert(`Abonnement ${plan} sélectionné - Fonctionnalité de paiement à venir!`, 'success');
        }

        function changePassword(event) {
            event.preventDefault();
            showAlert('🔒 Fonctionnalité de changement de mot de passe à venir !', 'info');
        }

        // ========== INITIALISATION DU THÈME ==========
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }
        initializeTheme();

    </script>
</body>
</html>
