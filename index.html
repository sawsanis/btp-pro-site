<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTP Pro Maroc - Plateforme Professionnelle BTP Marocaine</title>
    
    <!-- CDN Links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* Votre CSS existant reste inchangé */
        :root {
            --primary-color: #0a5cb8;
            --secondary-color: #ff7710;
            --dark-color: #2d3a4a;
            --light-color: #f8f9fa;
            --text-color: #333333;
            --morocco-red: #c1272d;
            --morocco-green: #006233;
            --morocco-gold: #d4af37;
        }
        
        [data-theme="dark"] {
            --primary-color: #1e88e5;
            --secondary-color: #ff9800;
            --dark-color: #121212;
            --light-color: #1e1e1e;
            --text-color: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            padding-top: 80px;
            transition: all 0.3s ease;
        }
        
        .navbar {
            background-color: var(--light-color) !important;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .nav-link {
            color: var(--text-color) !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-link.active {
            color: var(--primary-color) !important;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .hero-banner {
            background: 
                linear-gradient(135deg, var(--primary-color), var(--secondary-color)),
                url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-blend-mode: overlay;
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
            position: relative;
        }
        
        .section-content {
            display: none;
        }
        
        .section-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .message-alert {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1060;
            display: none;
            min-width: 300px;
        }
        
        .card {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid #dee2e6;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 4rem;
        }
        
        .footer a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        
        .footer a:hover {
            color: white;
        }
        
        [data-theme="dark"] .navbar {
            background-color: var(--dark-color) !important;
            border-bottom: 1px solid #444;
        }
        
        [data-theme="dark"] .card {
            background-color: var(--dark-color);
            border-color: #444;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .global-search-container {
            position: relative;
            width: 700px;
            margin: 0 20px;
        }

        .global-search-container .input-group {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 50px;
            overflow: hidden;
        }

        .global-search-container .form-control {
            border-radius: 50px 0 0 50px;
            padding: 12px 25px;
            border: 2px solid var(--primary-color);
            border-right: none;
            font-size: 1rem;
            width: 100%;
        }

        .global-search-container .btn {
            border-radius: 0 50px 50px 0;
            padding: 12px 30px;
            background: var(--primary-color);
            border: 2px solid var(--primary-color);
            min-width: 120px;
            cursor: pointer;
        }

        .btn {
            cursor: pointer;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .favorite-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: #ff4757;
        }

        /* Messagerie améliorée */
        .messaging-container {
            position: fixed;
            bottom: 80px;
            right: 30px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            border: 1px solid #dee2e6;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message.received {
            background-color: #e9ecef;
            color: var(--text-color);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }

        /* Liste des contacts */
        .contacts-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .contact-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .contact-item:hover {
            background: #f8f9fa;
        }

        .contact-item.active {
            background: var(--primary-color);
            color: white;
        }

        /* Section construction */
        .construction-section {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin: 2rem 0;
        }

        .construction-icon {
            font-size: 4rem;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
        }

        /* Pub Adsense */
        .adsense-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .adsense-placeholder {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Admin */
        .admin-stats-card {
            transition: transform 0.3s ease;
        }

        .admin-stats-card:hover {
            transform: translateY(-5px);
        }

        .admin-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Newsletter */
        .newsletter-template {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .newsletter-template:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .newsletter-template.active {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        /* Forum */
        .forum-category {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .forum-topic {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
            transition: background 0.2s ease;
        }

        .forum-topic:hover {
            background: #f8f9fa;
        }

        .topic-badge {
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .premium-card {
            border: 2px solid var(--primary-color);
            transform: scale(1.05);
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Upload photos */
        .photo-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-container:hover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }

        .photo-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Premium badge */
        .premium-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Section Mon Compte */
        .account-sidebar {
            background: var(--light-color);
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .account-sidebar .nav-link {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            color: var(--text-color);
            border-radius: 0;
        }

        .account-sidebar .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-bottom: 1px solid var(--primary-color);
        }

        .account-sidebar .nav-link:last-child {
            border-bottom: none;
        }

        .account-content {
            background: var(--light-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .announce-status-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d1edff;
            color: #004085;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-paused {
            background: #e2e3e5;
            color: #383d41;
        }

        .account-section {
            display: none;
        }

        .account-section.active {
            display: block;
        }

        /* Logo en construction */
        .construction-logo {
            max-width: 200px;
            margin: 0 auto 2rem;
            display: block;
        }

        /* Optimisation de la barre de recherche */
        .search-container-mobile {
            display: none;
            margin: 10px 0;
        }

        /* Boutons admin */
        .admin-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .card:hover .admin-actions {
            display: block;
        }

        .admin-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* Classes utilitaires Maroc */
        .text-morocco-red { color: var(--morocco-red); }
        .text-morocco-green { color: var(--morocco-green); }
        .bg-morocco-green { background-color: var(--morocco-green); }
        .border-morocco-gold { border-color: var(--morocco-gold); }

        /* Backup styles */
        .backup-history-item {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .backup-stats {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Import/Export styles */
        .json-actions {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin: 20px 0;
        }

        .json-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .json-section h6 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .json-checkbox {
            margin-right: 8px;
        }

        @media (max-width: 1200px) {
            .global-search-container {
                width: 500px;
            }
        }

        @media (max-width: 992px) {
            .global-search-container {
                width: 400px;
                margin: 10px 0;
            }
        }

        @media (max-width: 768px) {
            .hero-banner {
                padding: 60px 0;
            }
            
            .hero-banner h1 {
                font-size: 2rem;
            }
            
            .global-search-container {
                display: none;
            }

            .search-container-mobile {
                display: block;
            }

            .messaging-container {
                width: 95vw;
                height: 70vh;
                bottom: 20px;
                right: 2.5vw;
            }

            .premium-card {
                transform: none;
                margin-bottom: 1rem;
            }

            .navbar-nav {
                text-align: center;
            }

            .nav-link {
                padding: 10px 0;
            }

            .account-sidebar {
                margin-bottom: 2rem;
            }

            .admin-actions {
                position: static;
                display: block;
                margin-top: 10px;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Overlay de chargement -->
    <div class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Chargement...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" onclick="goToSection('home')">
                <i class="fas fa-hard-hat me-2"></i>BTP Pro <span>🇲🇦</span>
            </a>
            
            <!-- Barre de recherche mobile -->
            <div class="search-container-mobile d-lg-none">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="🔍 Rechercher..." id="globalSearchMobile">
                    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Barre de recherche desktop -->
            <div class="global-search-container d-none d-lg-block">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="🔍 Rechercher des matériaux, emplois, professionnels..." id="globalSearch">
                    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
                        <i class="fas fa-search me-2"></i>Rechercher
                    </button>
                </div>
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="goToSection('home')">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('marketplace')">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('realestate')">Immobilier</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('jobs')">Emploi</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('freelancers')">Freelancers</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('professionals')">Professionnels</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('forum')">Forum</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('ai')">Assistant IA</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('premium')">Premium</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToSection('favorites')">Favoris</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="goToPublish()"><i class="fas fa-plus-circle me-1"></i>Publier</a></li>
                    <li class="nav-item d-none" id="admin-nav-item"><a class="nav-link" href="#" onclick="goToSection('admin')">Admin</a></li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <!-- Bouton Messagerie -->
                    <button class="btn btn-outline-primary me-2 position-relative" type="button" onclick="toggleMessaging()" id="messagingBtn">
                        <i class="fas fa-comments"></i>
                    </button>

                    <div class="dropdown me-3">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-palette"></i> Thème
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeTheme('light')">Clair</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeTheme('dark')">Sombre</a></li>
                        </ul>
                    </div>
                    
                    <div class="d-flex" id="auth-buttons">
                        <button class="btn btn-outline-primary me-2" type="button" onclick="showLoginModal()">Connexion</button>
                        <button class="btn btn-primary" type="button" onclick="showRegisterModal()">Inscription</button>
                    </div>

                    <div class="d-flex align-items-center d-none" id="user-menu">
                        <div class="user-avatar me-2 position-relative">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                <span id="user-initials">MA</span>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="user-name">Utilisateur</span>
                                <span id="admin-badge" class="admin-badge d-none">ADMIN</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="goToSection('my_account')"><i class="fas fa-user me-2"></i>Mon Compte</a></li>
                                <li><a class="dropdown-item" href="#" onclick="goToSection('favorites')"><i class="fas fa-heart me-2"></i>Mes favoris</a></li>
                                <li id="admin-menu-item" class="d-none"><a class="dropdown-item" href="#" onclick="goToSection('admin')"><i class="fas fa-cog me-2"></i>Administration</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Déconnexion</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Message Alert -->
    <div class="alert alert-success message-alert">
        <i class="fas fa-check-circle me-2"></i> <span class="alert-message">Opération réussie!</span>
    </div>

    <!-- Messagerie améliorée -->
    <div class="messaging-container" id="messagingContainer">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-comments me-2"></i>Messagerie
            </h6>
            <button class="btn btn-sm btn-light" type="button" onclick="toggleMessaging()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Liste des contacts -->
        <div class="p-3 border-bottom">
            <h6 class="mb-2">Contacts</h6>
            <div class="contacts-list" id="contactsList">
                <!-- Contacts chargés dynamiquement -->
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                Sélectionnez un contact pour commencer à discuter
            </div>
        </div>
        <div class="chat-input">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Tapez votre message..." id="messageInput" disabled>
                <button class="btn btn-primary" type="button" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Connexion -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Connexion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required placeholder="votre@email.com">
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="loginPassword" required placeholder="Votre mot de passe">
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="handleLogin()">
                            <i class="fas fa-sign-in-alt me-2"></i>Se connecter
                        </button>
                    </form>
                    <hr>
                    <div class="text-center">
                        <p class="mb-2">Vous n'avez pas de compte ?</p>
                        <button type="button" class="btn btn-outline-primary" onclick="switchToRegister()">
                            Créer un compte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'Inscription -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Inscription
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registerPrenom" class="form-label">Prénom</label>
                                <input type="text" class="form-control" id="registerPrenom" required placeholder="Votre prénom">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registerNom" class="form-label">Nom</label>
                                <input type="text" class="form-control" id="registerNom" required placeholder="Votre nom">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required 
                                   placeholder="votre@email.com" onblur="validateEmailField(this)">
                            <div class="invalid-feedback" id="emailError">
                                Format d'email invalide
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPhone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="registerPhone" placeholder="+212 XX XX XX XX">
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="registerPassword" required placeholder="Minimum 6 caractères">
                        </div>
                        <div class="mb-3">
                            <label for="registerConfirmPassword" class="form-label">Confirmer le mot de passe</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" required placeholder="Confirmez votre mot de passe">
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="handleRegister()">
                            <i class="fas fa-user-plus me-2"></i>Créer mon compte
                        </button>
                    </form>
                    <hr>
                    <div class="text-center">
                        <p class="mb-2">Vous avez déjà un compte ?</p>
                        <button type="button" class="btn btn-outline-primary" onclick="switchToLogin()">
                            Se connecter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Paramètres Sauvegarde -->
    <div class="modal fade" id="backupSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2"></i>Paramètres de Sauvegarde Automatique
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="backupSettingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Activer la sauvegarde automatique</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled">
                                        <label class="form-check-label" for="backupEnabled">Sauvegarde automatique activée</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Fréquence d'envoi</label>
                                    <select class="form-select" id="backupFrequency">
                                        <option value="weekly">Hebdomadaire (chaque lundi)</option>
                                        <option value="monthly">Mensuelle (1er du mois)</option>
                                        <option value="daily">Quotidienne</option>
                                        <option value="manual">Manuelle uniquement</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="backupEmail" class="form-label">Email de réception</label>
                                    <input type="email" class="form-control" id="backupEmail" 
                                           placeholder="admin@btp.ma" required>
                                    <div class="form-text">L'adresse email où seront envoyées les sauvegardes</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeCoordinates" checked>
                                        <label class="form-check-label" for="includeCoordinates">
                                            Inclure les coordonnées complètes
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeVisits" checked>
                                        <label class="form-check-label" for="includeVisits">
                                            Inclure les statistiques de visites
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Prochaine sauvegarde automatique</label>
                            <div class="alert alert-info" id="nextBackupInfo">
                                Calcul en cours...
                            </div>
                        </div>
                        
                        <!-- Historique des sauvegardes -->
                        <div class="mb-3">
                            <label class="form-label">Historique des sauvegardes</label>
                            <div id="backupHistoryList" class="backup-history-container">
                                <!-- Historique chargé dynamiquement -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="saveBackupSettings()">
                        <i class="fas fa-save me-2"></i>Enregistrer les paramètres
                    </button>
                    <button type="button" class="btn btn-success" onclick="createManualBackup()">
                        <i class="fas fa-download me-2"></i>Sauvegarder maintenant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Import JSON -->
    <div class="modal fade" id="importJsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-file-import me-2"></i>Importer des données JSON
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Sélectionnez un fichier JSON exporté depuis BTP Pro pour restaurer les données.
                    </div>
                    
                    <div class="mb-3">
                        <label for="jsonFileInput" class="form-label">Fichier JSON</label>
                        <input type="file" class="form-control" id="jsonFileInput" accept=".json">
                        <div class="form-text">Format accepté: .json (export BTP Pro)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Options d'importation</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="importOverwrite" checked>
                            <label class="form-check-label" for="importOverwrite">
                                Remplacer les données existantes
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="importBackup" checked>
                            <label class="form-check-label" for="importBackup">
                                Créer une sauvegarde avant importation
                            </label>
                        </div>
                    </div>
                    
                    <div id="importPreview" class="d-none">
                        <h6>Aperçu des données à importer:</h6>
                        <div class="json-section">
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importUsers" checked>
                                <label class="form-check-label" for="importUsers">
                                    Utilisateurs (<span id="previewUsers">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importMarketplace" checked>
                                <label class="form-check-label" for="importMarketplace">
                                    Annonces Marketplace (<span id="previewMarketplace">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importRealEstate" checked>
                                <label class="form-check-label" for="importRealEstate">
                                    Annonces Immobilier (<span id="previewRealEstate">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importJobs" checked>
                                <label class="form-check-label" for="importJobs">
                                    Offres d'emploi (<span id="previewJobs">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importFreelancers" checked>
                                <label class="form-check-label" for="importFreelancers">
                                    Freelancers (<span id="previewFreelancers">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importProfessionals" checked>
                                <label class="form-check-label" for="importProfessionals">
                                    Professionnels (<span id="previewProfessionals">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importMessages" checked>
                                <label class="form-check-label" for="importMessages">
                                    Messages (<span id="previewMessages">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importFavorites" checked>
                                <label class="form-check-label" for="importFavorites">
                                    Favoris (<span id="previewFavorites">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importForum" checked>
                                <label class="form-check-label" for="importForum">
                                    Forum (<span id="previewForum">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input json-checkbox" type="checkbox" id="importSettings" checked>
                                <label class="form-check-label" for="importSettings">
                                    Paramètres admin (<span id="previewSettings">0</span>)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-warning" id="importJsonBtn" disabled onclick="importJsonData()">
                        <i class="fas fa-file-import me-2"></i>Importer les données
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <main class="container main-content">
        
        <!-- SECTION ACCUEIL -->
        <section id="home-section" class="section-content active">
            <div class="hero-banner">
                <div class="container">
                    <h1 class="display-3 fw-bold mb-4">BTP Pro <span>🇲🇦</span></h1>
                    <p class="lead mb-4">La plateforme de référence des professionnels du BTP marocain</p>
                    
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <button class="btn btn-light btn-lg" type="button" onclick="goToSection('marketplace')">
                            <i class="fas fa-shopping-cart me-2"></i>Découvrir la Marketplace
                        </button>
                        <button class="btn btn-outline-light btn-lg" type="button" onclick="goToSection('jobs')">
                            <i class="fas fa-briefcase me-2"></i>Voir les offres d'emploi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Services -->
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Nos Services au Maroc</h2>
                <div class="row g-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('marketplace')">
                            <div class="card-body">
                                <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Marketplace BTP</h5>
                                <p class="text-muted">Matériaux, équipements et fournitures</p>
                                <button class="btn btn-outline-primary btn-sm mt-2" type="button" onclick="goToSection('marketplace')">Accéder</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('realestate')">
                            <div class="card-body">
                                <i class="fas fa-home fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Immobilier</h5>
                                <p class="text-muted">Biens, terrains et projets</p>
                                <button class="btn btn-outline-success btn-sm mt-2" type="button" onclick="goToSection('realestate')">Explorer</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('jobs')">
                            <div class="card-body">
                                <i class="fas fa-briefcase fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Emploi & Carrière</h5>
                                <p class="text-muted">Offres d'emploi et recrutement</p>
                                <button class="btn btn-outline-warning btn-sm mt-2" type="button" onclick="goToSection('jobs')">Voir les offres</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card text-center h-100" onclick="goToSection('freelancers')">
                            <div class="card-body">
                                <i class="fas fa-palette fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Freelancers</h5>
                                <p class="text-muted">Talents créatifs et techniques</p>
                                <button class="btn btn-outline-info btn-sm mt-2" type="button" onclick="goToSection('freelancers')">Découvrir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ déplacée ici -->
            <div class="container my-5">
                <h2 class="text-center mb-5">Foire Aux Questions</h2>
                
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                Comment publier une annonce ?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Cliquez sur "Publier" dans le menu, choisissez le type d'annonce et remplissez le formulaire. Vos annonces seront visibles après modération.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                Comment contacter un professionnel ?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Rendez-vous dans la section "Professionnels", trouvez l'artisan qui vous intéresse et cliquez sur "Contacter". Vous pourrez ensuite discuter via notre messagerie sécurisée.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                Comment devenir membre Premium ?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Rendez-vous dans la section "Premium" et choisissez l'abonnement qui vous convient. Les avantages Premium incluent la mise en avant de vos annonces et des statistiques détaillées.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pub Adsense -->
            <div class="adsense-container">
                <div class="adsense-placeholder">
                    <i class="fas fa-ad fa-3x mb-3"></i>
                    <h5>Espace Publicitaire BTP</h5>
                    <p>Votre annonce pour les professionnels du bâtiment</p>
                    <small>Code Adsense à intégrer depuis le panel admin</small>
                </div>
            </div>
        </section>

        <!-- SECTION MARKETPLACE -->
        <section id="marketplace-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Marketplace BTP</h2>
                    <button class="btn btn-primary" type="button" onclick="checkAuthAndGo('publish', 'marketplace')">
                        <i class="fas fa-plus me-2"></i>Publier un produit
                    </button>
                </div>
                
                <!-- Filtres et recherche -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceCategoryFilter" onchange="filterMarketplace()">
                            <option value="">Toutes les catégories</option>
                            <!-- Catégories chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceCityFilter" onchange="filterMarketplace()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="marketplaceSort" onchange="filterMarketplace()">
                            <option value="newest">Plus récent</option>
                            <option value="price_asc">Prix croissant</option>
                            <option value="price_desc">Prix décroissant</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="marketplace-container">
                    <!-- Produits chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="marketplace-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION IMMOBILIER -->
        <section id="realestate-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Immobilier au Maroc</h2>
                    <button class="btn btn-success" type="button" onclick="checkAuthAndGo('publish', 'immobilier')">
                        <i class="fas fa-plus me-2"></i>Publier une annonce
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="realestateTypeFilter" onchange="filterRealEstate()">
                            <option value="">Tous les types</option>
                            <option value="villa">Villa</option>
                            <option value="appartement">Appartement</option>
                            <option value="terrain">Terrain</option>
                            <option value="local">Local commercial</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestateCityFilter" onchange="filterRealEstate()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestatePriceFilter" onchange="filterRealEstate()">
                            <option value="">Tous les prix</option>
                            <option value="0-500000">Moins de 500K MAD</option>
                            <option value="500000-1000000">500K - 1M MAD</option>
                            <option value="1000000-2000000">1M - 2M MAD</option>
                            <option value="2000000+">Plus de 2M MAD</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="realestateSort" onchange="filterRealEstate()">
                            <option value="newest">Plus récent</option>
                            <option value="price_asc">Prix croissant</option>
                            <option value="price_desc">Prix décroissant</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="realestate-container">
                    <!-- Biens chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="realestate-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION EMPLOI -->
        <section id="jobs-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Emploi BTP</h2>
                    <button class="btn btn-warning" type="button" onclick="checkAuthAndGo('publish', 'emploi')">
                        <i class="fas fa-plus me-2"></i>Publier une offre
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="jobTypeFilter" onchange="filterJobs()">
                            <option value="">Tous les contrats</option>
                            <option value="cdi">CDI</option>
                            <option value="cdd">CDD</option>
                            <option value="freelance">Freelance</option>
                            <option value="stage">Stage</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobCityFilter" onchange="filterJobs()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobExperienceFilter" onchange="filterJobs()">
                            <option value="">Toutes expériences</option>
                            <option value="0-2">0-2 ans</option>
                            <option value="2-5">2-5 ans</option>
                            <option value="5-10">5-10 ans</option>
                            <option value="10+">10+ ans</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobSort" onchange="filterJobs()">
                            <option value="newest">Plus récent</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="jobs-container">
                    <!-- Offres chargées dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="jobs-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION FREELANCERS -->
        <section id="freelancers-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Freelancers BTP</h2>
                    <button class="btn btn-info" type="button" onclick="checkAuthAndGo('publish', 'freelance')">
                        <i class="fas fa-plus me-2"></i>Proposer mes services
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerSpecialtyFilter" onchange="filterFreelancers()">
                            <option value="">Toutes les spécialités</option>
                            <option value="infographie">Infographie 3D</option>
                            <option value="photographie">Photographie</option>
                            <option value="dessin">Dessin technique</option>
                            <option value="conception">Conception</option>
                            <option value="architecture">Architecture</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerCityFilter" onchange="filterFreelancers()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="freelancerSort" onchange="filterFreelancers()">
                            <option value="newest">Plus récent</option>
                            <option value="rating">Meilleures notes</option>
                            <option value="premium">Premium d'abord</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="freelancers-container">
                    <!-- Freelancers chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="freelancers-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION PROFESSIONNELS -->
        <section id="professionals-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <h2 class="mb-0">Annuaire des Professionnels BTP</h2>
                    <button class="btn btn-primary" type="button" onclick="showProfessionalModal()">
                        <i class="fas fa-user-plus me-2"></i>Devenir Professionnel
                    </button>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="filterSpecialty" onchange="filterProfessionals()">
                            <option value="">Toutes les spécialités</option>
                            <option value="maçonnerie">Maçonnerie</option>
                            <option value="electricite">Électricité</option>
                            <option value="plomberie">Plomberie</option>
                            <option value="charpente">Charpente</option>
                            <option value="revetement">Revêtement</option>
                            <option value="peinture">Peinture</option>
                            <option value="etancheite">Étanchéité</option>
                            <option value="menuiserie">Menuiserie</option>
                            <option value="lustrerie">Lustrerie</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterCity" onchange="filterProfessionals()">
                            <option value="">Toutes les villes</option>
                            <option value="casablanca">Casablanca</option>
                            <option value="rabat">Rabat</option>
                            <option value="marrakech">Marrakech</option>
                            <option value="fes">Fès</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterExperience" onchange="filterProfessionals()">
                            <option value="">Toutes expériences</option>
                            <option value="5">5+ ans</option>
                            <option value="10">10+ ans</option>
                            <option value="15">15+ ans</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4" id="professionals-container">
                    <!-- Professionnels chargés dynamiquement -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="professionals-pagination">
                    <!-- Pagination générée dynamiquement -->
                </div>
            </div>
        </section>

        <!-- SECTION FORUM -->
        <section id="forum-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Forum BTP</h2>
                    <button class="btn btn-primary" onclick="showForumCreate()">
                        <i class="fas fa-plus me-2"></i>Nouveau sujet
                    </button>
                </div>

                <!-- Catégories du forum -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Catégories</h6>
                            </div>
                            <div class="list-group list-group-flush">
                                <a class="list-group-item list-group-item-action active" onclick="filterForum('all')">
                                    Tous les sujets
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('technique')">
                                    Questions techniques
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('materiaux')">
                                    Matériaux & Fournitures
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('reglementation')">
                                    Réglementation & Normes
                                </a>
                                <a class="list-group-item list-group-item-action" onclick="filterForum('chantier')">
                                    Gestion de chantier
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <div class="card">
                            <div class="card-header">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Rechercher dans le forum..." id="forumSearch">
                                    <button class="btn btn-primary" onclick="searchForum()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="forum-topics-container">
                                    <!-- Sujets chargés dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION CRÉATION DE SUJET FORUM -->
        <section id="forum-create-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Créer un nouveau sujet</h2>
                    <button class="btn btn-outline-primary" onclick="goToSection('forum')">
                        <i class="fas fa-arrow-left me-2"></i>Retour au forum
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form id="forumTopicForm" onsubmit="createForumTopic(event)">
                            <div class="mb-3">
                                <label class="form-label">Titre du sujet *</label>
                                <input type="text" class="form-control" id="forumTopicTitle" required placeholder="Donnez un titre clair à votre sujet">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Catégorie *</label>
                                <select class="form-select" id="forumTopicCategory" required>
                                    <option value="">Choisir une catégorie</option>
                                    <option value="technique">Questions techniques</option>
                                    <option value="materiaux">Matériaux & Fournitures</option>
                                    <option value="reglementation">Réglementation & Normes</option>
                                    <option value="chantier">Gestion de chantier</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Contenu du message *</label>
                                <textarea class="form-control" id="forumTopicContent" rows="8" required placeholder="Décrivez votre question ou sujet de discussion en détail..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>Publier le sujet
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="goToSection('forum')">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION ASSISTANT IA -->
        <section id="ai-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="construction-section">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iMjAiIGZpbGw9IiNGOUY5RjkiLz4KPHBhdGggZD0iTTEwMCA1MEM5My4zNzIgNTAgODcuNDg0OSA1Mi44NDA3IDgzLjQzMTQgNTcuNDMxNEM3OS4zNzc5IDYyLjAyMjEgNzcuNSA2Ny45OTI5IDc3LjUgNzQuMzc1Qzc3LjUgODAuNzU3MSA3OS4zNzc5IDg2LjcyNzkgODMuNDMxNCA5MS4zMTg2Qzg3LjQ4NDkgOTUuOTA5MyA5My4zNzIgOTguNzUgMTAwIDk4Ljc1QzEwNi42MjggOTguNzUgMTEyLjUxNSA5NS45MDkzIDExNi41NjkgOTEuMzE4NkMxMjAuNjIyIDg2LjcyNzkgMTIyLjUgODAuNzU3MSAxMjIuNSA3NC4zNzVDMTIyLjUgNjcuOTkyOSAxMjAuNjIyIDYyLjAyMjEgMTE2LjU2OSA1Ny40MzE0QzExMi41MTUgNTIuODQwNyAxMDYuNjI4IDUwIDEwMCA1MFoiIGZpbGw9IiNGRjc3MTAiLz4KPHBhdGggZD0iTTEwMCA1MEM5My4zNzIgNTAgODcuNDg0OSA1Mi44NDA3IDgzLjQzMTQgNTcuNDMxNEM3OS4zNzc5IDYyLjAyMjEgNzcuNSA2Ny45OTI5IDc3LjUgNzQuMzc1Qzc3LjUgODAuNzU3MSA3OS4zNzc5IDg2LjcyNzkgODMuNDMxNCA5MS4zMTg2Qzg3LjQ4NDkgOTUuOTA5MyA5My4zNzIgOTguNzUgMTAwIDk4Ljc1QzEwNi42MjggOTguNzUgMTEyLjUxNSA5NS45MDkzIDExNi41NjkgOTEuMzE4NkMxMjAuNjIyIDg2LjcyNzkgMTIyLjUgODAuNzU3MSAxMjIuNSA3NC4zNzVDMTIyLjUgNjcuOTkyOSAxMjAuNjIyIDYyLjAyMjEgMTE2LjU2OSA1Ny40MzE0QzExMi41MTUgNTIuODQwNyAxMDYuNjI4IDUwIDEwMCA1MFoiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Ik03Ny41IDc0LjM3NUgxMjIuNSIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEwMCA1MFYyNSIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEwMCA5OC43NVYxMjUiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Ik03Ny41IDc0LjM3NUg1MCIgc3Ryb2tlPSIjMkQ0QTRBIiBzdHJva2Utd2lkdGg9IjQiLz4KPHBhdGggZD0iTTEyMi41IDc0LjM3NUgxNTAiIHN0cm9rZT0iIzJENEE0QSIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTY1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMkQ0QTRBIj5FTiBDT05TVFJVQ1RJT048L3RleHQ+Cjwvc3ZnPgo=" alt="En construction" class="construction-logo">
                    <h3>Assistant IA en construction</h3>
                    <p class="lead mb-4">Notre assistant IA spécialisé BTP arrive prochainement !</p>
                    <p class="text-muted mb-4">Nous développons une intelligence artificielle capable de vous conseiller sur vos projets de construction, calculs de matériaux, et estimations de coûts.</p>
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-calculator fa-2x text-primary mb-3"></i>
                                    <h5>Calculs techniques</h5>
                                    <p class="text-muted">Estimation des matériaux et coûts</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-lightbulb fa-2x text-warning mb-3"></i>
                                    <h5>Conseils experts</h5>
                                    <p class="text-muted">Recommandations personnalisées</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION PREMIUM -->
        <section id="premium-section" class="section-content">
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Avantages Premium</h2>
                
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Basique</h5>
                                <p class="card-text display-6 fw-bold text-primary">Gratuit</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ 3 annonces actives</li>
                                    <li>✅ 5 photos par annonce</li>
                                    <li>✅ Support standard</li>
                                    <li>❌ Statistiques basiques</li>
                                    <li>❌ Mise en avant</li>
                                    <li>❌ Messagerie avancée</li>
                                </ul>
                                <button class="btn btn-outline-primary" type="button" onclick="selectSubscription('Basique')">Choisir</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-primary premium-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Pro</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text display-6 fw-bold text-primary">49 MAD/mois</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ Annonces illimitées</li>
                                    <li>✅ 20 photos HD par annonce</li>
                                    <li>✅ Support prioritaire</li>
                                    <li>✅ Statistiques détaillées</li>
                                    <li>✅ Mise en avant 1 annonce</li>
                                    <li>✅ Messagerie illimitée</li>
                                </ul>
                                <button class="btn btn-primary" type="button" onclick="selectSubscription('Pro')">Choisir</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Entreprise</h5>
                                <p class="card-text display-6 fw-bold text-primary">149 MAD/mois</p>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>✅ Tous les avantages Pro</li>
                                    <li>✅ Multi-utilisateurs</li>
                                    <li>✅ API d'intégration</li>
                                    <li>✅ Formation incluse</li>
                                    <li>✅ Mise en avant illimitée</li>
                                    <li>✅ Certificat vérifié</li>
                                </ul>
                                <button class="btn btn-outline-primary" type="button" onclick="selectSubscription('Entreprise')">Choisir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avantages Premium détaillés -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Pourquoi passer Premium ?</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-chart-line text-primary me-2"></i>Statistiques avancées</h6>
                                        <p class="text-muted">Suivez les performances de vos annonces avec des données détaillées.</p>
                                        
                                        <h6><i class="fas fa-star text-warning me-2"></i>Mise en avant</h6>
                                        <p class="text-muted">Vos annonces apparaissent en tête des résultats de recherche.</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-bolt text-success me-2"></i>Support prioritaire</h6>
                                        <p class="text-muted">Réponses rapides et assistance dédiée pour vos questions.</p>
                                        
                                        <h6><i class="fas fa-shield-alt text-danger me-2"></i>Certification</h6>
                                        <p class="text-muted">Badge vérifié qui renforce la confiance de vos clients.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION FAVORIS -->
        <section id="favorites-section" class="section-content">
            <div class="container my-5 py-5">
                <h2 class="text-center mb-5">Mes Favoris</h2>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                <h4>Vos favoris apparaîtront ici</h4>
                                <p class="text-muted">Ajoutez des éléments en cliquant sur le cœur</p>
                                <button class="btn btn-primary mt-3" onclick="goToSection('marketplace')">
                                    <i class="fas fa-shopping-cart me-2"></i>Parcourir la Marketplace
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION PUBLICATION -->
        <section id="publish-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0" id="publish-title">Publier une annonce</h2>
                    <button class="btn btn-outline-success" type="button" onclick="showNewAnnounceForm()" id="new-announce-btn" style="display: none;">
                        <i class="fas fa-plus me-2"></i>Nouvelle annonce
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="list-group">
                            <a class="list-group-item list-group-item-action active" onclick="showPublishForm('marketplace')">
                                <i class="fas fa-shopping-cart me-2"></i>Marketplace
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('immobilier')">
                                <i class="fas fa-home me-2"></i>Immobilier
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('emploi')">
                                <i class="fas fa-briefcase me-2"></i>Offre d'emploi
                            </a>
                            <a class="list-group-item list-group-item-action" onclick="showPublishForm('freelance')">
                                <i class="fas fa-palette me-2"></i>Service Freelance
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <!-- Formulaire Marketplace -->
                        <div id="marketplace-form" class="publish-form">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Nouveau produit Marketplace</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishMarketplace(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre du produit *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Ciment CPJ45 50kg">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Catégorie *</label>
                                                <select class="form-select" name="category" required id="marketplaceCategorySelect">
                                                    <!-- Catégories chargées dynamiquement -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Prix (MAD) *</label>
                                                <input type="number" class="form-control" name="price" required placeholder="Ex: 85">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Unité</label>
                                                <select class="form-select" name="unit">
                                                    <option value="sac">Sac</option>
                                                    <option value="m2">m²</option>
                                                    <option value="m3">m³</option>
                                                    <option value="unite">Unité</option>
                                                    <option value="lot">Lot</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <select class="form-select" name="city" required>
                                                    <option value="">Choisir une ville</option>
                                                    <option value="casablanca">Casablanca</option>
                                                    <option value="rabat">Rabat</option>
                                                    <option value="marrakech">Marrakech</option>
                                                    <option value="fes">Fès</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description détaillée *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez votre produit..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Photos (max 5)</label>
                                            <div class="photo-upload-container" onclick="document.getElementById('marketplacePhotos').click()">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                                <h5>Cliquez pour ajouter des photos</h5>
                                                <p class="text-muted">Glissez-déposez ou cliquez pour sélectionner</p>
                                                <small class="text-muted">Maximum 5 photos, 2MB par photo</small>
                                            </div>
                                            <input type="file" id="marketplacePhotos" multiple accept="image/*" style="display: none" onchange="handlePhotoUpload(this, 'marketplace')">
                                            <div class="photo-preview" id="marketplacePhotoPreview"></div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'annonce
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Immobilier -->
                        <div id="immobilier-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-home me-2"></i>Nouvelle annonce Immobilier</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishRealEstate(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre de l'annonce *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Villa Moderne 220m² - Marrakech">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Type de bien *</label>
                                                <select class="form-select" name="type" required>
                                                    <option value="">Choisir un type</option>
                                                    <option value="villa">Villa</option>
                                                    <option value="appartement">Appartement</option>
                                                    <option value="terrain">Terrain</option>
                                                    <option value="local">Local commercial</option>
                                                    <option value="bureau">Bureau</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Prix (MAD) *</label>
                                                <input type="number" class="form-control" name="price" required placeholder="Ex: 2800000">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Surface (m²)</label>
                                                <input type="number" class="form-control" name="surface" placeholder="Ex: 220">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Nombre de pièces</label>
                                                <input type="number" class="form-control" name="rooms" placeholder="Ex: 4">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Adresse *</label>
                                            <input type="text" class="form-control" name="address" required placeholder="Ex: Gueliz, Marrakech">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description détaillée *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez votre bien..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Photos (max 5)</label>
                                            <div class="photo-upload-container" onclick="document.getElementById('realestatePhotos').click()">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                                <h5>Cliquez pour ajouter des photos</h5>
                                                <p class="text-muted">Glissez-déposez ou cliquez pour sélectionner</p>
                                                <small class="text-muted">Maximum 5 photos, 2MB par photo</small>
                                            </div>
                                            <input type="file" id="realestatePhotos" multiple accept="image/*" style="display: none" onchange="handlePhotoUpload(this, 'realestate')">
                                            <div class="photo-preview" id="realestatePhotoPreview"></div>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'annonce
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Emploi -->
                        <div id="emploi-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Nouvelle offre d'emploi</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishJob(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Poste *</label>
                                                <input type="text" class="form-control" name="poste" required placeholder="Ex: Chef de Chantier BTP">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Type de contrat *</label>
                                                <select class="form-select" name="contrat" required>
                                                    <option value="">Choisir un contrat</option>
                                                    <option value="cdi">CDI</option>
                                                    <option value="cdd">CDD</option>
                                                    <option value="freelance">Freelance</option>
                                                    <option value="stage">Stage</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Salaire *</label>
                                                <input type="text" class="form-control" name="salaire" required placeholder="Ex: 15 000 - 18 000 MAD/mois">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <input type="text" class="form-control" name="ville" required placeholder="Ex: Casablanca">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Expérience requise</label>
                                                <input type="text" class="form-control" name="experience" placeholder="Ex: 5+ ans">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description du poste *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez le poste et les missions..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-paper-plane me-2"></i>Publier l'offre
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire Freelance -->
                        <div id="freelance-form" class="publish-form" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Nouveau service Freelance</h5>
                                </div>
                                <div class="card-body">
                                    <form onsubmit="handlePublishFreelance(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Titre du service *</label>
                                                <input type="text" class="form-control" name="title" required placeholder="Ex: Infographiste 3D BTP">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Spécialité *</label>
                                                <select class="form-select" name="specialty" required>
                                                    <option value="">Choisir une spécialité</option>
                                                    <option value="infographie">Infographie 3D</option>
                                                    <option value="photographie">Photographie</option>
                                                    <option value="dessin">Dessin technique</option>
                                                    <option value="conception">Conception</option>
                                                    <option value="architecture">Architecture</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Tarif (MAD)</label>
                                                <input type="text" class="form-control" name="tarif" placeholder="Ex: 500-1000 MAD/jour">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Ville *</label>
                                                <input type="text" class="form-control" name="ville" required placeholder="Ex: Casablanca">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Expérience</label>
                                                <input type="text" class="form-control" name="experience" placeholder="Ex: 3+ ans">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description du service *</label>
                                            <textarea class="form-control" name="description" rows="4" required placeholder="Décrivez vos compétences et services..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Portfolio/Lien</label>
                                            <input type="url" class="form-control" name="portfolio" placeholder="Ex: https://votre-portfolio.com">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Votre téléphone *</label>
                                            <input type="tel" class="form-control" name="phone" required placeholder="+212 XX XX XX XX" value="${appState.currentUser?.phone || ''}">
                                        </div>
                                        <button type="submit" class="btn btn-info">
                                            <i class="fas fa-paper-plane me-2"></i>Publier le service
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION ADMINISTRATION -->
        <section id="admin-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Administration BTP Pro
                            </h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" type="button" onclick="goToSection('home')">
                                    <i class="fas fa-arrow-left me-2"></i>Retour
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                <h3 id="stats-users">0</h3>
                                <p class="text-muted mb-0">Utilisateurs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-shopping-cart fa-2x text-success mb-2"></i>
                                <h3 id="stats-marketplace">0</h3>
                                <p class="text-muted mb-0">Produits</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-home fa-2x text-warning mb-2"></i>
                                <h3 id="stats-realestate">0</h3>
                                <p class="text-muted mb-0">Biens immo</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center admin-stats-card">
                            <div class="card-body">
                                <i class="fas fa-briefcase fa-2x text-info mb-2"></i>
                                <h3 id="stats-jobs">0</h3>
                                <p class="text-muted mb-0">Offres emploi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gestion des Utilisateurs et Sauvegarde -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            Gestion des Utilisateurs et Sauvegarde
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="downloadUsersBackup()">
                                <i class="fas fa-download me-1"></i>CSV Utilisateurs
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="exportAllData()">
                                <i class="fas fa-file-export me-1"></i>Export JSON Complet
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="showImportJsonModal()">
                                <i class="fas fa-file-import me-1"></i>Import JSON
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showBackupSettings()">
                                <i class="fas fa-cog me-1"></i>Paramètres
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Actions Import/Export JSON -->
                        <div class="json-actions">
                            <h6><i class="fas fa-exchange-alt me-2"></i>Import/Export des Données Complètes</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="json-section">
                                        <h6><i class="fas fa-file-export text-primary me-2"></i>Export JSON Complet</h6>
                                        <p class="small text-muted mb-2">Exportez toutes les données du site en format JSON</p>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportUsers" checked>
                                            <label class="form-check-label" for="exportUsers">
                                                Utilisateurs avec coordonnées
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportAnnonces" checked>
                                            <label class="form-check-label" for="exportAnnonces">
                                                Toutes les annonces
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportMessages" checked>
                                            <label class="form-check-label" for="exportMessages">
                                                Messages entre utilisateurs
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportFavorites" checked>
                                            <label class="form-check-label" for="exportFavorites">
                                                Favoris des utilisateurs
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportSettings" checked>
                                            <label class="form-check-label" for="exportSettings">
                                                Paramètres admin
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="exportBackupHistory" checked>
                                            <label class="form-check-label" for="exportBackupHistory">
                                                Historique des sauvegardes
                                            </label>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100" onclick="exportAllData()">
                                            <i class="fas fa-download me-1"></i>Exporter tout en JSON
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="json-section">
                                        <h6><i class="fas fa-file-import text-warning me-2"></i>Import JSON Complet</h6>
                                        <p class="small text-muted mb-2">Importez des données depuis un fichier JSON</p>
                                        <div class="mb-3">
                                            <input type="file" class="form-control form-control-sm" id="jsonImportFile" accept=".json">
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="importOverwriteExisting" checked>
                                            <label class="form-check-label" for="importOverwriteExisting">
                                                Remplacer les données existantes
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="importCreateBackup" checked>
                                            <label class="form-check-label" for="importCreateBackup">
                                                Créer une sauvegarde avant import
                                            </label>
                                        </div>
                                        <button class="btn btn-warning btn-sm w-100" onclick="handleJsonImport()">
                                            <i class="fas fa-upload me-1"></i>Importer depuis JSON
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistiques utilisateurs -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-primary" id="stats-total-users">0</h4>
                                        <p class="text-muted mb-0">Total Utilisateurs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-success" id="stats-active-users">0</h4>
                                        <p class="text-muted mb-0">Utilisateurs Actifs</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning" id="stats-premium-users">0</h4>
                                        <p class="text-muted mb-0">Abonnés Premium</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info" id="stats-total-visits">0</h4>
                                        <p class="text-muted mb-0">Visites Total</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tableau des utilisateurs avec statistiques de visites -->
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Utilisateur</th>
                                        <th>Coordonnées</th>
                                        <th>Statut</th>
                                        <th>Inscription</th>
                                        <th>Dernière visite</th>
                                        <th>Nombre de visites</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Utilisateurs chargés dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gestion des annonces anciennes -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Gestion des Annonces Anciennes (+1 mois)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Auteur</th>
                                        <th>Date de création</th>
                                        <th>Âge</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="old-announces-table-body">
                                    <!-- Annonces anciennes chargées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gestion Adsense -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-ad me-2"></i>
                            Gestion des Publicités Adsense
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="adsense-slots-container">
                            <!-- Emplacements Adsense chargés dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Gestion Newsletter -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-newspaper me-2"></i>
                            Newsletter Automatisée
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Sélectionnez un modèle</label>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('maintenance')">
                                <h6>Maintenance du site</h6>
                                <p class="small text-muted mb-0">Informe les utilisateurs d'une maintenance planifiée</p>
                            </div>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('nouveautes')">
                                <h6>Nouvelles fonctionnalités</h6>
                                <p class="small text-muted mb-0">Présente les nouvelles fonctionnalités du site</p>
                            </div>
                            <div class="newsletter-template" onclick="selectNewsletterTemplate('promotions')">
                                <h6>Promotions spéciales</h6>
                                <p class="small text-muted mb-0">Annonce les promotions et offres spéciales</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contenu du message</label>
                            <textarea class="form-control" rows="4" id="newsletterContent" placeholder="Contenu de votre newsletter..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" onclick="sendNewsletter()">
                                    <i class="fas fa-paper-plane me-2"></i>Envoyer maintenant
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100" onclick="scheduleNewsletter()">
                                    <i class="fas fa-clock me-2"></i>Programmer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modération des annonces -->
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks me-2"></i>
                            Modération des Annonces
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Auteur</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="moderation-table-body">
                                    <!-- Annonces à modérer chargées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION MON COMPTE (NOUVELLE SECTION) -->
        <section id="my_account-section" class="section-content">
            <div class="container my-5 py-5">
                <div class="row">
                    <div class="col-md-3">
                        <!-- Sidebar Navigation -->
                        <div class="account-sidebar">
                            <nav class="nav flex-column">
                                <a class="nav-link active" href="#" onclick="showAccountSection('profile')">
                                    <i class="fas fa-user me-2"></i>Mon Profil
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('announces')">
                                    <i class="fas fa-bullhorn me-2"></i>Mes Annonces
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('favorites')">
                                    <i class="fas fa-heart me-2"></i>Mes Favoris
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('settings')">
                                    <i class="fas fa-cog me-2"></i>Paramètres
                                </a>
                                <a class="nav-link" href="#" onclick="showAccountSection('premium')">
                                    <i class="fas fa-crown me-2"></i>Abonnement Premium
                                </a>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <!-- Contenu du compte -->
                        <div class="account-content">
                            
                            <!-- Section Profil -->
                            <div id="account-profile" class="account-section active">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">
                                        <i class="fas fa-user me-2"></i>Mon Profil
                                    </h3>
                                    <button class="btn btn-outline-primary" onclick="toggleEditProfile()">
                                        <i class="fas fa-edit me-2"></i>Modifier
                                    </button>
                                </div>
                                
                                <div id="profile-view">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Nom complet</label>
                                                <p class="h5" id="profile-fullname">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Email</label>
                                                <p class="h6" id="profile-email">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Téléphone</label>
                                                <p class="h6" id="profile-phone">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Date d'inscription</label>
                                                <p class="h6" id="profile-created">-</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="user-avatar-large mb-3">
                                                <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 2rem; margin: 0 auto;">
                                                    <span id="profile-initials">MA</span>
                                                </div>
                                            </div>
                                            <div id="premium-status-badge" class="d-none">
                                                <span class="premium-badge">⭐ ABONNÉ PREMIUM</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="profile-edit" style="display: none;">
                                    <form id="profile-form" onsubmit="updateProfile(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Prénom *</label>
                                                <input type="text" class="form-control" id="edit-prenom" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Nom *</label>
                                                <input type="text" class="form-control" id="edit-nom" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="edit-email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Téléphone</label>
                                            <input type="tel" class="form-control" id="edit-phone" placeholder="+212 XX XX XX XX">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Enregistrer
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEditProfile()">
                                                Annuler
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Section Mes Annonces -->
                            <div id="account-announces" class="account-section">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">
                                        <i class="fas fa-bullhorn me-2"></i>Mes Annonces
                                    </h3>
                                    <button class="btn btn-primary" onclick="goToPublish()">
                                        <i class="fas fa-plus me-2"></i>Nouvelle Annonce
                                    </button>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-primary" id="stats-total-announces">0</h4>
                                                    <p class="text-muted mb-0">Total</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-success" id="stats-active-announces">0</h4>
                                                    <p class="text-muted mb-0">Actives</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-warning" id="stats-pending-announces">0</h4>
                                                    <p class="text-muted mb-0">En attente</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h4 class="text-danger" id="stats-rejected-announces">0</h4>
                                                    <p class="text-muted mb-0">Rejetées</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="user-announces-list">
                                    <!-- Annonces chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <!-- Autres sections du compte -->
                            <div id="account-favorites" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-heart me-2"></i>Mes Favoris
                                </h3>
                                <div class="text-center py-5">
                                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                    <h4>Vos favoris apparaîtront ici</h4>
                                    <p class="text-muted">Ajoutez des éléments en cliquant sur le cœur</p>
                                    <button class="btn btn-primary mt-3" onclick="goToSection('marketplace')">
                                        <i class="fas fa-shopping-cart me-2"></i>Parcourir la Marketplace
                                    </button>
                                </div>
                            </div>
                            
                            <div id="account-settings" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-cog me-2"></i>Paramètres du Compte
                                </h3>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Changer le mot de passe</h5>
                                        <form onsubmit="changePassword(event)">
                                            <div class="mb-3">
                                                <label class="form-label">Mot de passe actuel</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Nouveau mot de passe</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Confirmer le nouveau mot de passe</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-key me-2"></i>Changer le mot de passe
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="account-premium" class="account-section">
                                <h3 class="mb-4">
                                    <i class="fas fa-crown me-2"></i>Abonnement Premium
                                </h3>
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-crown fa-3x text-warning mb-3"></i>
                                        <h4>Passez à la version Premium</h4>
                                        <p class="text-muted mb-4">Profitez d'avantages exclusifs pour booster votre activité</p>
                                        <button class="btn btn-warning btn-lg" onclick="goToSection('premium')">
                                            <i class="fas fa-star me-2"></i>Découvrir Premium
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h5>BTP Pro <span>🇲🇦</span></h5>
                    <p>La plateforme de référence des professionnels du BTP marocain</p>
                </div>
                <div class="col-md-2 mb-4">
                    <h5>Services</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" onclick="goToSection('marketplace')">Marketplace</a></li>
                        <li class="mb-2"><a href="#" onclick="goToSection('realestate')">Immobilier</a></li>
                        <li class="mb-2"><a href="#" onclick="goToSection('jobs')">Emploi</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2024 BTP Pro Maroc. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ========== CONFIGURATION FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyBFD2STC7CkKBqzyOzEbZlIcu0afBFaWX4",
            authDomain: "btp-pro-maroc.firebaseapp.com",
            projectId: "btp-pro-maroc",
            storageBucket: "btp-pro-maroc.firebasestorage.app",
            messagingSenderId: "970736503225",
            appId: "1:970736503225:web:37becb129d6716fae28e68"
        };

        // ========== INITIALISATION FIREBASE ==========
        let firebaseApp, firestore, auth;
        let firebaseOnline = false;

        try {
            // Initialiser Firebase
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
            auth = firebase.auth();
            firebaseOnline = true;
            console.log('✅ Firebase initialisé avec succès');
        } catch (error) {
            console.warn('❌ Firebase non disponible, utilisation du localStorage:', error);
            firebaseOnline = false;
        }

        // ========== CONFIGURATION ==========
        const ANNOUNCE_STATUS = {
            PENDING: 'en_attente',
            APPROVED: 'approuve',
            REJECTED: 'rejete',
            REPORTED: 'signale',
            PAUSED: 'en_pause'
        };

        const ITEMS_PER_PAGE = 8;

        // ========== BASE DE DONNÉES AVEC FALLBACK ==========
        class BTPDatabase {
            constructor() {
                this.localStorageKey = 'btp_pro_local_db';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.localStorageKey)) {
                    this.initializeLocalData();
                }
                
                // Synchroniser avec Firebase si disponible
                if (firebaseOnline) {
                    this.syncWithFirebase();
                }
            }

            async syncWithFirebase() {
                try {
                    console.log('🔄 Synchronisation avec Firebase...');
                    
                    // Synchroniser les utilisateurs
                    const usersSnapshot = await firestore.collection('users').get();
                    if (!usersSnapshot.empty) {
                        const firebaseUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const localData = this.getLocalData();
                        localData.users = firebaseUsers;
                        this.saveLocalData(localData);
                    }
                    
                    console.log('✅ Synchronisation Firebase terminée');
                } catch (error) {
                    console.warn('⚠️ Erreur synchronisation Firebase:', error);
                }
            }

            initializeLocalData() {
                const initialData = {
                    users: [
                        {
                            id: 1,
                            prenom: "Admin",
                            nom: "BTP",
                            email: "admin@btp.ma",
                            password: this.hashPassword("admin123"), // MOT DE PASSE HACHÉ
                            phone: "+212 6 00 00 00 00",
                            role: "admin",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 15,
                            lastVisit: new Date().toISOString(),
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            prenom: "Abderrahmane",
                            nom: "Lyaakobi",
                            email: "lyaakobi@hotmail.com",
                            password: this.hashPassword("@nisawsan1"), // MOT DE PASSE HACHÉ
                            phone: "+212 6 63 06 62 25",
                            role: "user",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 8,
                            lastVisit: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 3,
                            prenom: "Younes",
                            nom: "Hachimi",
                            email: "y.hachimi.yh@gmail.com",
                            password: this.hashPassword("@younes1"), // MOT DE PASSE HACHÉ
                            role: "user",
                            isVerified: true,
                            isBlocked: false,
                            hasPremium: true,
                            visitCount: 12,
                            lastVisit: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                            createdAt: new Date().toISOString()
                        }
                    ],
                    marketplace_posts: [
                        {
                            id: 1,
                            title: "Ciment CPJ45 Lafarge",
                            description: "Sac de 50kg - Qualité Premium",
                            price: 85,
                            unit: "sac",
                            category: "ciment",
                            city: "casablanca",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: false,
                            photos: [],
                            createdAt: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000).toISOString() // 35 jours
                        },
                        {
                            id: 2,
                            title: "Carreaux Céramique 30x30",
                            description: "Marque Céragrès - Lot de 10m²",
                            price: 120,
                            unit: "m2",
                            category: "revetement",
                            city: "rabat",
                            phone: "+212 6 87 65 43 21",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 1,
                            userName: "Admin BTP",
                            isPremium: false,
                            photos: [],
                            createdAt: new Date().toISOString()
                        }
                    ],
                    realestate_posts: [
                        {
                            id: 1,
                            title: "Villa Moderne 220m² - Marrakech",
                            description: "Villa moderne avec 4 chambres, 3 salles de bain, garage",
                            price: 2800000,
                            type: "villa",
                            transaction: "vente",
                            surface: 220,
                            rooms: 4,
                            address: "Gueliz, Marrakech",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: true,
                            photos: [],
                            createdAt: new Date(Date.now() - 40 * 24 * 60 * 60 * 1000).toISOString() // 40 jours
                        }
                    ],
                    job_posts: [
                        {
                            id: 1,
                            poste: "Chef de Chantier BTP",
                            description: "Management d'équipe, suivi de chantier, respect des délais",
                            salaire: "15 000 - 18 000 MAD/mois",
                            contrat: "cdi",
                            ville: "casablanca",
                            experience: "5+ ans",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            isPremium: true,
                            createdAt: new Date().toISOString()
                        }
                    ],
                    freelancers: [
                        {
                            id: 1,
                            title: "Infographiste 3D BTP - Freelance",
                            description: "Création de rendus 3D photoréalistes pour projets BTP, visualisations architecturales et conception de plans techniques",
                            specialty: "infographie",
                            tarif: "500-1000 MAD/jour",
                            ville: "casablanca",
                            experience: "5+ ans",
                            portfolio: "https://portfolio-lyaakobi.com",
                            phone: "+212 6 63 06 62 25",
                            status: ANNOUNCE_STATUS.APPROVED,
                            userId: 2,
                            userName: "Abderrahmane Lyaakobi",
                            rating: 4.8,
                            reviewCount: 12,
                            isPremium: true,
                            createdAt: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString() // 45 jours
                        }
                    ],
                    professionals: [
                        {
                            id: 1,
                            company: "Maçonnerie Lyaakobi",
                            specialty: "maçonnerie",
                            experience: 15,
                            city: "casablanca",
                            description: "Spécialiste en gros œuvre et fondations",
                            phone: "+212 6 63 06 62 25",
                            rating: 4.8,
                            reviewCount: 124,
                            userId: 2
                        },
                        {
                            id: 2,
                            company: "Électricité BTP Pro",
                            specialty: "electricite",
                            experience: 8,
                            city: "rabat",
                            description: "Installation électrique complète, mise aux normes",
                            phone: "+212 6 87 65 43 21",
                            rating: 4.9,
                            reviewCount: 89,
                            userId: 3
                        }
                    ],
                    messages: [],
                    user_announces: [],
                    favorites: [],
                    adsense_slots: [
                        {
                            id: 'header_ad',
                            name: 'Bannière en-tête',
                            code: '',
                            position: 'header'
                        },
                        {
                            id: 'sidebar_ad',
                            name: 'Panneau latéral',
                            code: '',
                            position: 'sidebar'
                        },
                        {
                            id: 'footer_ad',
                            name: 'Pied de page',
                            code: '',
                            position: 'footer'
                        }
                    ],
                    newsletter_templates: {
                        maintenance: "Cher adhérent,\n\nNous vous informons que le site BTP Pro Maroc sera momentanément en maintenance le [date] de [heure] à [heure].\n\nNous nous excusons pour la gêne occasionnée.\n\nL'équipe BTP Pro",
                        nouveautes: "Cher adhérent,\n\nDécouvrez les nouvelles fonctionnalités de BTP Pro !\n\n- [Nouvelle fonctionnalité 1]\n- [Nouvelle fonctionnalité 2]\n- [Nouvelle fonctionnalité 3]\n\nL'équipe BTP Pro",
                        promotions: "Cher adhérent,\n\nProfitez de nos promotions exceptionnelles ce mois-ci !\n\n- [Promotion 1]\n- [Promotion 2]\n- [Promotion 3]\n\nL'équipe BTP Pro"
                    },
                    forum_categories: [
                        {
                            id: 1,
                            name: 'Questions techniques',
                            description: 'Discussions techniques sur les méthodes de construction',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 2,
                            name: 'Matériaux & Fournitures',
                            description: 'Échanges sur les matériaux de construction',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 3,
                            name: 'Réglementation & Normes',
                            description: 'Informations sur la réglementation BTP au Maroc',
                            topicCount: 0,
                            lastActivity: null
                        },
                        {
                            id: 4,
                            name: 'Gestion de chantier',
                            description: 'Conseils et retours d\'expérience sur la gestion de chantier',
                            topicCount: 0,
                            lastActivity: null
                        }
                    ],
                    forum_topics: [],
                    premium_features: [
                        {
                            id: 'stats_advanced',
                            name: 'Statistiques avancées',
                            description: 'Accès aux données détaillées de performance'
                        },
                        {
                            id: 'priority_support',
                            name: 'Support prioritaire',
                            description: 'Réponses rapides de notre équipe'
                        },
                        {
                            id: 'unlimited_announces',
                            name: 'Annonces illimitées',
                            description: 'Publiez autant d\'annonces que vous voulez'
                        }
                    ],
                    backupSettings: {
                        enabled: false,
                        frequency: 'weekly',
                        email: 'admin@btp.ma',
                        lastBackup: null,
                        includeCoordinates: true,
                        includeVisits: true
                    },
                    backupHistory: []
                };
                
                this.saveLocalData(initialData);
            }

            // Hash simple pour les mots de passe (en production, utiliser bcrypt)
            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }

            async get(collection) {
                if (firebaseOnline) {
                    try {
                        const snapshot = await firestore.collection(collection).get();
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (error) {
                        console.warn(`⚠️ Erreur Firebase pour ${collection}, fallback localStorage:`, error);
                        firebaseOnline = false;
                    }
                }
                
                // Fallback localStorage
                const localData = this.getLocalData();
                return localData[collection] || [];
            }

            async post(collection, data) {
                const item = {
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    ...data
                };

                if (firebaseOnline) {
                    try {
                        const docRef = await firestore.collection(collection).add(item);
                        item.id = docRef.id;
                    } catch (error) {
                        console.warn(`⚠️ Erreur Firebase pour ${collection}, fallback localStorage:`, error);
                        firebaseOnline = false;
                    }
                }

                // Sauvegarde locale
                const localData = this.getLocalData();
                if (!localData[collection]) localData[collection] = [];
                localData[collection].push(item);
                this.saveLocalData(localData);

                return item;
            }

            async put(collection, id, data) {
                if (firebaseOnline) {
                    try {
                        await firestore.collection(collection).doc(id.toString()).update(data);
                    } catch (error) {
                        console.warn(`⚠️ Erreur Firebase pour ${collection}, fallback localStorage:`, error);
                        firebaseOnline = false;
                    }
                }

                // Sauvegarde locale
                const localData = this.getLocalData();
                const index = localData[collection].findIndex(item => item.id === id);
                
                if (index !== -1) {
                    localData[collection][index] = { ...localData[collection][index], ...data };
                    this.saveLocalData(localData);
                    return localData[collection][index];
                }
                
                return null;
            }

            getLocalData() {
                return JSON.parse(localStorage.getItem(this.localStorageKey)) || {};
            }

            saveLocalData(data) {
                localStorage.setItem(this.localStorageKey, JSON.stringify(data));
            }

            async authenticateUser(email, password) {
                if (firebaseOnline) {
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // Récupérer les données utilisateur depuis Firestore
                        const userDoc = await firestore.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            return { id: user.uid, ...userDoc.data() };
                        }
                    } catch (error) {
                        console.warn('⚠️ Erreur Firebase auth, fallback localStorage:', error);
                        firebaseOnline = false;
                    }
                }

                // Fallback localStorage
                const users = await this.get('users');
                const hashedPassword = this.hashPassword(password);
                const user = users.find(u => u.email === email && u.password === hashedPassword);
                return user || null;
            }

            async registerUser(userData) {
                const users = await this.get('users');
                
                // Vérification email unique
                if (users.find(u => u.email === userData.email)) {
                    throw new Error('Cet email est déjà utilisé');
                }

                if (firebaseOnline) {
                    try {
                        // Créer l'utilisateur dans Firebase Auth
                        const userCredential = await auth.createUserWithEmailAndPassword(
                            userData.email, 
                            userData.password
                        );
                        
                        const user = userCredential.user;
                        
                        // Sauvegarder les données dans Firestore
                        const newUser = {
                            ...userData,
                            id: user.uid,
                            password: this.hashPassword(userData.password),
                            role: 'user',
                            isVerified: false,
                            isBlocked: false,
                            hasPremium: false,
                            visitCount: 0,
                            lastVisit: new Date().toISOString(),
                            createdAt: new Date().toISOString()
                        };
                        
                        await firestore.collection('users').doc(user.uid).set(newUser);
                        return newUser;
                        
                    } catch (error) {
                        console.warn('⚠️ Erreur Firebase register, fallback localStorage:', error);
                        firebaseOnline = false;
                    }
                }

                // Fallback localStorage
                const newUser = {
                    id: Date.now(),
                    ...userData,
                    password: this.hashPassword(userData.password),
                    role: 'user',
                    isVerified: false,
                    isBlocked: false,
                    hasPremium: false,
                    visitCount: 0,
                    lastVisit: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };

                const localData = this.getLocalData();
                localData.users.push(newUser);
                this.saveLocalData(localData);

                return newUser;
            }

            // Toutes les autres méthodes restent inchangées...
            async getAdsenseSlots() {
                const localData = this.getLocalData();
                return localData.adsense_slots || [];
            }

            async saveAdsenseSlot(slotId, code) {
                const localData = this.getLocalData();
                const slotIndex = localData.adsense_slots.findIndex(slot => slot.id === slotId);
                
                if (slotIndex !== -1) {
                    localData.adsense_slots[slotIndex].code = code;
                    this.saveLocalData(localData);
                    return localData.adsense_slots[slotIndex];
                }
                
                return null;
            }

            async getNewsletterTemplate(name) {
                const localData = this.getLocalData();
                return localData.newsletter_templates?.[name] || "";
            }

            async getUserAnnounces(userId) {
                const collections = ['marketplace_posts', 'realestate_posts', 'job_posts', 'freelancers'];
                let userAnnounces = [];
                
                for (const collection of collections) {
                    const items = await this.get(collection);
                    const userItems = items.filter(item => item.userId === userId);
                    userAnnounces = userAnnounces.concat(userItems.map(item => ({
                        ...item,
                        type: collection.replace('_posts', '')
                    })));
                }
                
                return userAnnounces;
            }

            async getOldAnnounces() {
                const collections = ['marketplace_posts', 'realestate_posts', 'job_posts', 'freelancers'];
                let allAnnounces = [];
                const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                
                for (const collection of collections) {
                    const items = await this.get(collection);
                    const oldItems = items.filter(item => 
                        new Date(item.createdAt) < oneMonthAgo && 
                        item.status === ANNOUNCE_STATUS.APPROVED
                    );
                    allAnnounces = allAnnounces.concat(oldItems.map(item => ({
                        ...item,
                        type: collection.replace('_posts', '')
                    })));
                }
                
                return allAnnounces;
            }

            async toggleFavorite(userId, itemId, itemType) {
                const favorites = await this.get('favorites');
                const existingIndex = favorites.findIndex(fav => 
                    fav.userId === userId && fav.itemId === itemId && fav.itemType === itemType
                );

                if (existingIndex !== -1) {
                    // Retirer des favoris
                    favorites.splice(existingIndex, 1);
                } else {
                    // Ajouter aux favoris
                    favorites.push({
                        id: Date.now(),
                        userId,
                        itemId,
                        itemType,
                        createdAt: new Date().toISOString()
                    });
                }

                const localData = this.getLocalData();
                localData.favorites = favorites;
                this.saveLocalData(localData);

                return existingIndex === -1; // Retourne true si ajouté, false si retiré
            }

            async getUserFavorites(userId) {
                const favorites = await this.get('favorites');
                return favorites.filter(fav => fav.userId === userId);
            }

            async isItemFavorited(userId, itemId, itemType) {
                const favorites = await this.get('favorites');
                return favorites.some(fav => 
                    fav.userId === userId && fav.itemId === itemId && fav.itemType === itemType
                );
            }

            // NOUVELLES FONCTIONS POUR LA SAUVEGARDE
            async getUserVisits(userId) {
                const users = await this.get('users');
                const user = users.find(u => u.id === userId);
                return user?.visitCount || 0;
            }

            async incrementUserVisit(userId) {
                const users = await this.get('users');
                const userIndex = users.findIndex(u => u.id === userId);
                
                if (userIndex !== -1) {
                    const currentVisits = users[userIndex].visitCount || 0;
                    users[userIndex].visitCount = currentVisits + 1;
                    users[userIndex].lastVisit = new Date().toISOString();
                    
                    const localData = this.getLocalData();
                    localData.users = users;
                    this.saveLocalData(localData);
                    
                    return users[userIndex].visitCount;
                }
                return 0;
            }

            async getAllUsersWithDetails() {
                const users = await this.get('users');
                return users.map(user => ({
                    id: user.id,
                    prenom: user.prenom,
                    nom: user.nom,
                    email: user.email,
                    phone: user.phone || 'Non renseigné',
                    role: user.role,
                    isVerified: user.isVerified,
                    hasPremium: user.hasPremium || false,
                    visitCount: user.visitCount || 0,
                    lastVisit: user.lastVisit,
                    createdAt: user.createdAt,
                    isBlocked: user.isBlocked || false
                }));
            }

            async saveBackupSettings(settings) {
                const localData = this.getLocalData();
                localData.backupSettings = {
                    ...localData.backupSettings,
                    ...settings,
                    lastBackup: new Date().toISOString()
                };
                this.saveLocalData(localData);
                return localData.backupSettings;
            }

            async getBackupSettings() {
                const localData = this.getLocalData();
                return localData.backupSettings || {
                    enabled: false,
                    frequency: 'weekly',
                    email: '',
                    lastBackup: null,
                    includeCoordinates: true,
                    includeVisits: true
                };
            }

            async createBackup() {
                const users = await this.getAllUsersWithDetails();
                const settings = await this.getBackupSettings();
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    totalUsers: users.length,
                    activeUsers: users.filter(u => !u.isBlocked).length,
                    premiumUsers: users.filter(u => u.hasPremium).length,
                    totalVisits: users.reduce((sum, user) => sum + (user.visitCount || 0), 0),
                    users: users
                };
                
                // Sauvegarder l'historique des backups
                const localData = this.getLocalData();
                if (!localData.backupHistory) {
                    localData.backupHistory = [];
                }
                
                localData.backupHistory.unshift({
                    id: Date.now(),
                    ...backupData,
                    downloaded: false
                });
                
                // Garder seulement les 10 derniers backups
                if (localData.backupHistory.length > 10) {
                    localData.backupHistory = localData.backupHistory.slice(0, 10);
                }
                
                this.saveLocalData(localData);
                
                return backupData;
            }

            async getBackupHistory() {
                const localData = this.getLocalData();
                return localData.backupHistory || [];
            }

            // NOUVELLES FONCTIONS POUR L'EXPORT/IMPORT JSON
            async exportAllData() {
                const localData = this.getLocalData();
                
                const exportData = {
                    exportInfo: {
                        version: "1.0",
                        exportDate: new Date().toISOString(),
                        source: "BTP Pro Maroc",
                        dataTypes: []
                    },
                    data: {}
                };

                // Collections à exporter
                const collectionsToExport = [
                    'users', 'marketplace_posts', 'realestate_posts', 'job_posts', 
                    'freelancers', 'professionals', 'messages', 'favorites',
                    'forum_topics', 'backupSettings', 'backupHistory'
                ];

                for (const collection of collectionsToExport) {
                    if (localData[collection]) {
                        exportData.data[collection] = localData[collection];
                        exportData.exportInfo.dataTypes.push(collection);
                    }
                }

                return exportData;
            }

            async importAllData(importData, options = {}) {
                const localData = this.getLocalData();
                const { overwrite = true, createBackup = true } = options;

                // Créer une sauvegarde avant import si demandé
                if (createBackup) {
                    const backupData = await this.exportAllData();
                    if (!localData.importBackups) {
                        localData.importBackups = [];
                    }
                    localData.importBackups.unshift({
                        timestamp: new Date().toISOString(),
                        data: backupData
                    });
                    
                    // Garder seulement les 5 derniers backups d'import
                    if (localData.importBackups.length > 5) {
                        localData.importBackups = localData.importBackups.slice(0, 5);
                    }
                }

                // Importer les données
                if (importData.data) {
                    for (const [collection, data] of Object.entries(importData.data)) {
                        if (overwrite) {
                            localData[collection] = data;
                        } else {
                            // Fusionner les données
                            if (!localData[collection]) {
                                localData[collection] = [];
                            }
                            if (Array.isArray(data)) {
                                localData[collection] = [...localData[collection], ...data];
                            } else if (typeof data === 'object') {
                                localData[collection] = { ...localData[collection], ...data };
                            }
                        }
                    }
                }

                this.saveLocalData(localData);
                return true;
            }

            async validateImportData(importData) {
                if (!importData.exportInfo || !importData.data) {
                    return { valid: false, error: "Format de fichier JSON invalide" };
                }

                const requiredFields = ['users'];
                const missingFields = requiredFields.filter(field => !importData.data[field]);

                if (missingFields.length > 0) {
                    return { 
                        valid: false, 
                        error: `Champs manquants: ${missingFields.join(', ')}` 
                    };
                }

                return { valid: true };
            }
        }

        // ========== INITIALISATION ==========
        const btpDB = new BTPDatabase();
        let loginModal, registerModal, backupSettingsModal, importJsonModal;
        let currentChat = null;

        const appState = {
            currentUser: null,
            currentSection: 'home',
            currentAccountSection: 'profile',
            isAdmin: false,
            theme: 'light',
            currentPage: {
                marketplace: 1,
                realestate: 1,
                jobs: 1,
                freelancers: 1,
                professionals: 1
            }
        };

        // ========== FONCTIONS DE VALIDATION EMAIL ==========
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateEmailField(input) {
            const email = input.value.trim();
            const errorDiv = document.getElementById('emailError');
            
            if (!email) {
                input.classList.remove('is-invalid');
                return true;
            }
            
            if (!validateEmail(email)) {
                input.classList.add('is-invalid');
                errorDiv.textContent = 'Format d\'email invalide';
                return false;
            } else {
                input.classList.remove('is-invalid');
                return true;
            }
        }

        // ========== FONCTIONS UTILITAIRES AMÉLIORÉES ==========
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function safeDBOperation(operation, errorMessage) {
            try {
                return await operation();
            } catch (error) {
                console.error(`${errorMessage}:`, error);
                showAlert(`❌ ${errorMessage}`, 'error');
                return null;
            }
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function safeInnerHTML(element, content) {
            element.textContent = content;
        }

        // ========== FONCTIONS PRINCIPALES ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            trackUserVisit(); // Ajoutez cette ligne pour suivre les visites
        });

        function initializeApp() {
            initializeModals();
            loadMarketplaceCategories();
            loadApprovedAnnounces();
            loadProfessionals();
            loadFreelancers();
            loadAdminStats();
            loadForumTopics();
            
            // Initialiser la recherche avec debounce
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(performGlobalSearch, 300));
            }
            
            // Gestionnaire d'erreurs global
            window.addEventListener('error', (event) => {
                console.error('Erreur globale:', event.error);
                showAlert('Une erreur technique est survenue', 'error');
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Promesse rejetée:', event.reason);
                showAlert('Une erreur est survenue', 'error');
            });
            
            console.log('✅ Application initialisée !');
        }

        function initializeModals() {
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            backupSettingsModal = new bootstrap.Modal(document.getElementById('backupSettingsModal'));
            importJsonModal = new bootstrap.Modal(document.getElementById('importJsonModal'));
        }

        // ========== NOUVELLES FONCTIONS EXPORT/IMPORT JSON ==========

        async function exportAllData() {
            if (!appState.isAdmin) {
                showAlert('❌ Accès réservé aux administrateurs', 'error');
                return;
            }

            showLoading(true);

            try {
                const exportData = await btpDB.exportAllData();
                
                // Créer un blob et télécharger le fichier
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `btp_pro_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('✅ Export JSON réussi !', 'success');
                
            } catch (error) {
                console.error('Erreur export:', error);
                showAlert('❌ Erreur lors de l\'export', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showImportJsonModal() {
            if (!appState.isAdmin) {
                showAlert('❌ Accès réservé aux administrateurs', 'error');
                return;
            }
            importJsonModal.show();
        }

        async function handleJsonImport() {
            const fileInput = document.getElementById('jsonImportFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('❌ Veuillez sélectionner un fichier JSON', 'error');
                return;
            }

            showLoading(true);

            try {
                const fileContent = await readFileAsText(file);
                const importData = JSON.parse(fileContent);
                
                // Valider les données
                const validation = await btpDB.validateImportData(importData);
                if (!validation.valid) {
                    showAlert(`❌ ${validation.error}`, 'error');
                    return;
                }

                // Demander confirmation
                if (!confirm('Êtes-vous sûr de vouloir importer ces données ? Cette action remplacera les données existantes.')) {
                    return;
                }

                const overwrite = document.getElementById('importOverwriteExisting').checked;
                const createBackup = document.getElementById('importCreateBackup').checked;
                
                await btpDB.importAllData(importData, { overwrite, createBackup });
                
                showAlert('✅ Import JSON réussi !', 'success');
                importJsonModal.hide();
                
                // Recharger les données
                loadAdminStats();
                loadApprovedAnnounces();
                
            } catch (error) {
                console.error('Erreur import:', error);
                showAlert('❌ Erreur lors de l\'import - Fichier JSON invalide', 'error');
            } finally {
                showLoading(false);
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        async function importJsonData() {
            // Cette fonction est appelée depuis le modal d'import détaillé
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('❌ Veuillez sélectionner un fichier JSON', 'error');
                return;
            }

            showLoading(true);

            try {
                const fileContent = await readFileAsText(file);
                const importData = JSON.parse(fileContent);
                
                // Valider les données
                const validation = await btpDB.validateImportData(importData);
                if (!validation.valid) {
                    showAlert(`❌ ${validation.error}`, 'error');
                    return;
                }

                const overwrite = document.getElementById('importOverwrite').checked;
                const createBackup = document.getElementById('importBackup').checked;
                
                await btpDB.importAllData(importData, { overwrite, createBackup });
                
                showAlert('✅ Import JSON réussi !', 'success');
                importJsonModal.hide();
                
                // Recharger les données
                loadAdminStats();
                loadApprovedAnnounces();
                
            } catch (error) {
                console.error('Erreur import:', error);
                showAlert('❌ Erreur lors de l\'import - Fichier JSON invalide', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== FONCTIONS DE NAVIGATION ==========
        function goToSection(section) {
            // Vérifier l'accès aux sections privées
            if ((section === 'my_account' || section === 'favorites') && !appState.currentUser) {
                showAlert('🔐 Connectez-vous pour accéder à cette section', 'warning');
                showLoginModal();
                return;
            }

            document.querySelectorAll('.section-content').forEach(s => {
                s.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
            });
            
            const targetSection = document.getElementById(section + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                appState.currentSection = section;
                
                // Mettre à jour la navigation active
                const activeLinks = document.querySelectorAll(`[onclick="goToSection('${section}')"]`);
                if (activeLinks.length > 0) {
                    activeLinks[0].classList.add('active');
                }

                // Charger les données si section mon compte
                if (section === 'my_account') {
                    loadUserProfile();
                    loadUserAnnounces();
                }

                // Charger les données spécifiques à chaque section
                switch(section) {
                    case 'marketplace':
                        btpDB.get('marketplace_posts').then(posts => displayMarketplaceAnnounces(posts, 1));
                        break;
                    case 'realestate':
                        btpDB.get('realestate_posts').then(posts => displayRealestateAnnounces(posts, 1));
                        break;
                    case 'jobs':
                        btpDB.get('job_posts').then(posts => displayJobsAnnounces(posts, 1));
                        break;
                    case 'freelancers':
                        btpDB.get('freelancers').then(freelancers => displayFreelancers(freelancers, 1));
                        break;
                    case 'professionals':
                        btpDB.get('professionals').then(professionals => displayProfessionals(professionals, 1));
                        break;
                    case 'admin':
                        if (appState.isAdmin) loadAdminStats();
                        break;
                    case 'favorites':
                        if (appState.currentUser) loadUserFavorites();
                        break;
                }
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== FONCTIONS ADMIN POUR ANNONCES ANCIENNES ==========
        function isAnnounceOld(createdAt) {
            const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return new Date(createdAt) < oneMonthAgo;
        }

        // ========== FONCTIONS DE SAUVEGARDE DES ADHÉRENTS ==========
        function trackUserVisit() {
            if (appState.currentUser) {
                btpDB.incrementUserVisit(appState.currentUser.id);
            }
        }

        // ========== FONCTIONS UTILITAIRES ==========
        function showAlert(message, type = 'success') {
            const alert = document.querySelector('.message-alert');
            const alertMessage = alert.querySelector('.alert-message');
            
            alertMessage.innerHTML = message;
            alert.className = `alert alert-${type === 'error' ? 'danger' : type} message-alert`;
            alert.style.display = 'block';
            
            setTimeout(() => alert.style.display = 'none', 4000);
        }

        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // ========== FONCTIONS D'AUTHENTIFICATION ==========
        function showLoginModal() {
            loginModal.show();
        }

        function showRegisterModal() {
            registerModal.show();
        }

        function switchToRegister() {
            loginModal.hide();
            registerModal.show();
        }

        function switchToLogin() {
            registerModal.hide();
            loginModal.show();
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('❌ Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const user = await btpDB.authenticateUser(email, password);
                
                if (user) {
                    if (user.isBlocked) {
                        showAlert('❌ Votre compte a été suspendu', 'error');
                        return;
                    }
                    
                    appState.currentUser = user;
                    appState.isAdmin = user.role === 'admin';
                    
                    updateUIAfterAuth();
                    loginModal.hide();
                    showAlert(`✅ Bienvenue ${user.prenom} !`, 'success');
                    
                    // Incrémenter le compteur de visites
                    btpDB.incrementUserVisit(user.id);
                    
                    // Rediriger vers la section précédente ou l'accueil
                    if (appState.currentSection === 'publish') {
                        goToSection('publish');
                    } else {
                        goToSection('home');
                    }
                } else {
                    showAlert('❌ Email ou mot de passe incorrect', 'error');
                }
            } catch (error) {
                console.error('Erreur connexion:', error);
                showAlert('❌ Erreur lors de la connexion', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const prenom = document.getElementById('registerPrenom').value;
            const nom = document.getElementById('registerNom').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            // Validation
            if (!prenom || !nom || !email || !password || !confirmPassword) {
                showAlert('❌ Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showAlert('❌ Format d\'email invalide', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('❌ Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('❌ Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const userData = {
                    prenom,
                    nom,
                    email,
                    phone,
                    password
                };
                
                const newUser = await btpDB.registerUser(userData);
                
                appState.currentUser = newUser;
                appState.isAdmin = false;
                
                updateUIAfterAuth();
                registerModal.hide();
                showAlert(`✅ Compte créé avec succès ! Bienvenue ${prenom}`, 'success');
                goToSection('home');
                
            } catch (error) {
                console.error('Erreur inscription:', error);
                showAlert(`❌ ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateUIAfterAuth() {
            // Masquer les boutons d'authentification
            document.getElementById('auth-buttons').classList.add('d-none');
            
            // Afficher le menu utilisateur
            const userMenu = document.getElementById('user-menu');
            userMenu.classList.remove('d-none');
            
            // Mettre à jour les informations utilisateur
            document.getElementById('user-name').textContent = `${appState.currentUser.prenom} ${appState.currentUser.nom}`;
            document.getElementById('user-initials').textContent = 
                `${appState.currentUser.prenom.charAt(0)}${appState.currentUser.nom.charAt(0)}`.toUpperCase();
            
            // Afficher le badge admin si nécessaire
            const adminBadge = document.getElementById('admin-badge');
            const adminMenuItem = document.getElementById('admin-menu-item');
            const adminNavItem = document.getElementById('admin-nav-item');
            
            if (appState.isAdmin) {
                adminBadge.classList.remove('d-none');
                adminMenuItem.classList.remove('d-none');
                adminNavItem.classList.remove('d-none');
            } else {
                adminBadge.classList.add('d-none');
                adminMenuItem.classList.add('d-none');
                adminNavItem.classList.add('d-none');
            }
        }

        function logout() {
            if (firebaseOnline) {
                auth.signOut();
            }
            
            appState.currentUser = null;
            appState.isAdmin = false;
            
            // Réinitialiser l'UI
            document.getElementById('auth-buttons').classList.remove('d-none');
            document.getElementById('user-menu').classList.add('d-none');
            
            showAlert('👋 À bientôt !', 'success');
            goToSection('home');
        }

        // ========== FONCTIONS DE GESTION DES ANNONCES ==========
        function loadMarketplaceCategories() {
            const categories = [
                'ciment', 'béton', 'acier', 'bois', 'revetement', 
                'sanitaire', 'electricite', 'outillage', 'peinture', 'autres'
            ];
            
            const categorySelect = document.getElementById('marketplaceCategorySelect');
            const categoryFilter = document.getElementById('marketplaceCategoryFilter');
            
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(option2);
            });
        }

        async function loadApprovedAnnounces() {
            // Cette fonction charge toutes les annonces approuvées pour les différentes sections
            // Elle est appelée au chargement de l'application
            console.log('📦 Chargement des annonces approuvées...');
        }

        // ========== FONCTIONS DE PAGINATION ==========
        function generatePagination(totalItems, currentPage, containerId, callback) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const paginationContainer = document.getElementById(containerId);
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<ul class="pagination">';
            
            // Bouton précédent
            if (currentPage > 1) {
                paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="${callback}(${currentPage - 1})">Précédent</a>
                </li>`;
            }
            
            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`;
                } else {
                    paginationHTML += `<li class="page-item">
                        <a class="page-link" href="#" onclick="${callback}(${i})">${i}</a>
                    </li>`;
                }
            }
            
            // Bouton suivant
            if (currentPage < totalPages) {
                paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="${callback}(${currentPage + 1})">Suivant</a>
                </li>`;
            }
            
            paginationHTML += '</ul>';
            paginationContainer.innerHTML = paginationHTML;
        }

        // ========== FONCTIONS DE RECHERCHE ==========
        function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value || 
                             document.getElementById('globalSearchMobile').value;
            
            if (!searchTerm.trim()) {
                showAlert('🔍 Veuillez saisir un terme de recherche', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Simuler une recherche (à implémenter selon vos besoins)
            setTimeout(() => {
                showLoading(false);
                showAlert(`🔍 Recherche pour "${searchTerm}" - Fonctionnalité en développement`, 'info');
            }, 1000);
        }

        // ========== FONCTIONS DE GESTION DES FAVORIS ==========
        async function toggleFavorite(itemId, itemType) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour ajouter aux favoris', 'warning');
                showLoginModal();
                return;
            }
            
            const isFavorited = await btpDB.toggleFavorite(
                appState.currentUser.id, 
                itemId, 
                itemType
            );
            
            if (isFavorited) {
                showAlert('❤️ Ajouté aux favoris', 'success');
            } else {
                showAlert('💔 Retiré des favoris', 'info');
            }
        }

        async function loadUserFavorites() {
            if (!appState.currentUser) return;
            
            const favorites = await btpDB.getUserFavorites(appState.currentUser.id);
            // Implémentez l'affichage des favoris selon vos besoins
        }

        // ========== FONCTIONS D'AFFICHAGE ==========
        async function displayMarketplaceAnnounces(posts, page) {
            const container = document.getElementById('marketplace-container');
            const filteredPosts = posts.filter(post => post.status === ANNOUNCE_STATUS.APPROVED);
            
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedPosts = filteredPosts.slice(startIndex, endIndex);
            
            let html = '';
            
            paginatedPosts.forEach(post => {
                html += `
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100">
                        <div class="position-relative">
                            <img src="https://via.placeholder.com/300x200?text=${encodeURIComponent(post.title)}" 
                                 class="card-img-top" alt="${post.title}" style="height: 200px; object-fit: cover;">
                            <button class="favorite-btn" onclick="toggleFavorite(${post.id}, 'marketplace')">
                                <i class="fas fa-heart"></i>
                            </button>
                            ${post.isPremium ? '<span class="premium-badge position-absolute top-0 end-0 m-2">⭐ PREMIUM</span>' : ''}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${post.title}</h5>
                            <p class="card-text text-muted">${post.description.substring(0, 100)}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 text-primary mb-0">${post.price} MAD</span>
                                <small class="text-muted">${post.unit}</small>
                            </div>
                            <div class="mt-2">
                                <i class="fas fa-map-marker-alt text-muted me-1"></i>
                                <small class="text-muted">${post.city}</small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary btn-sm w-100" onclick="contactSeller(${post.id}, 'marketplace')">
                                <i class="fas fa-envelope me-1"></i>Contacter
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            generatePagination(filteredPosts.length, page, 'marketplace-pagination', 'displayMarketplaceAnnounces');
        }

        // ========== FONCTIONS DE MESSAGERIE ==========
        function toggleMessaging() {
            const container = document.getElementById('messagingContainer');
            container.style.display = container.style.display === 'flex' ? 'none' : 'flex';
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChat) return;
            
            // Implémentez l'envoi de message selon vos besoins
            console.log('Envoi message:', message, 'à:', currentChat);
            messageInput.value = '';
        }

        // ========== FONCTIONS ADMIN ==========
        async function loadAdminStats() {
            if (!appState.isAdmin) return;
            
            const users = await btpDB.get('users');
            const marketplace = await btpDB.get('marketplace_posts');
            const realestate = await btpDB.get('realestate_posts');
            const jobs = await btpDB.get('job_posts');
            
            document.getElementById('stats-users').textContent = users.length;
            document.getElementById('stats-marketplace').textContent = marketplace.length;
            document.getElementById('stats-realestate').textContent = realestate.length;
            document.getElementById('stats-jobs').textContent = jobs.length;
        }

        // ========== FONCTIONS DE GESTION DU THÈME ==========
        function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            appState.theme = theme;
            localStorage.setItem('btp_pro_theme', theme);
        }

        // ========== FONCTIONS DE NAVIGATION PUBLIER ==========
        function goToPublish() {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour publier une annonce', 'warning');
                showLoginModal();
                return;
            }
            goToSection('publish');
        }

        function checkAuthAndGo(section, type) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour accéder à cette fonctionnalité', 'warning');
                showLoginModal();
                return;
            }
            goToSection(section);
        }

        // ========== FONCTIONS DE GESTION DU PROFIL ==========
        async function loadUserProfile() {
            if (!appState.currentUser) return;
            
            const user = appState.currentUser;
            
            document.getElementById('profile-fullname').textContent = `${user.prenom} ${user.nom}`;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-phone').textContent = user.phone || 'Non renseigné';
            document.getElementById('profile-created').textContent = new Date(user.createdAt).toLocaleDateString('fr-FR');
            document.getElementById('profile-initials').textContent = 
                `${user.prenom.charAt(0)}${user.nom.charAt(0)}`.toUpperCase();
            
            if (user.hasPremium) {
                document.getElementById('premium-status-badge').classList.remove('d-none');
            }
        }

        function toggleEditProfile() {
            const view = document.getElementById('profile-view');
            const edit = document.getElementById('profile-edit');
            
            if (view.style.display !== 'none') {
                // Passer en mode édition
                view.style.display = 'none';
                edit.style.display = 'block';
                
                // Remplir le formulaire
                document.getElementById('edit-prenom').value = appState.currentUser.prenom;
                document.getElementById('edit-nom').value = appState.currentUser.nom;
                document.getElementById('edit-email').value = appState.currentUser.email;
                document.getElementById('edit-phone').value = appState.currentUser.phone || '';
            } else {
                // Retourner en mode visualisation
                view.style.display = 'block';
                edit.style.display = 'none';
            }
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            const prenom = document.getElementById('edit-prenom').value;
            const nom = document.getElementById('edit-nom').value;
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
            
            try {
                // Mettre à jour l'utilisateur dans la base
                await btpDB.put('users', appState.currentUser.id, {
                    prenom,
                    nom,
                    email,
                    phone
                });
                
                // Mettre à jour l'état local
                appState.currentUser.prenom = prenom;
                appState.currentUser.nom = nom;
                appState.currentUser.email = email;
                appState.currentUser.phone = phone;
                
                // Mettre à jour l'UI
                updateUIAfterAuth();
                toggleEditProfile();
                loadUserProfile();
                
                showAlert('✅ Profil mis à jour avec succès', 'success');
            } catch (error) {
                console.error('Erreur mise à jour profil:', error);
                showAlert('❌ Erreur lors de la mise à jour du profil', 'error');
            }
        }

        async function loadUserAnnounces() {
            if (!appState.currentUser) return;
            
            const announces = await btpDB.getUserAnnounces(appState.currentUser.id);
            const container = document.getElementById('user-announces-list');
            
            // Mettre à jour les statistiques
            document.getElementById('stats-total-announces').textContent = announces.length;
            document.getElementById('stats-active-announces').textContent = 
                announces.filter(a => a.status === ANNOUNCE_STATUS.APPROVED).length;
            document.getElementById('stats-pending-announces').textContent = 
                announces.filter(a => a.status === ANNOUNCE_STATUS.PENDING).length;
            document.getElementById('stats-rejected-announces').textContent = 
                announces.filter(a => a.status === ANNOUNCE_STATUS.REJECTED).length;
            
            // Afficher les annonces
            let html = '';
            
            announces.forEach(announce => {
                const statusBadge = getStatusBadge(announce.status);
                
                html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${announce.title || announce.poste}</h5>
                                <p class="card-text text-muted">${announce.description.substring(0, 150)}...</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-secondary">${announce.type}</span>
                                    ${statusBadge}
                                    ${announce.isPremium ? '<span class="premium-badge">PREMIUM</span>' : ''}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${new Date(announce.createdAt).toLocaleDateString('fr-FR')}</small>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm me-1" onclick="editAnnounce('${announce.type}', ${announce.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAnnounce('${announce.type}', ${announce.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html || '<p class="text-muted text-center">Aucune annonce publiée</p>';
        }

        function getStatusBadge(status) {
            const statusMap = {
                [ANNOUNCE_STATUS.PENDING]: { class: 'status-pending', text: 'En attente' },
                [ANNOUNCE_STATUS.APPROVED]: { class: 'status-approved', text: 'Approuvé' },
                [ANNOUNCE_STATUS.REJECTED]: { class: 'status-rejected', text: 'Rejeté' },
                [ANNOUNCE_STATUS.PAUSED]: { class: 'status-paused', text: 'En pause' }
            };
            
            const statusInfo = statusMap[status] || { class: 'status-pending', text: 'Inconnu' };
            return `<span class="announce-status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function showAccountSection(section) {
            // Masquer toutes les sections
            document.querySelectorAll('.account-section').forEach(s => {
                s.classList.remove('active');
            });
            
            // Désactiver tous les liens
            document.querySelectorAll('.account-sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Activer la section sélectionnée
            document.getElementById('account-' + section).classList.add('active');
            
            // Activer le lien correspondant
            document.querySelector(`[onclick="showAccountSection('${section}')"]`).classList.add('active');
            
            appState.currentAccountSection = section;
        }

        // ========== FONCTIONS DE GESTION DES PROFESSIONNELS ==========
        async function loadProfessionals() {
            const professionals = await btpDB.get('professionals');
            displayProfessionals(professionals, 1);
        }

        function displayProfessionals(professionals, page) {
            const container = document.getElementById('professionals-container');
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedProfessionals = professionals.slice(startIndex, endIndex);
            
            let html = '';
            
            paginatedProfessionals.forEach(pro => {
                html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${pro.company}</h5>
                            <p class="card-text text-muted">${pro.description}</p>
                            <div class="mb-2">
                                <span class="badge bg-primary">${pro.specialty}</span>
                                <span class="badge bg-secondary ms-1">${pro.experience}+ ans</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-star text-warning"></i>
                                    <span class="ms-1">${pro.rating}</span>
                                    <small class="text-muted">(${pro.reviewCount} avis)</small>
                                </div>
                                <div>
                                    <i class="fas fa-map-marker-alt text-muted"></i>
                                    <small class="text-muted">${pro.city}</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary btn-sm w-100" onclick="contactProfessional(${pro.id})">
                                <i class="fas fa-phone me-1"></i>Contacter
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            generatePagination(professionals.length, page, 'professionals-pagination', 'displayProfessionals');
        }

        // ========== FONCTIONS DE GESTION DES FREELANCERS ==========
        async function loadFreelancers() {
            const freelancers = await btpDB.get('freelancers');
            displayFreelancers(freelancers, 1);
        }

        function displayFreelancers(freelancers, page) {
            const container = document.getElementById('freelancers-container');
            const approvedFreelancers = freelancers.filter(f => f.status === ANNOUNCE_STATUS.APPROVED);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedFreelancers = approvedFreelancers.slice(startIndex, endIndex);
            
            let html = '';
            
            paginatedFreelancers.forEach(freelancer => {
                html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${freelancer.title}</h5>
                            <p class="card-text text-muted">${freelancer.description.substring(0, 100)}...</p>
                            <div class="mb-2">
                                <span class="badge bg-info">${freelancer.specialty}</span>
                                <span class="badge bg-secondary ms-1">${freelancer.experience}</span>
                                ${freelancer.isPremium ? '<span class="premium-badge ms-1">PREMIUM</span>' : ''}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-star text-warning"></i>
                                    <span class="ms-1">${freelancer.rating}</span>
                                    <small class="text-muted">(${freelancer.reviewCount} avis)</small>
                                </div>
                                <div>
                                    <strong class="text-primary">${freelancer.tarif}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-info btn-sm w-100" onclick="contactFreelancer(${freelancer.id})">
                                <i class="fas fa-envelope me-1"></i>Contacter
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            generatePagination(approvedFreelancers.length, page, 'freelancers-pagination', 'displayFreelancers');
        }

        // ========== FONCTIONS DE GESTION DU FORUM ==========
        async function loadForumTopics() {
            const topics = await btpDB.get('forum_topics');
            displayForumTopics(topics);
        }

        function displayForumTopics(topics) {
            const container = document.getElementById('forum-topics-container');
            
            if (topics.length === 0) {
                container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h4>Aucun sujet pour le moment</h4>
                    <p class="text-muted">Soyez le premier à lancer une discussion !</p>
                </div>`;
                return;
            }
            
            let html = '';
            
            topics.forEach(topic => {
                html += `
                <div class="forum-topic">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="mb-1">
                                <a href="#" onclick="viewForumTopic(${topic.id})" class="text-decoration-none">${topic.title}</a>
                            </h5>
                            <p class="text-muted mb-1">${topic.content.substring(0, 150)}...</p>
                            <div class="d-flex align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>${topic.authorName}
                                </small>
                                <small class="text-muted ms-3">
                                    <i class="fas fa-clock me-1"></i>${new Date(topic.createdAt).toLocaleDateString('fr-FR')}
                                </small>
                                <span class="badge bg-primary ms-2">${topic.category}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-3">
                                    <i class="fas fa-comment me-1"></i>${topic.replyCount || 0}
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-eye me-1"></i>${topic.views || 0}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function showForumCreate() {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour créer un sujet', 'warning');
                showLoginModal();
                return;
            }
            goToSection('forum-create');
        }

        async function createForumTopic(event) {
            event.preventDefault();
            
            const title = document.getElementById('forumTopicTitle').value;
            const category = document.getElementById('forumTopicCategory').value;
            const content = document.getElementById('forumTopicContent').value;
            
            try {
                const topic = await btpDB.post('forum_topics', {
                    title,
                    category,
                    content,
                    authorId: appState.currentUser.id,
                    authorName: `${appState.currentUser.prenom} ${appState.currentUser.nom}`,
                    replyCount: 0,
                    views: 0,
                    lastActivity: new Date().toISOString(),
                    status: 'active'
                });
                
                showAlert('✅ Sujet créé avec succès', 'success');
                goToSection('forum');
                loadForumTopics();
            } catch (error) {
                console.error('Erreur création sujet:', error);
                showAlert('❌ Erreur lors de la création du sujet', 'error');
            }
        }

        // ========== FONCTIONS DE CONTACT ==========
        function contactSeller(itemId, itemType) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour contacter le vendeur', 'warning');
                showLoginModal();
                return;
            }
            
            showAlert('📞 Fonctionnalité de contact en développement', 'info');
        }

        function contactProfessional(professionalId) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour contacter le professionnel', 'warning');
                showLoginModal();
                return;
            }
            
            showAlert('📞 Fonctionnalité de contact en développement', 'info');
        }

        function contactFreelancer(freelancerId) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour contacter le freelancer', 'warning');
                showLoginModal();
                return;
            }
            
            showAlert('📞 Fonctionnalité de contact en développement', 'info');
        }

        // ========== FONCTIONS DE GESTION DES ANNONCES ==========
        function showPublishForm(type) {
            // Masquer tous les formulaires
            document.querySelectorAll('.publish-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Afficher le formulaire sélectionné
            document.getElementById(`${type}-form`).style.display = 'block';
            
            // Mettre à jour le titre
            const titles = {
                'marketplace': 'Nouveau produit Marketplace',
                'immobilier': 'Nouvelle annonce Immobilier',
                'emploi': 'Nouvelle offre d\'emploi',
                'freelance': 'Nouveau service Freelance'
            };
            
            document.getElementById('publish-title').textContent = titles[type] || 'Publier une annonce';
        }

        async function handlePublishMarketplace(event) {
            event.preventDefault();
            await handlePublish(event, 'marketplace_posts');
        }

        async function handlePublishRealEstate(event) {
            event.preventDefault();
            await handlePublish(event, 'realestate_posts');
        }

        async function handlePublishJob(event) {
            event.preventDefault();
            await handlePublish(event, 'job_posts');
        }

        async function handlePublishFreelance(event) {
            event.preventDefault();
            await handlePublish(event, 'freelancers');
        }

        async function handlePublish(event, collection) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour publier', 'warning');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Ajouter les informations utilisateur
            data.userId = appState.currentUser.id;
            data.userName = `${appState.currentUser.prenom} ${appState.currentUser.nom}`;
            data.status = ANNOUNCE_STATUS.PENDING;
            data.isPremium = appState.currentUser.hasPremium || false;
            
            showLoading(true);
            
            try {
                await btpDB.post(collection, data);
                showAlert('✅ Annonce publiée avec succès ! Elle sera visible après modération.', 'success');
                form.reset();
                
                // Revenir à la section appropriée
                switch(collection) {
                    case 'marketplace_posts':
                        goToSection('marketplace');
                        break;
                    case 'realestate_posts':
                        goToSection('realestate');
                        break;
                    case 'job_posts':
                        goToSection('jobs');
                        break;
                    case 'freelancers':
                        goToSection('freelancers');
                        break;
                }
            } catch (error) {
                console.error('Erreur publication:', error);
                showAlert('❌ Erreur lors de la publication', 'error');
            } finally {
                showLoading(false);
            }
        }

        function handlePhotoUpload(input, type) {
            const files = input.files;
            const previewId = `${type}PhotoPreview`;
            const preview = document.getElementById(previewId);
            
            preview.innerHTML = '';
            
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'photo-preview-item';
                    
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="photo-remove" onclick="removePhoto(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    preview.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(button) {
            button.parentElement.remove();
        }

        // ========== FONCTIONS DE GESTION DES ABONNEMENTS ==========
        function selectSubscription(plan) {
            if (!appState.currentUser) {
                showAlert('🔐 Connectez-vous pour souscrire à un abonnement', 'warning');
                showLoginModal();
                return;
            }
            
            showAlert(`🎉 Abonnement ${plan} sélectionné - Fonctionnalité en développement`, 'info');
        }

        // ========== FONCTIONS DE FILTRAGE ==========
        function filterMarketplace() {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage marketplace');
        }

        function filterRealEstate() {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage immobilier');
        }

        function filterJobs() {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage emplois');
        }

        function filterFreelancers() {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage freelancers');
        }

        function filterProfessionals() {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage professionnels');
        }

        function filterForum(category) {
            // Implémentez le filtrage selon vos besoins
            console.log('Filtrage forum:', category);
        }

        function searchForum() {
            const searchTerm = document.getElementById('forumSearch').value;
            if (searchTerm) {
                showAlert(`🔍 Recherche forum: "${searchTerm}" - Fonctionnalité en développement`, 'info');
            }
        }

        // ========== FONCTIONS DE GESTION DES SAUVEGARDES ==========
        function showBackupSettings() {
            if (!appState.isAdmin) {
                showAlert('❌ Accès réservé aux administrateurs', 'error');
                return;
            }
            backupSettingsModal.show();
        }

        async function saveBackupSettings() {
            // Implémentez la sauvegarde des paramètres selon vos besoins
            showAlert('✅ Paramètres de sauvegarde enregistrés', 'success');
            backupSettingsModal.hide();
        }

        async function createManualBackup() {
            if (!appState.isAdmin) {
                showAlert('❌ Accès réservé aux administrateurs', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const backupData = await btpDB.createBackup();
                showAlert('✅ Sauvegarde créée avec succès', 'success');
                console.log('Backup créé:', backupData);
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showAlert('❌ Erreur lors de la sauvegarde', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== INITIALISATION DU THÈME ==========
        const savedTheme = localStorage.getItem('btp_pro_theme') || 'light';
        changeTheme(savedTheme);

        console.log('🚀 BTP Pro Maroc - Application prête !');
        console.log(`🌐 Firebase: ${firebaseOnline ? '✅ Connecté' : '❌ Hors ligne - Utilisation localStorage'}`);
    </script>
</body>
</html>
